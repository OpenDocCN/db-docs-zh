> 原文：[`dev.mysql.com/doc/refman/8.0/en/host-cache.html`](https://dev.mysql.com/doc/refman/8.0/en/host-cache.html)

#### 7.1.12.3 DNS 查找和主机缓存

MySQL 服务器维护一个内存中的主机缓存，其中包含有关客户端的信息：IP 地址、主机名和错误信息。性能模式`host_cache`表公开主机缓存的内容，以便可以使用`SELECT`语句进行检查。这可能有助于诊断连接问题的原因。参见 Section 29.12.21.3，“主机缓存表”。

以下各节讨论了主机缓存的工作原理，以及如何配置和监视缓存等其他主题。

+   主机缓存操作

+   配置主机缓存

+   监视主机缓存

+   刷新主机缓存

+   处理被阻止的主机

##### 主机缓存操作

服务器仅针对非本地主机的 TCP 连接使用主机缓存。它不会对使用回环接口地址（例如，`127.0.0.1`或`::1`）建立的 TCP 连接，或者使用 Unix 套接字文件、命名管道或共享内存建立的连接使用缓存。

服务器使用主机缓存有几个目的：

+   通过缓存 IP 到主机名查找的结果，服务器避免为每个客户端连接执行域名系统（DNS）查找。相反，对于给定的主机，它只需要在来自该主机的第一个连接时执行查找。

+   缓存包含在客户端连接过程中发生的错误信息。一些错误被视为“阻塞”。如果来自给定主机的这些错误过多连续发生而没有成功连接，服务器将阻止该主机的进一步连接。`max_connect_errors`系统变量确定在发生阻塞之前允许的连续错误数量。

对于每个适用的新客户端连接，服务器使用客户端 IP 地址来检查客户端主机名是否在主机缓存中。如果是，服务器会根据主机是否被阻止来拒绝或继续处理连接请求。如果主机不在缓存中，服务器会尝试解析主机名。首先，它将 IP 地址解析为主机名，然后将该主机名解析回 IP 地址。然后将结果与原始 IP 地址进行比较，以确保它们相同。服务器将此操作的结果信息存储在主机缓存中。如果缓存已满，最近最少使用的条目将被丢弃。

服务器使用`getaddrinfo()`系统调用执行主机名解析。

服务器处理主机缓存条目如下：

1.  当来自特定 IP 地址的第一个 TCP 客户端连接到达服务器时，将创建一个新的缓存条目来记录客户端 IP、主机名和客户端查找验证标志。最初，主机名设置为`NULL`，标志为 false。此条目还用于来自相同原始 IP 的后续客户端 TCP 连接。

1.  如果客户端 IP 条目的验证标志为 false，则服务器尝试进行 IP 到主机名到 IP 的 DNS 解析。如果成功，主机名将更新为解析后的主机名，并将验证标志设置为 true。如果解析失败，则采取的操作取决于错误是永久的还是暂时的。对于永久性失败，主机名保持为`NULL`，验证标志设置为 true。对于暂时性失败，主机名和验证标志保持不变。（在这种情况下，下次有客户端从此 IP 连接时将再次进行 DNS 解析尝试。）

1.  如果在处理来自特定 IP 地址的传入客户端连接时发生错误，服务器会更新该 IP 对应条目中的错误计数器。有关记录的错误描述，请参见 Section 29.12.21.3，“主机缓存表”。

要解除被阻止的主机，清空主机缓存；参见处理被阻止的主机。

即使在不清空主机缓存的情况下，也有可能使一个被阻止的主机变为未阻止状态，只要来自其他主机的活动发生：

+   如果连接到服务器的客户端 IP 不在缓存中且缓存已满，服务器会丢弃最近最少使用的缓存条目，为新条目腾出空间。

+   如果被丢弃的条目是针对一个被阻止的主机，那么该主机将变为未阻止状态。

一些连接错误与 TCP 连接无关，出现在连接过程的非常早期（甚至在知道 IP 地址之前），或者不特定于任何特定的 IP 地址（例如内存不足条件）。有关这些错误的信息，请查看`Connection_errors_*`xxx`*`状态变量（请参阅第 7.1.10 节，“服务器状态变量”）。

##### 配置主机缓存

主机缓存默认启用。`host_cache_size`系统变量控制其大小，以及暴露缓存内容的性能模式`host_cache`表的大小。缓存大小可以在服务器启动时设置并在运行时更改。例如，要在启动时将大小设置为 100，请将以下行放入服务器的`my.cnf`文件中：

```sql
[mysqld]
host_cache_size=200
```

在运行时将大小更改为 300，请执行以下操作：

```sql
SET GLOBAL host_cache_size=300;
```

将`host_cache_size`设置为 0，无论是在服务器启动时还是在运行时，都会禁用主机缓存。禁用缓存后，服务器在每次客户端连接时执行 DNS 查找。

在运行时更改缓存大小会导致隐式主机缓存刷新操作，清除主机缓存，截断`host_cache`表，并解除任何被阻止的主机；参见刷新主机缓存。

使用`--skip-host-cache`选项类似于将`host_cache_size`系统变量设置为 0，但`host_cache_size`更灵活，因为它还可以用于在运行时调整、启用和禁用主机缓存，而不仅仅是在服务器启动时。使用`--skip-host-cache`启动服务器不会阻止对`host_cache_size`值的运行时更改，但这些更改没有效果，即使将`host_cache_size`设置为大于 0，缓存也不会重新启用。

要禁用 DNS 主机名查找，请启用`skip_name_resolve`系统变量启动服务器。在这种情况下，服务器仅使用 IP 地址而不是主机名来将连接主机与 MySQL 授权表中的行匹配。只能使用在这些表中使用 IP 地址指定的帐户。 （如果没有指定客户端 IP 地址的帐户，则客户端可能无法连接。）

如果您的 DNS 非常慢且有许多主机，您可以通过启用`skip_name_resolve`来禁用 DNS 查找，或者通过增加`host_cache_size`的值来使主机缓存更大来提高性能。

要完全禁止 TCP/IP 连接，请启动时启用`skip_networking`系统变量。

要调整在主机阻止发生之前允许的连续连接错误数，请设置`max_connect_errors`系统变量。例如，要在启动时设置该值，请将以下行放入服务器的`my.cnf`文件中：

```sql
[mysqld]
max_connect_errors=10000
```

要在运行时更改该值，请执行以下操作：

```sql
SET GLOBAL max_connect_errors=10000;
```

##### 监控主机缓存

Performance Schema `host_cache` 表公开了主机缓存的内容。可以使用`SELECT`语句检查此表，这可能有助于诊断连接问题的原因。有关此表的信息，请参阅 Section 29.12.21.3, “The host_cache Table”。

##### 刷新主机缓存

在以下情况下刷新主机缓存可能是明智或可取的：

+   您的一些客户端主机更改了 IP 地址。

+   错误消息`Host '*`host_name`*' is blocked`出现在来自合法主机的连接中。（参见处理被阻止的主机。）

刷新主机缓存会产生以下效果：

+   它清除内存中的主机缓存。

+   它会从 Performance Schema `host_cache` 表中删除所有行，该表公开了缓存内容。

+   它解除任何被阻止的主机。这使得这些主机可以进一步尝试连接。

要刷新主机缓存，请使用以下任一方法：

+   更改`host_cache_size`系统变量的值。这需要`SYSTEM_VARIABLES_ADMIN`权限（或已弃用的`SUPER`权限）。

+   执行一个截断 Performance Schema `host_cache` 表的`TRUNCATE TABLE`语句。这需要表的`DROP`权限。

+   执行一个`FLUSH HOSTS`语句。这需要`RELOAD`权限。

    注意

    `FLUSH HOSTS`在 MySQL 8.0.23 中已弃用，并计划在将来的版本中删除。

+   执行**mysqladmin flush-hosts**命令。这需要对性能模式`host_cache`表或`RELOAD`权限的`DROP`权限。

##### 处理被阻止的主机

服务器使用主机缓存来跟踪客户端连接过程中发生的错误。如果出现以下错误，意味着**mysqld**从给定主机接收了许多连接请求，但在中途被中断：

```sql
Host '*host_name*' is blocked because of many connection errors.
Unblock with 'mysqladmin flush-hosts'
```

`max_connect_errors`系统变量的值确定服务器在阻止主机之前允许多少连续中断的连接请求。在连续`max_connect_errors`个失败请求而没有成功连接之后，服务器会认为出现了问题（例如，有人试图入侵），并阻止主机进一步的连接请求。

要解除被阻止的主机，刷新主机缓存；参见刷新主机缓存。

或者，为了避免出现错误消息，按照配置主机缓存中描述的方式设置`max_connect_errors`。`max_connect_errors`的默认值为 100。将`max_connect_errors`增加到一个较大的值可以减少主机达到阈值并被阻止的可能性。然而，如果出现`主机'*`host_name`*'被阻止`的错误消息，请首先验证被阻止主机的 TCP/IP 连接是否正常。如果存在网络问题，则增加`max_connect_errors`的值是没有好处的。
