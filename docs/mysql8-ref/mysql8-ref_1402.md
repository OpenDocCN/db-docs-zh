> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-binlog-encryption-key-rotation.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-binlog-encryption-key-rotation.html)

#### 19.3.2.3 二进制日志主密钥旋转

当启用二进制日志加密时，您可以在服务器运行时随时通过执行`ALTER INSTANCE ROTATE BINLOG MASTER KEY`来旋转二进制日志主密钥。当使用此语句手动旋转二进制日志主密钥时，新文件和随后的文件的密码将使用新的二进制日志主密钥加密，同时现有加密的二进制日志文件和中继日志文件的文件密码将使用新的二进制日志主密钥重新加密，因此加密完全更新。您可以定期旋转二进制日志主密钥以符合组织的安全策略，如果怀疑当前或任何以前的二进制日志主密钥可能已被泄露，也可以这样做。

当您手动旋转二进制日志主密钥时，MySQL 服务器按顺序执行以下操作：

1.  生成一个具有下一个可用序列号的新二进制日志加密密钥，存储在密钥环中，并用作新的二进制日志主密钥。

1.  所有通道上的二进制日志和中继日志文件都会被旋转。

1.  新的二进制日志主密钥用于加密新的二进制日志和中继日志文件的文件密码，以及直到再次更改密钥为止的随后文件。

1.  服务器上现有加密的二进制日志文件和中继日志文件的文件密码将依次使用新的二进制日志主密钥重新加密，从最近的文件开始。任何未加密的文件将被跳过。

1.  在重新加密过程后不再用于任何文件的二进制日志加密密钥将从密钥环中删除。

需要`BINLOG_ENCRYPTION_ADMIN`权限才能执行`ALTER INSTANCE ROTATE BINLOG MASTER KEY`，如果`binlog_encryption`系统变量设置为`OFF`，则无法使用该语句。

作为二进制日志主密钥轮换过程的最后一步，清理掉不再适用于任何保留的二进制日志文件或中继日志文件的所有二进制日志加密密钥。如果无法为保留的二进制日志文件或中继日志文件初始化重新加密，那么相关的二进制日志加密密钥不会被删除，以防将来可以恢复文件。例如，如果二进制日志索引文件中列出的文件当前无法读取，或者通道无法初始化，可能会出现这种情况。如果服务器 UUID 更改，例如因为使用 MySQL Enterprise Backup 创建的备份用于设置新的副本，那么在新服务器上发出`ALTER INSTANCE ROTATE BINLOG MASTER KEY`不会删除包括原始服务器 UUID 的任何早期二进制日志加密密钥。

如果二进制日志主密钥轮换过程的前四个步骤中有任何一个无法正确完成，系统会发出错误消息，解释情况以及对二进制日志文件和中继日志文件的加密状态的影响。先前加密的文件始终保持在加密状态，但它们的文件密码可能仍然使用旧的二进制日志主密钥进行加密。如果您看到这些错误，请首先通过再次发出`ALTER INSTANCE ROTATE BINLOG MASTER KEY`来重试该过程。然后调查各个文件的状态，看看是什么阻碍了该过程，特别是如果您怀疑当前或任何以前的二进制日志主密钥可能已被泄露。

如果二进制日志主密钥轮换过程的最后一步无法正确完成，系统会发出警告消息，解释情况。警告消息会指出该过程无法清理用于轮换二进制日志主密钥的辅助密钥，或无法清理未使用的二进制日志加密密钥。您可以选择忽略该消息，因为这些密钥是辅助密钥或不再使用，或者您可以再次发出`ALTER INSTANCE ROTATE BINLOG MASTER KEY`来重试该过程。

如果服务器在二进制日志主密钥轮换过程中停止并重新启动，而二进制日志加密仍然设置为`ON`，则重新启动后的新二进制日志文件和中继日志文件将使用新的二进制日志主密钥进行加密。但是，现有文件的重新加密不会继续进行，因此在服务器停止之前未重新加密的文件将继续使用先前的二进制日志主密钥进行加密。要完成重新加密并清理未使用的二进制日志加密密钥，请在重新启动后再次发出`ALTER INSTANCE ROTATE BINLOG MASTER KEY`。

`ALTER INSTANCE ROTATE BINLOG MASTER KEY` 操作不会被写入二进制日志，也不会在副本上执行。因此，在包含多个 MySQL 版本的复制环境中可以执行二进制日志主密钥轮换。要在所有适用的源和副本服务器上定期轮换二进制日志主密钥，您可以在每个服务器上启用 MySQL 事件调度程序，并使用 `CREATE EVENT` 语句发出 `ALTER INSTANCE ROTATE BINLOG MASTER KEY` 语句。如果因为怀疑当前或任何以前的二进制日志主密钥可能已被泄露而轮换二进制日志主密钥，则在每个适用的源和副本服务器上发出该语句。在各个服务器上发出该语句可确保您可以验证即时的合规性，即使在滞后的副本、属于多个复制拓扑或当前未在复制拓扑中活动但具有二进制日志和中继日志文件的情况下也是如此。

`binlog_rotate_encryption_master_key_at_startup` 系统变量控制服务器在重新启动时是否自动轮换二进制日志主密钥。如果此系统变量设置为 `ON`，则在服务器重新启动时会生成一个新的二进制日志加密密钥，并将其用作新的二进制日志主密钥。如果设置为 `OFF`，即默认值，则在重新启动后再次使用现有的二进制日志主密钥。当在启动时轮换二进制日志主密钥时，新的二进制日志和中继日志文件的文件密码将使用新密钥加密。现有加密的二进制日志文件和中继日志文件的文件密码不会重新加密，因此它们仍然使用旧密钥加密，该旧密钥仍然可在密钥环中使用。
