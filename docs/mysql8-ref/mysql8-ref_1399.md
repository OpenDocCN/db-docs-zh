# 19.3.2 加密二进制日志文件和中继日志文件

> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-binlog-encryption.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-binlog-encryption.html)

19.3.2.1 二进制日志加密范围

19.3.2.2 二进制日志加密密钥

19.3.2.3 二进制日志主密钥轮换

从 MySQL 8.0.14 开始，二进制日志文件和中继日志文件可以进行加密，有助于保护这些文件以及其中可能包含的敏感数据，防止外部攻击者滥用，也防止操作系统用户未经授权查看。文件使用的加密算法是 AES（高级加密标准）密码算法，内置于 MySQL Server 中，无法配置。

通过将 MySQL 服务器上的 `binlog_encryption` 系统变量设置为 `ON` 来启用此加密。`OFF` 是默认值。该系统变量为二进制日志文件和中继日志文件设置加密。要启用加密，服务器上不需要启用二进制日志记录，因此可以在没有二进制日志的副本上加密中继日志文件。要使用加密，必须安装和配置一个密钥环组件或插件以提供 MySQL Server 的密钥环服务。有关如何执行此操作的说明，请参见 Section 8.4.4, “The MySQL Keyring”。任何支持的密钥环组件或插件都可以用于存储二进制日志加密密钥。

当首次启用加密时，服务器会在初始化二进制日志和中继日志之前生成一个新的二进制日志加密密钥。该密钥用于为每个二进制日志文件（如果服务器启用了二进制日志记录）和中继日志文件（如果服务器有复制通道）加密文件密码，并从文件密码生成的进一步密钥用于加密文件中的数据。服务器当前正在使用的二进制日志加密密钥称为二进制日志主密钥。两层加密密钥架构意味着可以根据需要轮换（用新的主密钥替换）二进制日志主密钥，只需重新使用新主密钥重新加密每个文件的文件密码，而不是整个文件。中继日志文件对所有通道进行加密，包括在激活加密后创建的新通道。二进制日志索引文件和中继日志索引文件永远不会被加密。

如果在服务器运行时激活加密，则会生成一个新的二进制日志加密密钥。例外情况是，如果之前在服务器上激活了加密，然后禁用了加密，那么之前使用的二进制日志加密密钥将再次被使用。二进制日志文件和中继日志文件立即轮换，新文件和所有后续的二进制日志文件和中继日志文件的文件密码都使用此二进制日志加密密钥进行加密。服务器上仍存在的现有二进制日志文件和中继日志文件不会被加密，但如果不再需要，可以清除它们。

如果通过将`binlog_encryption` 系统变量更改为 `OFF` 来停用加密，则二进制日志文件和中继日志文件将立即轮换，并且所有后续记录都将是未加密的。先前加密的文件不会自动解密，但服务器仍然能够读取它们。在服务器运行时激活或停用加密需要`BINLOG_ENCRYPTION_ADMIN` 权限。

可以通过加密日志文件头部的魔数来区分加密和未加密的二进制日志文件（加密日志文件为`0xFD62696E`，而未加密日志文件为`0xFE62696E`）。`SHOW BINARY LOGS` 语句显示每个二进制日志文件是加密还是未加密。

当二进制日志文件被加密时，**mysqlbinlog** 无法直接读取，但可以使用`--read-from-remote-server`选项从服务器读取。从 MySQL 8.0.14 开始，**mysqlbinlog** 如果尝试直接读取加密的二进制日志文件，将返回适当的错误，但旧版本的**mysqlbinlog** 根本不会将文件识别为二进制日志文件。如果使用**mysqlbinlog** 备份加密的二进制日志文件，请注意，使用**mysqlbinlog** 生成的文件副本以未加密格式存储。

二进制日志加密可以与二进制日志事务压缩结合使用（自 MySQL 8.0.20 起可用）。有关二进制日志事务压缩的更多信息，请参见 Section 7.4.4.5, “Binary Log Transaction Compression”。
