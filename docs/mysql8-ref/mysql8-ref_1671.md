> 原文：[`dev.mysql.com/doc/refman/8.0/en/mysql-cluster-api-definition.html`](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-api-definition.html)

#### 25.4.3.7 在 NDB Cluster 中定义 SQL 和其他 API 节点

`config.ini`文件中的`[mysqld]`和`[api]`部分定义了用于访问集群数据的 MySQL 服务器（SQL 节点）和其他应用程序（API 节点）的行为。所示的参数都不是必需的。如果未提供计算机或主机名，则任何主机都可以使用此 SQL 或 API 节点。

一般来说，`[mysqld]`部分用于指示提供 SQL 接口给集群的 MySQL 服务器，而`[api]`部分用于除**mysqld**进程之外的其他应用程序访问集群数据，但这两个指示实际上是同义的；例如，您可以在`[api]`部分中列出作为 SQL 节点的 MySQL 服务器的参数。

注意

有关 NDB Cluster 的 MySQL 服务器选项的讨论，请参见第 25.4.3.9.1 节，“NDB Cluster 的 MySQL 服务器选项”。有关与 NDB Cluster 相关的 MySQL 服务器系统变量的信息，请参见第 25.4.3.9.2 节，“NDB Cluster 系统变量”。

+   `Id`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 无符号 |
    | 默认 | [...] |
    | 范围 | 1 - 255 |
    | 重启类型 | **初始系统重启：**需要完全关闭集群，从备份中擦除和恢复集群文件系统，然后重新启动集群。（NDB 8.0.13） |

    `Id`是一个整数值，用于标识所有集群内部消息中的节点。允许的值范围是 1 到 255（包括 1 和 255）。无论节点类型如何，此值对于集群中的每个节点都必须是唯一的。

    注意

    在 NDB 8.0 中，数据节点 ID 必须小于 145。如果计划部署大量数据节点，建议将 API 节点（和管理节点）的节点 ID 限制在大于 144 的值。 （以前，数据节点 ID��最大支持值为 48。）

    `NodeId`是标识 API 节点时首选的参数名称。（`Id`继续支持向后兼容，但现已弃用，并在使用时生成警告。它也可能在未来被移除。）

+   `ConnectionMap`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字符串 |
    | 默认 | [...] |
    | 范围 | ... |
    | 重启类型 | **节点重启：**需要对集群进行滚动重启。（NDB 8.0.13） |

    指定要连接的数据节点。

+   `NodeId`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 无符号 |
    | 默认 | [...] |
    | 范围 | 1 - 255 |
    | 重启类型 | **初始系统重启：**需要完全关闭集群，从备份中擦除和恢复集群文件系统，然后重启集群。（NDB 8.0.13） |

    `NodeId` 是用于识别集群内所有节点的整数值。允许的值范围是 1 到 255（包括 1 和 255）。无论节点类型如何，此值对于集群中的每个节点都必须是唯一的。

    注意

    在 NDB 8.0 中，数据节点 ID 必须小于 145。如果计划部署大量数据节点，建议将 API 节点（和管理节点）的节点 ID 限制在大于 144 的值。 （以前，数据节点 ID 的最大支持值为 48。）

    `NodeId` 是在识别管理节点时首选的参数名称。在 NDB Cluster 的旧版本中，使用别名 `Id` 来实现此目的，并继续支持以保持向后兼容性；现在已弃用，并在使用时生成警告，并可能在将来的 NDB Cluster 版本中删除。

+   `ExecuteOnComputer`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 名称 |
    | 默认 | [...] |
    | 范围 | ... |
    | 已弃用 | 是（在 NDB 7.5 中） |
    | 重启类型 | **系统重启：**需要完全关闭和重启集群。（NDB 8.0.13） |

    这指的是配置文件中 `[computer]` 部分定义的计算机（主机）之一设置的 `Id`。

    重要

    此参数已弃用，并可能在将来的版本中删除。请改用 `HostName` 参数。

+   仅当显式请求时，此节点的节点 ID 才能提供给连接。请求“任何”节点 ID 的管理服务器无法使用此节点。当在同一主机上运行多个管理服务器时，且 `HostName` 不足以区分进程时，可以使用此参数。用于测试目的。

+   `HostName`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 名称或 IP 地址 |
    | 默认 | [...] |
    | 范围 | ... |
    | 重启类型 | **节点重启：**需要进行滚动重启。（NDB 8.0.13） |

    指定此参数定义了 SQL 节点（API 节点）所在计算机的主机名。

    如果在 `config.ini` 文件的 `[mysql]` 或 `[api]` 部分中未指定 `HostName`，则 SQL 或 API 节点可以使用任何能够与管理服务器主机建立网络连接的主机的相应“槽”进行连接。*这与数据节点的默认行为不同，数据节点默认情况下假定 `HostName` 为 `localhost`，除非另有指定*。

+   `LocationDomainId`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 整数 |
    | 默认值 | 0 |
    | 范围 | 0 - 16 |
    | 重启类型 | **系统重启：** 需要完全关闭并重新启动集群。 (NDB 8.0.13) |

    将 SQL 或其他 API 节点分配到云中的特定[可用性域](https://docs.us-phoenix-1.oraclecloud.com/Content/General/Concepts/regions.htm)（也称为可用性区域）。通过告知 `NDB` 哪些节点位于哪些可用性域中，可以在云环境中通过以下方式改善性能：

    +   如果请求的数据在同一节点上找不到，则读取可以指向同一可用性域中的另一个节点。

    +   不同可用性域中节点之间的通信将保证使用 `NDB` 传输器的广域网支持，无需进一步手动干预。

    +   传输器的组号可以基于使用的可用性域，以便 SQL 和其他 API 节点在可能的情况下与同一可用性域中的本地数据节点通信。

    +   仲裁者可以从不存在数据节点的可用性域中选择，或者如果找不到这样的可用性域，则可以从第三个可用性域中选择。

    `LocationDomainId` 接受一个介于 0 和 16 之间的整数值，其中 0 是默认值；使用 0 与未设置参数相同。

+   `ArbitrationRank`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 0-2 |
    | 默认值 | 0 |
    | 范围 | 0 - 2 |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    此参数定义哪些节点可以充当仲裁者。管理节点和 SQL 节点都可以充当仲裁者。值为 0 表示给定节点永远不会被用作仲裁者，值为 1 给予节点作为仲裁者高优先级，值为 2 给予节点作为仲裁者低优先级。正常配置使用管理服务器作为仲裁者，将其 `ArbitrationRank` 设置为 1（管理节点的默认值），并将所有 SQL 节点的设置为 0（SQL 节点的默认值）。

    通过在所有管理和 SQL 节点上将 `ArbitrationRank` 设置为 0，可以完全禁用仲裁。您还可以通过覆盖此参数来控制仲裁；为此，请在 `config.ini` 全局配置文件的 `[ndbd default]` 部分中设置 `Arbitration` 参数。

+   `ArbitrationDelay`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 毫秒 |
    | 默认 | 0 |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要对集群进行滚动重启。（NDB 8.0.13） |

    将此参数设置为除 0（默认值）以外的任何其他值意味着仲裁者对仲裁请求的响应将延迟指定的毫秒数。通常不需要更改此值。

+   `BatchByteSize`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字节 |
    | 默认 | 16K |
    | 范围 | 1K - 1M |
    | 重启类型 | **节点重启：** 需要对集群进行滚动重启。（NDB 8.0.13） |

    对于被翻译为全表扫描或索引范围扫描的查询，为了获得最佳性能，重要的是以适当大小的批次获取记录。可以根据记录数（`BatchSize`）和字节（`BatchByteSize`）设置适当的大小。实际批处理大小受这两个参数的限制。

    查询执行速度可能会因此参数的设置方式而变化超过 40%。

    此参数以字节为单位。默认值为 16K。

+   `BatchSize`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 记录 |
    | 默认 | 256 |
    | 范围 | 1 - 992 |
    | 重启类型 | **节点重启：** 需要对集群进行滚动重启。（NDB 8.0.13） |

    此参数以记录数为单位，默认设置为 256。最大大小为 992。

+   `ExtraSendBufferMemory`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字节 |
    | 默认 | 0 |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要对集群进行滚动重启。（NDB 8.0.13） |

    此参数指定要分配的传输器发送缓冲区内存量，除了使用`TotalSendBufferMemory`、`SendBufferMemory`或两者设置的内存量之外。

+   `HeartbeatThreadPriority`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字符串 |
    | 默认 | [...] |
    | 范围 | ... |
    | 重启类型 | **节点重启：** 需要进行滚动重启集群。（NDB 8.0.13） |

    使用此参数设置管理和 API 节点的心跳线程的调度策略和优先级。设置此参数的语法如下：

    ```sql
    HeartbeatThreadPriority = *policy*[, *priority*]

    *policy*:
      {FIFO | RR}
    ```

    在设置此参数时，必须指定一个策略。这是`FIFO`（先进先出）或`RR`（轮询）之一，后面可以选择优先级（整数）。

+   `MaxScanBatchSize`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字节 |
    | 默认值 | 256K |
    | 范围 | 32K - 16M |
    | 重启类型 | **节点重启：** 需要进行滚动重启集群。（NDB 8.0.13） |

    批处理大小是从每个数据节点发送的每个批次的大小。大多数扫描是并行执行的，以保护 MySQL 服务器免受同时从许多节点接收太多数据的影响；此参数设置了所有节点上总批处理大小的限制。

    此参数的默认值设置为 256KB。其最大大小为 16MB。

+   `TotalSendBufferMemory`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字节 |
    | 默认值 | 0 |
    | 范围 | 256K - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启集群。（NDB 8.0.13） |

    此参数用于确定在此节点上为所有配置的传输器之间共享的发送缓冲区内分配的总内存量。

    如果设置了此参数，则其最小允许值为 256KB；0 表示未设置该参数。有关更详细信息，请参见第 25.4.3.14 节，“配置 NDB 集群发送缓冲区参数”。

+   `AutoReconnect`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 布尔值 |
    | 默认值 | false |
    | 范围 | true, false |
    | 重启类型 | **节点重启：** 需要进行滚动重启集群。（NDB 8.0.13） |

    此参数默认为`false`。这会强制断开的 API 节点（包括充当 SQL 节点的 MySQL 服务器）使用新连接到集群，而不是尝试重用现有连接，因为在使用动态分配的节点 ID 时，重用连接可能会导致问题。（Bug #45921）

    注意

    可使用 NDB API 覆盖此参数。有关更多信息，请参阅 Ndb_cluster_connection::set_auto_reconnect()，以及 Ndb_cluster_connection::get_auto_reconnect()。

+   `DefaultOperationRedoProblemAction`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 枚举 |
    | 默认 | 队列 |
    | 范围 | ABORT, QUEUE |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    此参数（连同`RedoOverCommitLimit` 和 `RedoOverCommitCounter`）控制数据节点在刷新重做日志到磁盘时所花费的时间过长时的操作处理。当给定的重做日志刷新时间超过`RedoOverCommitLimit`秒，超过`RedoOverCommitCounter`次时，将中止任何待处理事务。

    当发生这种情况时，节点可以根据 `DefaultOperationRedoProblemAction` 的值做出两种响应，如下所示：

    +   `ABORT`: 任何中止事务中的待处理操作也将被中止。

    +   `QUEUE`: 从中止事务中的待处理操作排队等待重新尝试。这是默认设置。当重做日志耗尽空间时，即当发生 P_TAIL_PROBLEM 错误时，仍会中止待处理操作。

+   `DefaultHashMapSize`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 桶 |
    | 默认 | 3840 |
    | 范围 | 0 - 3840 |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    由此参数可配置`NDB`使用的表哈希映射的大小。`DefaultHashMapSize` 可以取三个可能的值（0、240、3840）。这些值及其影响在下表中描述。

    **表 25.17 DefaultHashMapSize 参数值**

    | 值 | 描述 / 影响 |
    | --- | --- |
    | `0` | 使用集群中所有数据节点和 API 节点中此参数��置的最低值；如果在任何数据或 API 节点上未设置，则使用默认值。 |
    | `240` | 旧的默认哈希映射大小 |
    | `3840` | NDB 8.0 中默认使用的哈希映射大小 |

    此参数的原始预期用途是促进升级和降级到和从旧的 NDB 集群版本，其中哈希映射大小不同，因为这种更改在其他情况下不兼容。当升级到或降级自 NDB 集群 8.0 时，这不是问题。

+   `Wan`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 布尔值 |
    | 默认值 | false |
    | 范围 | true, false |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    使用 WAN TCP 设置作为默认值。

+   `ConnectBackoffMaxTime`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 整数 |
    | 默认值 | 0 |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    在具有许多未启动数据节点的 NDB 集群中，可以提高此参数的值，以规避对尚未在集群中开始运行的数据节点的连接尝试，以及对管理节点的适度高流量。只要 API 节点未连接到任何新数据节点，就会应用`StartConnectBackoffMaxTime`参数的值；否则，将使用`ConnectBackoffMaxTime`来确定在连接尝试之间等待的时间长度（以毫秒为单位）。

    在节点连接尝试期间经过的时间不计入此参数的计算时间。超时时间以大约 100 毫秒的分辨率应用，从 100 毫秒延迟开始；对于每次后续尝试，此期间的长度加倍，直到达到`ConnectBackoffMaxTime`毫秒，最多为 100000 毫秒（100 秒）。

    一旦 API 节点连接到数据节点，并且该节点报告（在心跳消息中）已连接到其他数据节点，那么对这些数据节点的连接尝试不再受此参数影响，并且之后每隔 100 毫秒进行连接，直到连接成功。一旦数据节点启动，API 节点将需要`HeartbeatIntervalDbApi`来通知 API 节点已发生此情况。

+   `StartConnectBackoffMaxTime`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 整数 |
    | 默认值 | 0 |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    在具有许多未启动数据节点的 NDB 集群中，可以提高此参数的值以规避连接尝试到尚未在集群中开始运行的数据节点，以及适度减少对管理节点的高流量。只要 API 节点未连接到任何新数据节点，就会应用 `StartConnectBackoffMaxTime` 参数的值；否则，将使用 `ConnectBackoffMaxTime` 来确定在连接尝试之间等待的时间长度（以毫秒为单位）。

    在计算此参数的经过时间时，连接尝试期间的时间不计入其中。超时时间以大约 100 毫秒的分辨率应用，从 100 毫秒延迟开始；对于每个后续尝试，此期间的长度加倍，直到达到 `StartConnectBackoffMaxTime` 毫秒，最多为 100000 毫秒（100 秒）。

    一旦 API 节点连接到数据节点，并且该节点报告（在心跳消息中）已连接到其他数据节点，连接尝试到这些数据节点不再受此参数影响，并且之后每隔 100 毫秒进行一次连接尝试，直到连接成功。一旦数据节点启动，API 节点将需要 `HeartbeatIntervalDbApi` 来通知 API 节点已发生此情况。

**API 节点调试参数。** 您可以使用 `ApiVerbose` 配置参数来启用给定 API 节点的调试输出。此参数接受整数值。默认值为 0，禁用此类调试；1 启用调试输出到集群日志；2 还添加了 `DBDICT` 调试输出。（Bug #20638450）另请参阅 DUMP 1229。

您还可以使用 `SHOW STATUS` 在 **mysql** 客户端中运行作为 NDB 集群 SQL 节点的 MySQL 服务器来获取信息，如下所示：

```sql
mysql> SHOW STATUS LIKE 'ndb%';
+-----------------------------+----------------+
| Variable_name               | Value          |
+-----------------------------+----------------+
| Ndb_cluster_node_id         | 5              |
| Ndb_config_from_host        | 198.51.100.112 |
| Ndb_config_from_port        | 1186           |
| Ndb_number_of_storage_nodes | 4              |
+-----------------------------+----------------+
4 rows in set (0.02 sec)
```

有关此语句输出中出现的状态变量的信息，请参阅 第 25.4.3.9.3 节，“NDB 集群状态变量”。

注意

要将新的 SQL 或 API 节点添加到运行中的 NDB 集群的配置中，需要在向 `config.ini` 文件（如果使用多个管理服务器，则为文件）中添加新的 `[mysqld]` 或 `[api]` 部分后，对所有集群节点执行滚动重启。在新的 SQL 或 API 节点能够连接到集群之前，必须执行此操作。

如果新的 SQL 或 API 节点可以利用集群配置中以前未使用的 API 插槽连接到集群，则*不*需要执行任何集群重启。

**重启类型。** 本节参数描述中使用的重启类型信息如下表所示：

**表 25.18 NDB 集群重启类型**

| 符号 | 重启类型 | 描述 |
| --- | --- | --- |
| N | 节点 | 可以使用滚动重启来更新参数（参见第 25.6.5 节，“执行 NDB 集群的滚动重启”） |
| S | 系统 | 所有集群节点必须完全关闭，然后重新启动，以更改此参数 |
| I | 初始 | 数据节点必须使用`--initial`选项重新启动 |
