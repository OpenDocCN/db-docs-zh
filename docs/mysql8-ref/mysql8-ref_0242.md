> 原文：[`dev.mysql.com/doc/refman/8.0/en/connection-interfaces.html`](https://dev.mysql.com/doc/refman/8.0/en/connection-interfaces.html)

#### 7.1.12.1 连接接口

本节描述了 MySQL 服务器管理客户端连接的方面。

+   网络接口和连接管理器线程

+   客户端连接线程管理

+   连接量管理

##### 网络接口和连接管理器线程

服务器能够在多个网络接口上监听客户端连接。连接管理器线程处理服务器监听的网络接口上的客户端连接请求：

+   在所有平台上，一个管理器线程处理 TCP/IP 连接请求。

+   在 Unix 上，同一个管理器线程还处理 Unix 套接字文件连接请求。

+   在 Windows 上，一个管理器线程处理共享内存连接请求，另一个处理命名管道连接请求。

+   在所有平台上，可以启用额外的网络接口以接受管理 TCP/IP 连接请求。此接口可以使用处理“普通”TCP/IP 请求的管理器线程，或者使用单独的线程。

服务器不会创建用于处理其未监听的接口的线程。例如，未启用对命名管道连接的支持的 Windows 服务器不会创建用于处理它们的线程。

单独的服务器插件或组件可能会实现自己的连接接口：

+   X 插件使 MySQL 服务器能够使用 X 协议与客户端通信。请参阅第 22.5 节，“X 插件”。

##### 客户端连接线程管理

连接管理器线程将每个客户端连接与专用于处理该连接的线程关联起来，负责认证和请求处理。管理器线程在必要时创建新线程，但会首先查看线程缓存，以查看是否有可用于连接的线程，以避免创建新线程。当连接结束时，如果缓存未满，则将其线程返回到线程缓存中。

在这种连接线程模型中，当前连接的客户端数量与线程数量相同，当服务器工作负载必须扩展以处理大量连接时，会出现一些缺点。例如，线程的创建和销毁变得昂贵。此外，每个线程都需要服务器和内核资源，如堆栈空间。为了容纳大量同时连接，必须保持每个线程的堆栈大小较小，导致堆栈大小要么太小，要么服务器消耗大量内存。其他资源的耗尽也可能发生，并且调度开销可能变得显著。

MySQL 企业版包括一个线程池插件，提供了一种旨在减少开销并提高性能的替代线程处理模型。它实现了一个线程池，通过有效管理大量客户端连接的语句执行线程来提高服务器性能。请参阅第 7.6.3 节，“MySQL 企业线程池”。

要控制和监视服务器如何管理处理客户端连接的线程，有几个相关的系统和状态变量。（请参阅第 7.1.8 节，“服务器系统变量”和第 7.1.10 节，“服务器状态变量”。）

+   `thread_cache_size`系统变量确定线程缓存大小。默认情况下，服务器在启动时自动调整该值，但可以显式设置以覆盖此默认值。值为 0 会禁用缓存，这会导致每个新连接都设置一个线程，并在连接终止时将其销毁。要启用*`N`*个非活动连接线程缓存，请在服务器启动时或运行时将`thread_cache_size`设置为*`N`*。当与其关联的客户端连接终止时，连接线程变为非活动状态。

+   要监视缓存中的线程数以及由于无法从缓存中获取线程而创建的线程数，请检查`Threads_cached`和`Threads_created`状态变量。

+   当线程堆栈太小时，这限制了服务器可以处理的 SQL 语句的复杂性，存储过程的递归深度以及其他消耗内存的操作。要为每个线程设置*`N`*字节的堆栈大小，请使用`thread_stack`设置为*`N`*来启动服务器。

##### 连接数量管理

要控制服务器允许同时连接的最大客户端数，请在服务器启动或运行时设置 `max_connections` 系统变量。如果更多客户端尝试同时连接，而服务器配置为处理的数量不够，则可能需要增加 `max_connections`（请参阅 Section B.3.2.5, “Too many connections”）。如果服务器因达到 `max_connections` 限制而拒绝连接，则会增加 `Connection_errors_max_connections` 状态变量。

**mysqld** 实际上允许 `max_connections` + 1 个客户端连接。额外的连接保留供具有 `CONNECTION_ADMIN` 权限（或已弃用的 `SUPER` 权限）的帐户使用。通过将权限授予管理员而不授予普通用户（不应该需要该权限），管理员可以连接到服务器并使用 `SHOW PROCESSLIST` 来诊断问题，即使已连接了最大数量的非特权客户端。参见 Section 15.7.7.29, “SHOW PROCESSLIST Statement”。

从 MySQL 8.0.14 开始，服务器还允许在管理网络接口上进行管理连接，您可以使用专用 IP 地址和端口进行设置。参见 Section 7.1.12.2, “Administrative Connection Management”。

Group Replication 插件通过内部会话与 MySQL Server 进行交互，执行 SQL API 操作。在 MySQL 8.0.18 版本中，这些会话计入由 `max_connections` 服务器系统变量指定的客户端连接限制。在这些版本中，如果服务器在启动 Group Replication 或尝试执行操作时已达到 `max_connections` 限制，则操作将失败，Group Replication 或服务器本身可能会停止。从 MySQL 8.0.19 开始，Group Replication 的内部会话与客户端连接分开处理，因此它们不计入 `max_connections` 限制，并且如果服务器达到此限制，则不会被拒绝。

MySQL 支持的客户端连接的最大数量（即可以设置为的`max_connections`的最大值）取决于几个因素：

+   给定平台上线程库的质量。

+   可用的 RAM 量。

+   每个连接使用的 RAM 量。

+   每个连接的工作负载。

+   期望的响应时间。

+   可用的文件描述符数量。

Linux 或 Solaris 应该能够常规支持至少 500 到 1000 个同时连接，并且如果你有许多 GB 的可用 RAM 并且每个连接的工作负载较低或响应时间目标不苛刻，那么可以支持多达 10,000 个连接。

增加`max_connections`值会增加**mysqld**需要的文件描述符数量。如果所需的描述符数量不可用，服务器会降低`max_connections`的值。有关文件描述符限制的评论，请参见 Section 10.4.3.1, “How MySQL Opens and Closes Tables”。

可能需要增加`open_files_limit`系统变量，这可能还需要提高操作系统对 MySQL 可以使用多少文件描述符的限制。请参阅您的操作系统文档，以确定是否可以增加限制以及如何操作。另请参见 Section B.3.2.16, “File Not Found and Similar Errors”。
