> 原文：[`dev.mysql.com/doc/refman/8.0/en/group-replication-cloning.html`](https://dev.mysql.com/doc/refman/8.0/en/group-replication-cloning.html)

#### 20.5.4.2 分布式恢复的克隆

MySQL Server 的克隆插件从 MySQL 8.0.17 开始提供。如果要在组中使用远程克隆操作进行分布式恢复，必须事先设置现有成员和加入成员以支持此功能。如果不想在组中使用此功能，请不要设置，此时组复制仅使用来自二进制日志的状态传输。

要使用克隆，至少一个现有组成员和加入成员必须事先设置以支持远程克隆操作。最低要求是，在捐赠者和加入成员上安装克隆插件，为分布式恢复的复制用户授予`BACKUP_ADMIN`权限，并将`group_replication_clone_threshold`系统变量设置为适当的级别。为确保捐赠者的最大可用性，建议设置所有当前和未来的组成员以支持远程克隆操作。

请注意，远程克隆操作会在从捐赠者传输数据之前，从加入成员中删除用户创建的表空间和数据。如果操作在进行中停止，加入成员可能会留下部分数据或没有数据。这可以通过重新尝试远程克隆操作来修复，组复制会自动执行此操作。

##### 20.5.4.2.1 克隆的先决条件

要设置和配置克隆插件的完整说明，请参阅第 7.6.7 节，“克隆插件”。有关远程克隆操作的详细先决条件，请参阅第 7.6.7.3 节，“克隆远程数据”。对于组复制，请注意以下关键点和差异：

+   捐赠者（现有组成员）和接收者（加入成员）必须安装并激活克隆插件。有关如何执行此操作的说明，请参阅第 7.6.7.1 节，“安装克隆插件”。

+   捐赠者和接收者必须运行在相同的操作系统上，并且必须具有相同的 MySQL Server 版本系列。因此，对于运行不同次要 MySQL Server 版本的组，如 MySQL 8.0 和 8.4，克隆不适用。

    在 MySQL 8.0.37 之前，克隆要求捐赠者和接收者是相同的点版本，如果捐赠者或接收者是 MySQL 8.0.36 或更早版本，则仍然适用此限制。

+   捐赠者和接收者必须安装并激活组复制插件，捐赠者上激活的任何其他插件（如密钥环插件）也必须在接收者上激活。

+   如果分布式恢复配置为使用 SSL（`group_replication_recovery_use_ssl=ON`），组复制会将此设置应用于远程克隆操作。组复制会自动配置克隆 SSL 选项的设置（`clone_ssl_ca`、`clone_ssl_cert`和`clone_ssl_key`），以匹配您对应的组复制分布式恢复选项的设置（`group_replication_recovery_ssl_ca`、`group_replication_recovery_ssl_cert`和`group_replication_recovery_ssl_key`）。

+   在加入复制组的过程中，您无需在`clone_valid_donor_list`系统变量中设置有效捐赠者列表。组复制会在从现有组成员中选择捐赠者后自动为您配置此设置。请注意，远程克隆操作使用服务器的 SQL 协议主机名和端口。

+   克隆插件有许多系统变量来管理远程克隆操作的网络负载和性能影响。组复制不会配置这些设置，因此您可以查看并设置它们，或者允许它们使用默认设置。请注意，当远程克隆操作用于分布式恢复时，克隆插件的`clone_enable_compression`设置适用于操作，而不是组复制的压缩设置。

+   为了在接收端调用远程克隆操作，组复制使用内部的`mysql.session`用户，该用户已经具有`CLONE_ADMIN`权限，因此您无需设置此权限。

+   作为远程克隆操作的捐赠者上的克隆用户，Group Replication 使用您为分布式恢复设置的复制用户（在 Section 20.2.1.3, “User Credentials For Distributed Recovery”中介绍）。因此，您必须在支持克隆的所有组成员上为此复制用户授予`BACKUP_ADMIN`权限。在为 Group Replication 配置加入成员时，还必须为复制用户授予权限，因为它们在加入组后可以充当捐赠者。在每个组成员上为复制用户授予此权限，您可以在禁用二进制日志记录的每个组成员上单独发出此语句，或者在启用二进制日志记录的一个组成员上发出：

    ```sql
    GRANT BACKUP_ADMIN ON *.* TO *rpl_user*@'%';
    ```

+   如果您使用`START GROUP_REPLICATION`在服务器上指定复制用户凭据，而该服务器先前使用`CHANGE REPLICATION SOURCE TO` | `CHANGE MASTER TO`提供用户凭据，请确保在进行任何远程克隆操作之前从复制元数据存储库中删除用户凭据。还要确保`group_replication_start_on_boot=OFF`在加入成员上设置。有关说明，请参见 Section 20.6.3, “Securing Distributed Recovery Connections”。如果不取消用户凭据，则在远程克隆操作期间，这些凭据将传输到加入成员。然后，`group_replication_recovery`通道可能会意外地使用存储的凭据在原始成员或从原始成员克隆的成员上启动。服务器启动时（包括远程克隆操作后）自动启动 Group Replication 将使用存储的用户凭据，如果操作员未在`START GROUP_REPLICATION`命令中指定分布式恢复凭据，则也会使用这些凭据。

##### 20.5.4.2.2 克隆门槛

当组成员已经设置支持克隆时，`group_replication_clone_threshold` 系统变量指定了一个阈值，以事务数量表示，用于在分布式恢复中使用远程克隆操作。如果捐赠者的事务和加入成员的事务之间的差距大于这个数字，当技术上可能时，将使用远程克隆操作进行状态传输到加入成员。Group Replication 根据现有组成员的 `gtid_executed` 集合计算是否已超过阈值。在存在较大事务差距的情况下使用远程克隆操作，可以让您向组中添加新成员，而无需事先手动将组的数据传输到服务器，并且还可以使非常过时的成员更有效地追赶。

`group_replication_clone_threshold` Group Replication 系统变量的默认设置非常高（GTID 中事务的最大允许序列号），因此在可能从二进制日志进行状态传输的地方，它有效地停用了克隆。要使 Group Replication 在更合适的情况下选择远程克隆操作进行状态传输，请设置系统变量以指定一个事务数量作为您希望进行克隆的事务差距的上限。

警告

在活动组中不要使用低设置的 `group_replication_clone_threshold`。如果在远程克隆操作正在进行时组中发生超过阈值的事务数量，那么加入成员在重新启动后会再次触发远程克隆操作，并且可能会无限继续这样做。为避免这种情况，请确保将阈值设置为高于您预期在远程克隆操作所需时间内组中可能发生的事务数量。

集群复制尝试执行远程克隆操作，无论您的阈值如何，当从捐赠者的二进制日志中无法进行状态转移时，例如因为加入成员所需的事务在任何现有组成员的二进制日志中都不可用时。集群复制根据现有组成员的`gtid_purged`集合来识别这一点。当任何成员的二进制日志文件中没有所需的事务时，您不能使用`group_replication_clone_threshold`系统变量来停用克隆，因为在这种情况下，克隆是将数据传输到加入成员的唯一选择。

##### 20.5.4.2.3 克隆操作

当组成员和加入成员设置为进行克隆时，集群复制会为您管理远程克隆操作。远程克隆操作可能需要一些时间才能完成，具体取决于数据的大小。有关监视过程的信息，请参见第 7.6.7.10 节，“监视克隆操作”。

注意

当状态转移完成时，集群复制会重新启动加入成员以完成该过程。如果在加入成员上设置了`group_replication_start_on_boot=OFF`，例如因为您在`START GROUP_REPLICATION`语句中指定了复制用户凭据，那么您必须在此重新启动后再次手动发出`START GROUP_REPLICATION`。如果`group_replication_start_on_boot=ON`和启动集群复制所需的其他设置是在配置文件中设置或使用`SET PERSIST`语句设置的，则您无需干预，该过程将自动继续以使加入成员在线。

如果远程克隆过程花费很长时间，在 MySQL 8.0.22 之前的版本中，可能会出现在此期间为组积累的证书信息集合过大而无法传输给加入成员的情况。在这种情况下，加入成员会记录错误消息并且不会加入组。从 MySQL 8.0.22 开始，组复制以不同的方式管理已应用事务的垃圾收集过程，以避免这种情况发生。在早期版本中，如果您看到此错误，请在远程克隆操作完成后等待两分钟，以便进行一轮垃圾收集以减小组的证书信息大小。然后在加入成员上发出以下语句，以使其停止尝试应用先前的证书信息：

```sql
RESET SLAVE FOR CHANNEL group_replication_recovery;
Or from MySQL 8.0.22:
RESET REPLICA FOR CHANNEL group_replication_recovery;
```

远程克隆操作会将存储在表中的设置从捐赠者克隆到接收者，以及数据。组复制管理与组复制通道相关的设置。在配置文件中持久化的组复制成员设置，如组复制本地地址，不会被克隆，也不会在加入成员时更改。组复制还保留与 SSL 使用相关的通道设置，因此这些设置对于每个成员都是独一无二的。

如果捐赠者用于`group_replication_recovery`复制通道的复制用户凭据已使用`CHANGE REPLICATION SOURCE TO` | `CHANGE MASTER TO`语句存储在复制元数据存储库中，则在克隆后将其传输到并由加入成员使用，并且必须在那里有效。使用存储的凭据，通过远程克隆操作接收状态转移的所有组成员因此自动接收用于分布式恢复的复制用户和密码。如果在`START GROUP_REPLICATION`语句中指定了复制用户凭据，则这些凭据用于启动远程克隆操作，但在克隆后不会被传输到并由加入成员使用。如果不希望将凭据传输给新加入者并记录在那里，请确保在进行远程克隆操作之前取消设置它们，如第 20.6.3 节“保护分布式恢复连接”中所述，并使用`START GROUP_REPLICATION`来代替提供它们。

如果使用`PRIVILEGE_CHECKS_USER`帐户来帮助保护复制应用程序（请参阅 Section 19.3.3.2, “Group Replication 通道的权限检查”），从 MySQL 8.0.19 开始，将从捐赠者克隆`PRIVILEGE_CHECKS_USER`帐户和相关设置到加入的成员。如果设置加入的成员在启动时启动 Group Replication，则自动在适当的复制通道上使用该帐户进行权限检查。（在 MySQL 8.0.18 中，由于一些限制，建议不要在 Group Replication 通道中使用`PRIVILEGE_CHECKS_USER`帐户。）

##### 20.5.4.2.4 其他目的的克隆

Group Replication 启动并管理分布式恢复的克隆操作。已设置为支持克隆的组成员也可以参与用户手动启动的克隆操作。例如，您可能希望通过从组成员作为捐赠者进行克隆来创建一个新的服务器实例，但您不希望新的服务器实例立即加入组，甚至可能永远不加入。

在支持克隆的所有版本中，您可以手动启动涉及 Group Replication 已停止的组成员的克隆操作。请注意，由于克隆要求捐赠者和接收者上的活动插件必须匹配，因此即使您不打算使服务器实例加入组，Group Replication 插件也必须在另一个服务器实例上安装并激活。您可以通过发出以下语句来安装插件：

```sql
INSTALL PLUGIN group_replication SONAME 'group_replication.so';
```

在 MySQL 8.0.20 之前的版本中，如果克隆操作涉及正在运行 Group Replication 的组成员，则无法手动启动克隆操作。从 MySQL 8.0.20 开始，您可以这样做，前提是克隆操作不会删除并替换接收方的数据。因此，启动克隆操作的语句必须包含`DATA DIRECTORY`子句，如果 Group Replication 正在运行。
