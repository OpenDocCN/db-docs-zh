# 14.24.3 表达式处理

> 原文：[`dev.mysql.com/doc/refman/8.0/en/precision-math-expressions.html`](https://dev.mysql.com/doc/refman/8.0/en/precision-math-expressions.html)

使用精确数学，尽可能使用给定的精确值作为数字。例如，在比较中使用的数字将完全按照给定值使用，而不会更改值。在严格 SQL 模式下，对于具有精确数据类型（`DECIMAL`或整数）的列进行`INSERT`时，如果数字在列范围内，则将插入其精确值。检索时，值应与插入的值相同。（如果未启用严格 SQL 模式，则允许对`INSERT`进行截断。）

数值表达式的处理取决于表达式包含的值的类型：

+   如果表达式中存在任何近似值，则表达式是近似的，并使用浮点运算进行评估。

+   如果表达式中没有近似值，则表达式只包含精确值。如果任何精确值包含小数部分（小数点后的值），则使用`DECIMAL`精确算术进行评估，并具有 65 位数字的精度。术语“精确”受二进制表示的限制。例如，`1.0/3.0`可以在十进制表示中近似为`.333...`，但不能写成一个精确的数字，因此`(1.0/3.0)*3.0`不会精确评估为`1.0`。

+   否则，表达式只包含整数值。表达式是精确的，并使用整数运算进行评估，具有与`BIGINT`（64 位）相同的精度。

如果数值表达式包含任何字符串，则它们将转换为双精度浮点值，并且表达式是近似的。

插入到数值列中受 SQL 模式的影响，该模式由`sql_mode`系统变量控制。（参见 Section 7.1.11, “Server SQL Modes”.）以下讨论提到了严格模式（由`STRICT_ALL_TABLES`或`STRICT_TRANS_TABLES`模式值选择）和`ERROR_FOR_DIVISION_BY_ZERO`。要打开所有限制，您可以简单地使用`TRADITIONAL`模式，其中包括严格模式值和`ERROR_FOR_DIVISION_BY_ZERO`：

```sql
SET sql_mode='TRADITIONAL';
```

如果将数字插入到精确类型列（`DECIMAL` - DECIMAL, NUMERIC") 或整数）中，如果在列范围和精度内，则插入其精确值。

如果小数部分的数字过多，将进行四舍五入并生成一个注释。四舍五入的处理如第 14.24.4 节，“四舍五入行为”中所述。由于小数部分的四舍五入而导致截断不是错误，即使在严格模式下也是如此。

如果整数部分的数字过多，则它太大（超出范围）并按以下方式处理：

+   如果未启用严格模式，则该值将被截断为最接近的合法值，并生成警告。

+   如果启用严格模式，则会发生溢出错误。

在 MySQL 8.0.31 之前，对于`DECIMAL` - DECIMAL, NUMERIC")文字，除了 65 位数字的精度限制外，还有一个限制文字长度的限制。如果值超过大约 80 个字符，可能会导致意外结果。例如：

```sql
mysql> SELECT
       CAST(0000000000000000000000000000000000000000000000000000000000000000000000000000000020.01 AS DECIMAL(15,2)) as val;
+------------------+
| val              |
+------------------+
| 9999999999999.99 |
+------------------+
1 row in set, 2 warnings (0.00 sec)

mysql> SHOW WARNINGS;
+---------+------+----------------------------------------------+
| Level   | Code | Message                                      |
+---------+------+----------------------------------------------+
| Warning | 1292 | Truncated incorrect DECIMAL value: '20'      |
| Warning | 1264 | Out of range value for column 'val' at row 1 |
+---------+------+----------------------------------------------+
2 rows in set (0.00 sec)
```

截至 MySQL 8.0.31，这不再是一个问题，如下所示：

```sql
mysql> SELECT
       CAST(0000000000000000000000000000000000000000000000000000000000000000000000000000000020.01 AS DECIMAL(15,2)) as val;
+-------+
| val   |
+-------+
| 20.01 |
+-------+
1 row in set (0.00 sec)
```

下溢不会被检测到，因此下溢处理是未定义的。

对于将字符串插入到数字列中，如果字符串具有非数字内容，则将字符串转换为数字的处理如下：

+   以非数字开头的字符串不能用作数字，在严格模式下会产生错误，否则会产生警告。这包括空字符串。

+   以数字开头的字符串可以转换，但尾随的非数字部分将被截断。如果被截断的部分包含除空格以外的任何内容，在严格模式下会产生错误，否则会产生警告。

默认情况下，除零操作会产生`NULL`结果且不会有警告。通过适当设置 SQL 模式，可以限制除零操作。

启用`ERROR_FOR_DIVISION_BY_ZERO` SQL 模式后，MySQL 会以不同方式处理除零操作：

+   如果未启用严格模式，将产生警告。

+   如果启用严格模式，则禁止涉及除零操作的插入和更新，并出现错误。

换句话说，涉及除零操作的插入和更新可以被视为错误，但这需要`ERROR_FOR_DIVISION_BY_ZERO`以及严格模式。

假设我们有以下语句：

```sql
INSERT INTO t SET i = 1/0;
```

这是严格模式和`ERROR_FOR_DIVISION_BY_ZERO`模式的组合情况。

| `sql_mode` 值 | 结果 |
| --- | --- |
| `''`（默认） | 无警告，无错误；`i` 被设置为 `NULL`。 |
| 严格 | 无警告，无错误；`i` 被设置为 `NULL`。 |
| `ERROR_FOR_DIVISION_BY_ZERO` | 警告，没有错误；`i` 被设置为 `NULL`。 |
| 严格模式，`ERROR_FOR_DIVISION_BY_ZERO` | 错误条件；不插入任何行。 |
