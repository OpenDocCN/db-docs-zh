> 译文：[`dev.mysql.com/doc/refman/8.0/en/table-cache.html`](https://dev.mysql.com/doc/refman/8.0/en/table-cache.html)

#### 10.4.3.1 MySQL 如何打开和关闭表

当你执行 **mysqladmin status** 命令时，你应该看到类似以下内容：

```sql
Uptime: 426 Running threads: 1 Questions: 11082
Reloads: 1 Open tables: 12
```

`Open tables` 值为 12 可能会让人感到困惑，如果你的表少于 12 张。

MySQL 是多线程的，因此可能会有许多客户端同时为给定表发出查询。为了最小化多个客户端会话在同一表上具有不同状态的问题，每个并发会话独立打开表。这会使用额外的内存，但通常会提高性能。对于 `MyISAM` 表，每个打开表的客户端都需要一个额外的文件描述符用于数据文件。（相比之下，索引文件描述符在所有会话之间共享。）

`table_open_cache` 和 `max_connections` 系统变量影响服务器保持打开的文件的最大数量。如果你增加其中一个或两个值，可能会遇到操作系统对每个进程打开文件描述符数量的限制。许多操作系统允许你增加打开文件的限制，尽管方法因系统而异。请查阅你的操作系统文档，确定是否可以增加限制以及如何操作。

`table_open_cache` 与 `max_connections` 相关。例如，对于 200 个并发运行的连接，至少指定一个表缓存大小为 `200 * *`N`*`，其中 *`N`* 是你执行的任何查询中任何连接中的最大表数。你还必须为临时表和文件保留一些额外的文件描述符。

确保你的操作系统能够处理由 `table_open_cache` 设置所暗示的打开文件描述符数量。如果 `table_open_cache` 设置过高，MySQL 可能会耗尽文件描述符，并表现出拒绝连接或无法执行查询等症状。

还要考虑到 `MyISAM` 存储引擎每个唯一打开表需要两个文件描述符。要增加供 MySQL 使用的文件描述符数量，设置 `open_files_limit` 系统变量。参见 Section B.3.2.16, “File Not Found and Similar Errors”。

打开表的缓存保持在`table_open_cache`条目的水平。服务器在启动时自动调整缓存大小。要显式设置大小，请在启动时设置`table_open_cache`系统变量。MySQL 可能会临时打开比这更多的表来执行查询，如本节后面所述。

MySQL 在以下情况下关闭未使用的表并从表缓存中删除它：

+   当缓存已满且线程尝试打开不在缓存中的表时。

+   当缓存包含超过`table_open_cache`条目且缓存中的表不再被任何线程使用时。

+   当发生表刷新操作时。当有人发出`FLUSH TABLES`语句或执行**mysqladmin flush-tables**或**mysqladmin refresh**命令时。

当表缓存填满时，服务器使用以下过程来定位要使用的缓存条目：

+   当前未使用的表将被释放，从最近最少使用的表开始。

+   如果必须打开新表，但缓存已满且无法释放表，则根据需要临时扩展缓存。当缓存处于临时扩展状态且表从已使用到未使用状态时，表将被关闭并从缓存中释放。

每个并发访问都会打开一个`MyISAM`表。这意味着如果两个线程访问同一张表，或者一个线程在同一查询中两次访问表（例如，通过将表与自身连接），则需要打开表两次。每个并发打开都需要在表缓存中有一个条目。任何`MyISAM`表的第一次打开需要两个文件描述符：一个用于数据文件，一个用于索引文件。对表的每次额外使用只需要一个数据文件的文件描述符。索引文件描述符在所有线程之间共享。

如果您使用`HANDLER *`tbl_name`* OPEN`语句打开表，则为线程分配一个专用表对象。此表对象不与其他线程共享，并且直到线程调用`HANDLER *`tbl_name`* CLOSE`或线程终止时才关闭。发生这种情况时，表将放回表缓存（如果缓存未满）。请参阅第 15.2.5 节，“HANDLER 语句”。

要确定您的表缓存是否太小，请检查`Opened_tables`状态变量，该变量指示自服务器启动以来的表打开操作次数：

```sql
mysql> SHOW GLOBAL STATUS LIKE 'Opened_tables';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| Opened_tables | 2741  |
+---------------+-------+
```

如果值非常大或增长迅速，即使您没有发出许多`FLUSH TABLES`语句，也应在服务器启动时增加`table_open_cache`的值。
