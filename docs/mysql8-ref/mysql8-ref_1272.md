# 17.18.2 InnoDB 恢复

> 原文：[`dev.mysql.com/doc/refman/8.0/en/innodb-recovery.html`](https://dev.mysql.com/doc/refman/8.0/en/innodb-recovery.html)

本节描述了`InnoDB`恢复。主题包括：

+   时间点恢复

+   从数据损坏或磁盘故障中恢复

+   InnoDB ��溃恢复

+   崩溃恢复中的表空间发现

#### 时间点恢复

要将`InnoDB`数据库从物理备份的时间恢复到当前状态，必须在进行备份之前启用 MySQL 服务器的二进制日志记录。在恢复备份后实现时间点恢复，可以应用在备份后发生的二进制日志更改。参见第 9.5 节，“时间点（增量）恢复” Recovery")。

#### 从数据损坏或磁盘故障中恢复

如果您的数据库损坏或磁盘故障发生，您必须使用备份执行恢复。在损坏的情况下，首先找到一个没有损坏的备份。恢复基本备份后，使用**mysqlbinlog**和**mysql**从二进制日志文件中执行时间点恢复，以恢复备份后发生的更改。

在某些数据库损坏的情况下，只需转储、删除和重新创建一个或几个损坏的表即可。您可以使用`CHECK TABLE`语句来检查表是否损坏，尽管`CHECK TABLE`自然无法检测到每种可能的损坏。

在某些情况下，表面上的数据库页损坏实际上是由于操作系统损坏了自己的文件缓存，磁盘上的数据可能是正常的。最好先尝试重新启动计算机。这样做可能会消除看起来是数据库页损坏的错误。如果 MySQL 由于`InnoDB`一致性问题而仍然无法启动，请参见第 17.21.3 节，“强制 InnoDB 恢复”，了解在恢复模式下启动实例的步骤，这样可以让您转储数据。

#### InnoDB 崩溃恢复

要从意外的 MySQL 服务器退出中恢复，唯一的要求是重新启动 MySQL 服务器。`InnoDB`会自动检查日志并将数据库回滚到当前状态。`InnoDB`会自动回滚在崩溃时存在的未提交事务。

`InnoDB` 崩溃恢复包括几个步骤：

+   表空间发现

    表空间发现是`InnoDB`用来识别需要重做日志应用的表空间的过程。请参阅崩溃恢复期间的表空间发现。

+   重做日志应用

    重做日志应用是在初始化期间执行的，在接受任何连接之前。如果在关闭或崩溃时从缓冲池中的所有更改都被刷新到表空间（`ibdata*`和`*.ibd`文件），则会跳过重做日志应用。如果在启动时重做日志文件丢失，`InnoDB`也会跳过重做日志应用。

    +   每次自增计数器值发生变化时，当前最大自增计数器值都会被写入重做日志，使其具有崩溃安全性。在恢复过程中，`InnoDB`会扫描重做日志以收集计数器值的变化，并将这些变化应用于内存中的表对象。

        有关`InnoDB`如何处理自增值的更多信息，请参阅第 17.6.1.6 节，“InnoDB 中的 AUTO_INCREMENT 处理”，以及 InnoDB AUTO_INCREMENT 计数器初始化。

    +   当遇到索引树损坏时，`InnoDB`会将一个损坏标志写入重做日志，使得损坏标志具有崩溃安全性。`InnoDB`还会在每次检查点时将内存中的损坏标志数据写入引擎私有系统表中。在恢复过程中，`InnoDB`会从两个位置读取损坏标志，并在标记内存表和索引对象为损坏之前合并结果。

    +   不建议删除重做日志以加快恢复速度，即使可以接受一些数据丢失。只有在干净关闭后，将`innodb_fast_shutdown`设置为`0`或`1`后才应考虑删除重做日志。

+   回滚未完成的事务

    未完成的事务是在意外退出或快速关闭时处于活动状态的任何事务。回滚未完成事务所需的时间可能是事务被中断前活动时间的三到四倍，取决于服务器负载。

    无法取消正在回滚的事务。在极端情况下，当预计回滚事务需要花费异常长的时间时，通过使用设置为`3`或更高的`innodb_force_recovery`选项启动`InnoDB`可能更快。请参阅第 17.21.3 节，“强制 InnoDB 恢复”。

+   更改缓冲区合并

    将更改缓冲区（系统表空间的一部分）中的更改应用到辅助索引的叶页，因为索引页被读取到缓冲池中。

+   清理

    删除对活动事务不再可见的已标记删除记录。

在重做日志应用后的步骤不依赖于重做日志（除了用于记录写入），并与正常处理并行执行。其中，只有不完整事务的回滚对于崩溃恢复是特殊的。插入缓冲区合并和清理是在正常处理期间执行的。

在重做日志应用之后，`InnoDB`尽早尝试接受连接，以减少停机时间。作为崩溃恢复的一部分，`InnoDB`回滚了在服务器退出时未提交或处于`XA PREPARE`状态的事务。回滚由后台线程执行，并与新连接的事务并行执行。在回滚操作完成之前，新连接可能会与恢复的事务发生锁定冲突。

在大多数情况下，即使 MySQL 服务器在繁忙活动中意外关闭，恢复过程会自动发生，DBA 不需要采取任何行动。如果硬件故障或严重系统错误损坏了`InnoDB`数据，MySQL 可能会拒绝启动。在这种情况下，请参阅第 17.21.3 节，“强制 InnoDB 恢复”。

有关二进制日志和`InnoDB`崩溃恢复的信息，请参阅第 7.4.4 节，“二进制日志”。

#### 在崩溃恢复期间的表空间发现

如果在恢复过程中，`InnoDB`遇到自上次检查点以来写入的重做日志，则必须将重做日志应用于受影响的表空间。在恢复期间识别受影响表空间的过程称为*表空间发现*。

表空间发现依赖于`innodb_directories`设置，该设置定义了在启动时扫描表空间文件的目录。`innodb_directories`的默认设置为 NULL，但在 InnoDB 构建启动时要扫描的目录列表时，始终会将由`innodb_data_home_dir`、`innodb_undo_directory`和`datadir`定义的目录附加到`innodb_directories`参数值上。这些目录会被附加，无论是否明确指定了`innodb_directories`设置。如果在重做日志中引用的任何表空间文件之前未发现，恢复将终止。
