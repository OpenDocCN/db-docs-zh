# A.4 MySQL 8.0 FAQ：存储过程和函数

> 原文：[`dev.mysql.com/doc/refman/8.0/en/faqs-stored-procs.html`](https://dev.mysql.com/doc/refman/8.0/en/faqs-stored-procs.html)

A.4.1\. MySQL 8.0 支持存储过程和函数吗？

A.4.2\. 我在哪里可以找到 MySQL 存储过程和存储函数的文档？

A.4.3\. 是否有关于 MySQL 存储过程的讨论论坛？

A.4.4\. 我在哪里可以找到 ANSI SQL 2003 存储过程规范？

A.4.5\. 如何管理存储例程？

A.4.6\. 有没有办法查看给定数据库中的所有存储过程和存储函数？

A.4.7\. 存储过程存储在哪里？

A.4.8\. 是否可以将存储过程或存储函数分组到包中？

A.4.9\. 存储过程可以调用另一个存储过程吗？

A.4.10\. 存储过程可以调用触发器吗？

A.4.11\. 存储过程可以访问表吗？

A.4.12\. 存储过程是否有用于引发应用程序错误的语句？

A.4.13\. 存储过程提供异常处理吗？

A.4.14\. MySQL 8.0 存储例程可以返回结果集吗？

A.4.15\. 存储过程支持 WITH RECOMPILE 吗？

A.4.16\. 是否有 MySQL 等效于在 Apache 上使用 mod_plsql 作为直接与数据库中存储过程通信的网关？

A.4.17\. 我可以将数组作为输入传递给存储过程吗？

A.4.18\. 我可以将游标作为 IN 参数传递给存储过程吗？

A.4.19\. 我可以从存储过程中将游标作为 OUT 参数返回吗？

A.4.20\. 我可以在存储例程中打印变量的值以进行调试吗？

A.4.21\. 我可以在存储过程中提交或回滚事务吗？

A.4.22\. MySQL 8.0 存储过程和函数是否与复制兼容？

A.4.23\. 在复制源服务器上创建的存储过程和函数是否会被复制到副本？

A.4.24\. 存储过程和函数内部发生的操作如何被复制？

A.4.25\. 在使用存储过程和函数与复制一起时是否有特殊的安全要求？

A.4.26\. 复制存储过程和函数操作存在哪些限制？

A.4.27\. 上述限制是否影响 MySQL 进行点时间恢复的能力？

A.4.28\. 正在做什么来纠正上述限制？

| **A.4.1.** | MySQL 8.0 是否支持存储过程和函数？ |
| --- | --- |
|  | 是的。MySQL 8.0 支持两种类型的存储例程，存储过程和存储函数。 |
| **A.4.2.** | 我在哪里可以找到 MySQL 存储过程和存储函数的文档？ |
|  | 请参阅 Section 27.2, “Using Stored Routines”。 |
| **A.4.3.** | 是否有关于 MySQL 存储过程的讨论论坛？ |
|  | 是的。请参阅 [`forums.mysql.com/list.php?98`](https://forums.mysql.com/list.php?98)。 |
| **A.4.4.** | 我在哪里可以找到 ANSI SQL 2003 存储过程的规范？ |
|  | 不幸的是，官方规范并不是免费提供的（ANSI 让它们可以购买）。然而，有一些书籍，比如 Peter Gulutzan 和 Trudy Pelzer 的*SQL-99 Complete, Really*，提供了标准的全面概述，包括存储过程的覆盖范围。 |
| **A.4.5.** | 如何管理存储例程？ |
|  | 对于你的存储例程使用清晰的命名方案始终是一个好习惯。你可以使用 `CREATE [FUNCTION&#124;PROCEDURE]`、`ALTER [FUNCTION&#124;PROCEDURE]`、`DROP [FUNCTION&#124;PROCEDURE]` 和 `SHOW CREATE [FUNCTION&#124;PROCEDURE]` 来管理存储过程。你可以使用 `INFORMATION_SCHEMA` 数据库中的 `ROUTINES` 表来获取有关现有存储过程的信息（参见 Section 28.3.30, “The INFORMATION_SCHEMA ROUTINES Table”）。 |
| **A.4.6.** | 是否有一种方法可以查看给定数据库中的所有存储过程和存储函数？ |

|  | 能。对于名为*`dbname`*的数据库，在`INFORMATION_SCHEMA.ROUTINES`表上使用以下查询：

```sql
SELECT ROUTINE_TYPE, ROUTINE_NAME
    FROM INFORMATION_SCHEMA.ROUTINES
    WHERE ROUTINE_SCHEMA='*dbname*';
```

有关更多信息，请参见第 28.3.30 节，“The INFORMATION_SCHEMA ROUTINES Table”。存储过程的主体可以使用`SHOW CREATE FUNCTION`（用于存储函数）或`SHOW CREATE PROCEDURE`（用于存储过程）来查看。有关更多信息，请参见第 15.7.7.9 节，“SHOW CREATE PROCEDURE Statement”。

| **A.4.7.** | 存储过程存储在哪里？ |
| --- | --- |
|  | 存储过程存储在 `mysql.routines` 和 `mysql.parameters` 表中，这些表是数据字典的一部分。您不能直接访问这些表。而是查询 `INFORMATION_SCHEMA` 的 `ROUTINES` 和 `PARAMETERS` 表。参见第 28.3.30 节，“The INFORMATION_SCHEMA ROUTINES Table”，以及第 28.3.20 节，“The INFORMATION_SCHEMA PARAMETERS Table”。您还可以使用`SHOW CREATE FUNCTION`获取有关存储函数的信息，以及`SHOW CREATE PROCEDURE`获取有关存储过程的信息。有关更多信息，请参见第 15.7.7.9 节，“SHOW CREATE PROCEDURE Statement”。 |
| **A.4.8.** | 是否可以将存储过程或存储函数分组到包中？ |
|  | 不支持在 MySQL 8.0 中。 |
| **A.4.9.** | 存储过程能调用另一个存储过程吗？ |
|  | 是的。 |
| **A.4.10.** | 存储过程能调用触发器吗？ |
|  | 存储过程可以执行导致触发器激活的 SQL 语句，比如`UPDATE`。 |
| **A.4.11.** | 存储过程能访问表吗？ |
|  | 是的。存储过程可以根据需要访问一个或多个表。 |
| **A.4.12.** | 存储过程有用于引发应用程序错误的语句吗？ |
|  | 是的。MySQL 8.0 实现了 SQL 标准的 `SIGNAL` 和 `RESIGNAL` 语句。参见第 15.6.7 节，“条件处理”。 |
| **A.4.13.** | 存储过程提供异常处理吗？ |
|  | MySQL 根据 SQL 标准实现了`HANDLER`定义。详细信息请参见 Section 15.6.7.2, “DECLARE ... HANDLER Statement”。 |
| **A.4.14.** | MySQL 8.0 的存储过程能返回结果集吗？ |
|  | *存储过程*可以，但存储函数不行。如果在存储过程内执行普通的`SELECT`，结果集会直接返回给客户端。你需要使用 MySQL 4.1（或更高版本）的客户端/服务器协议才能实现这一点。这意味着，例如，在 PHP 中，你需要使用`mysqli`扩展而不是旧的`mysql`扩展。 |
| **A.4.15.** | 存储过程支持`WITH RECOMPILE`吗？ |
|  | MySQL 8.0 中不支持。 |
| **A.4.16.** | MySQL 有没有类似于在 Apache 上使用`mod_plsql`作为网关直接与数据库中的存储过程通信的等价项？ |
|  | MySQL 8.0 中没有等价项。 |
| **A.4.17.** | 我能将数组作为输入传递给存储过程吗？ |
|  | MySQL 8.0 中不支持。 |
| **A.4.18.** | 我能将游标作为`IN`参数传递给存储过程吗？ |
|  | 在 MySQL 8.0 中，游标仅在存储过程内部可用。 |
| **A.4.19.** | 我能将游标作为`OUT`参数从存储过程中返回吗？ |
|  | 在 MySQL 8.0 中，游标仅在存储过程内部可用。但是，如果你没有在`SELECT`上打开游标，结果会直接发送给客户端。你也可以使用`SELECT INTO`变量。请参见 Section 15.2.13, “SELECT Statement”。 |
| **A.4.20.** | 我能在存储过��中打印变量的值以进行调试吗？ |
|  | 是的，你可以在*存储过程*中执行此操作，但不能在存储函数中。如果在存储过程内执行普通的`SELECT`，结果集会直接返回给客户端。你必须使用 MySQL 4.1（或更高版本）的客户端/服务器协议才能实现这一点。这意味着，例如，在 PHP 中，你需要使用`mysqli`扩展而不是旧的`mysql`扩展。 |
| **A.4.21.** | 我能在存储过程内提交或回滚事务吗？ |
|  | 是的。但是，你不能在存储函数内执行事务操作。 |
| **A.4.22.** | MySQL 8.0 的存储过程和函数是否与复制兼容？ |
|  | 是的，存储过程和函数中执行的标准操作会从复制源服务器复制到副本。有一些详细描述的限制，请参见 Section 27.7, “Stored Program Binary Logging”。 |
| **A.4.23.** | 在复制源服务器上创建的存储过程和函数是否会被复制到副本？ |
|  | 是的，通过在复制源服务器上使用正常 DDL 语句执行的存储过程和函数的创建会被复制到副本中，以便这些对象存在于两个服务器上。存储过程和函数的`ALTER`和`DROP`语句也会被复制。 |
| **A.4.24.** | 存储过程和函数内部发生的操作如何复制？ |
|  | MySQL 记录存储过程中发生的每个 DML 事件，并将这些单独的操作复制到副本中。执行存储过程的实际调用不会被复制。更改数据的存储函数被记录为函数调用，而不是在每个函数内发生的 DML 事件。 |
| **A.4.25.** | 在复制中使用存储过程和函数是否有特殊的安全要求？ |

|  | 是的。因为副本有权执行从源二进制日志中读取的任何语句，所以在使用存储函数与复制一起时存在特殊的安全约束。如果复制或二进制日志记录一般情况下（用于时点恢复）是活动的，则 MySQL DBA 有两种安全选项可供选择：

1.  任何希望创建存储函数的用户必须被授予`SUPER`权限。

1.  或者，DBA 可以将`log_bin_trust_function_creators`系统变量设置为 1，这样任何拥有标准`CREATE ROUTINE`权限的人都可以创建存储函数。

|

| **A.4.26.** | 复制存储过程和函数操作存在哪些限制？ |
| --- | --- |
|  | 嵌入存储过程中的非确定性（随机）或基于时间的操作可能无法正确复制。由于随机产生的结果本质上是不可预测的，也无法完全复制；因此，在副本上复制的随机操作不会与源上执行的操作相同。声明存储函数为`DETERMINISTIC`或将`log_bin_trust_function_creators`系统变量设置为 0，可以防止随机操作产生随机值。此外，基于时间的操作无法在副本上重现，因为存储过程中此类操作的时间安排无法通过用于复制的二进制日志复制。它仅记录 DML 事件，不考虑时间约束。最后，在进行大规模 DML 操作（如批量插入）时发生错误的非事务表可能会在复制过程中出现问题，因为源可能会因 DML 活动而部分更新，但由于发生的错误，副本不会进行更新。一种解决方法是使用`IGNORE`关键字执行函数的 DML 操作，以便忽略导致错误的源上更新，并将不导致错误的更新复制到副本上。 |
| **A.4.27.** | 前述限制是否影响 MySQL 进行点时间恢复的能力？ |
|  | 影响复制的相同限制也会影响到点时间恢复。 |
| **A.4.28.** | 有什么措施正在采取来纠正上述限制？ |
|  | 您可以选择基于语句的复制或基于行的复制。最初的复制实现是基于基于语句的二进制日志记录的。基于行的二进制日志记录解决了前面提到的限制。还提供了混合复制（通过使用`--binlog-format=mixed`启动服务器）。这种混合形式的复制“知道”是否可以安全地使用基于语句的复制，还是需要基于行的复制。有关更多信息，请参见 Section 19.2.1, “Replication Formats”。 |
