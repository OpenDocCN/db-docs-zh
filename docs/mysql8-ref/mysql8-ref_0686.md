# 12.6 错误消息字符集

> 原文：[`dev.mysql.com/doc/refman/8.0/en/charset-errors.html`](https://dev.mysql.com/doc/refman/8.0/en/charset-errors.html)

本节描述了 MySQL 服务器如何使用字符集构造错误消息。有关错误消息的语言（而不是字符集）的信息，请参见第 12.12 节，“设置错误消息语言”。有关配置错误日志的一般信息，请参见第 7.4.2 节，“错误日志”。

+   错误消息构造的字符集

+   错误消息处置的字符集

### 错误消息构造的字符集

服务器构造错误消息如下：

+   消息模板使用 UTF-8（`utf8mb3`）。

+   消息模板中的参数将被替换为适用于特定错误发生的值：

    +   诸如表或列名的标识符在内部使用 UTF-8，因此它们被直接复制。

    +   字符（非二进制）字符串值从其字符集转换为 UTF-8。

    +   二进制字符串值在范围`0x20`至`0x7E`的字节中被直接复制，对于范围之外的字节则使用`\x`十六进制编码。例如，如果尝试将`0x41CF9F`插入到`VARBINARY`唯一列中导致重复键错误，则生成的错误消息将使用 UTF-8，并对一些字节进行十六进制编码：

        ```sql
        Duplicate entry 'A\xCF\x9F' for key 1
        ```

### 错误消息处置的字符集

一旦构造完成，错误消息可以由服务器写入错误日志或发送给客户端：

+   如果服务器将错误消息写入错误日志，则会按照构造的 UTF-8 格式写入，而不会转换为其他字符集。

+   如果服务器将错误消息发送给客户端程序，则服务器将其从 UTF-8 转换为由`character_set_results`系统变量指定的字符集。如果`character_set_results`的值为`NULL`或`binary`，则不会进行转换。如果变量值为`utf8mb3`或`utf8mb4`，也不会进行转换，因为这些字符集包含了消息构造中使用的所有 UTF-8 字符。

    如果字符无法表示为`character_set_results`中的字符集，则在转换过程中可能会发生一些编码。编码使用 Unicode 代码点值：

    +   基本多语言平面（BMP）范围内的字符（`0x0000`至`0xFFFF`）使用`\*`nnnn`*`表示。

    +   超出 BMP 范围（`0x10000`至`0x10FFFF`）的字符使用`\+*`nnnnnn`*`表示。

    客户端可以设置`character_set_results`来控制他们接收错误消息的字符集。该变量可以直接设置，也可以通过诸如`SET NAMES`等方式间接设置。有关`character_set_results`的更多信息，请参见第 12.4 节，“连接字符集和校对”。
