> 原文：[`dev.mysql.com/doc/refman/8.0/en/clone-plugin-failure-handling.html`](https://dev.mysql.com/doc/refman/8.0/en/clone-plugin-failure-handling.html)

#### 7.6.7.9 远程克隆操作失败处理

本节描述了克隆操作在不同阶段的失败处理。

1.  先决条件被检查（参见远程克隆先决条件）。

    +   如果在先决条件检查期间发生故障，则`CLONE INSTANCE`操作会报告错误。

1.  在 MySQL 8.0.27 之前，在提供方和接收方上备份锁会阻止并发的 DDL 操作。从 MySQL 8.0.27 开始，仅当`clone_block_ddl`变量设置为`ON`时（默认设置为`OFF`）才会阻止提供方上的并发 DDL。参见 Section 7.6.7.4, “Cloning and Concurrent DDL”。

    +   如果克隆操作无法在`clone_ddl_timeout`变量指定的时间限制内获得 DDL 锁，则会报告错误。

1.  用户创建的数据（模式、表、表空间）和接收方上的二进制日志在将数据克隆到接收方数据目录之前被移除。

    +   在远程克隆操作期间从接收方数据目录中移除用户创建的数据和二进制日志时，数据不会被保存，如果发生故障可能会丢失。如果数据很重要，应在启动远程克隆操作之前进行备份。

        为了信息目的，警告会被打印到服务器错误日志中，以指定数据移除何时开始和结束：

        ```sql
        [Warning] [MY-013453] [InnoDB] Clone removing all user data for provisioning:
        Started...

        [Warning] [MY-013453] [InnoDB] Clone removing all user data for provisioning:
        Finished
        ```

        如果在移除数据时发生故障，接收方可能会留下部分在克隆操作之前存在的模式、表和表空间。在执行克隆操作期间或发生故障后的任何时候，服务器始终处于一致状态。

1.  数据从提供方克隆。用户创建的数据、字典元数据和其他系统数据都会被克隆。

    +   如果在克隆数据时发生故障，克隆操作将被回滚并移除所有克隆数据。在此阶段，接收方上先前存在的用户创建的数据和二进制日志也已被移除。

        如果发生这种情况，您可以纠正故障原因并重新执行克隆操作，或放弃克隆操作并从在克隆操作之前进行的备份中恢复接收方数据。

1.  服务器会自动重启（适用于不克隆到命名目录的远程克隆操作）。在启动过程中，会执行典型的服务器启动任务。

    +   如果自动服务器重启失败，您可以手动重启服务器以完成克隆操作。

在 MySQL 8.0.24 之前，如果在克隆操作期间发生网络错误，且在五分钟内解决了错误，则操作会恢复。从 MySQL 8.0.24 开始，如果在捐赠实例上定义的`clone_donor_timeout_after_network_failure`变量指定的时间内解决了错误，则操作会恢复。`clone_donor_timeout_after_network_failure`的默认设置为 5 分钟，但支持 0 到 30 分钟的范围。如果操作未在分配的时间内恢复，则会中止并返回错误，捐赠者会删除快照。将设置为零会导致在发生网络错误时捐赠者立即删除快照。配置更长的超时时间允许更多时间解决网络问题，但也会增加捐赠实例上的增量大小，从而增加克隆恢复时间以及在克隆旨在作为副本或复制组成员时的复制延迟。

在 MySQL 8.0.24 之前，捐赠者线程在监听克隆协议命令时使用 MySQL Server `wait_timeout` 设置。因此，低`wait_timeout`设置可能导致长时间运行的远程克隆操作超时。从 MySQL 8.0.24 开始，克隆空闲超时设置为默认的`wait_timeout`设置，即 28800 秒（8 小时）。
