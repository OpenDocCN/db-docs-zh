# 10.11.5 外部锁定

> 原文：[`dev.mysql.com/doc/refman/8.0/en/external-locking.html`](https://dev.mysql.com/doc/refman/8.0/en/external-locking.html)

外部锁定是通过文件系统锁定来管理多个进程对`MyISAM`数据库表的争用。在单个进程（如 MySQL 服务器）不能被假定为是唯一需要访问表的进程的情况下，会使用外部锁定。以下是一些示例：

+   如果您运行多个使用相同数据库目录（不推荐）的服务器，则每个服务器必须启用外部锁定。

+   如果您使用**myisamchk**对`MyISAM`表执行表维护操作，则必须确保服务器未运行，或者服务器已启用外部锁定，以便根据需要锁定表文件，以便与**myisamchk**协调访问表。对于使用**myisampack**对`MyISAM`表进行打包也是如此。

    如果服务器启用了外部锁定，您可以随时使用**myisamchk**进行读取操作，例如检查表。在这种情况下，如果服务器尝试更新**myisamchk**正在使用的表，服务器会等待**myisamchk**完成后才继续。

    如果您使用**myisamchk**进行写操作，如修复或优化表，或者使用**myisampack**对表进行打包，*必须*始终确保**mysqld**服务器未使用该表。如果不停止**mysqld**，至少在运行**myisamchk**之前执行**mysqladmin flush-tables**。如果服务器和**myisamchk**同时访问表，您的表*可能会损坏*。

在外部锁定生效时，每个需要访问表格的进程在继续访问表格之前会获取表格文件的文件系统锁定。如果无法获取所有必要的锁定，该进程将被阻止访问表格，直到可以获取锁定（在当前持有锁定的进程释放它们后）。

外部锁定会影响服务器性能，因为服务器有时必须等待其他进程才能访问表格。

如果你运行单个服务器来访问给定的数据目录（这是通常情况），并且没有其他程序需要在服务器运行时修改表格，那么外部锁定是不必要的。如果只是用其他程序*读取*表格，那么不需要外部锁定，尽管**myisamchk**在读取表格时，如果服务器更改表格，可能会报告警告。

禁用外部锁定后，要使用**myisamchk**，你必须在**myisamchk**执行时要么停止服务器，要么在运行**myisamchk**之前锁定和刷新表格。为避免此要求，使用`CHECK TABLE`和`REPAIR TABLE`语句来检查和修复`MyISAM`表格。

对于**mysqld**，外部锁定由`skip_external_locking`系统变量的值控制。当启用此变量时，外部锁定被禁用，反之亦然。外部锁定默认情况下被禁用。

可以通过在服务器启动时使用`--external-locking`或`--skip-external-locking`选项来控制外部锁定的使用。

如果使用外部锁定选项来允许多个 MySQL 进程更新`MyISAM`表格，请不要使用带有`ALL`设置的`delay_key_write`系统变量启动服务器，也不要为任何共享表格使用`DELAY_KEY_WRITE=1`表选项。否则，可能会导致索引损坏。

满足这个条件的最简单方法是始终将`--external-locking`与`--delay-key-write=OFF`一起使用。（默认情况下不这样做，因为在许多设置中，拥有前述选项的混合是有用的。）
