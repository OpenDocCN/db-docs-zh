# 7.4.4 二进制日志

> 原文：[`dev.mysql.com/doc/refman/8.0/en/binary-log.html`](https://dev.mysql.com/doc/refman/8.0/en/binary-log.html)

7.4.4.1 二进制日志格式

7.4.4.2 设置二进制日志格式

7.4.4.3 混合二进制日志格式

7.4.4.4 更改 mysql 数据库表的日志格式

7.4.4.5 二进制日志事务压缩

二进制日志包含描述数据库更改的“事件”，例如表创建操作或表数据更改。它还包含可能已经进行更改的语句的事件（例如，一个`DELETE`未匹配任何行），除非使用基于行的日志记录。二进制日志还包含更新数据的每个语句所花费的时间信息。二进制日志有两个重要目的：

+   对于复制，复制源服务器上的二进制日志提供了要发送到副本的数据更改记录。源服务器将其二进制日志中包含的信息发送给其副本，副本会重现这些事务以进行与源服务器上进行的相同数据更改。参见第 19.2 节，“复制实现”。

+   某些数据恢复操作需要使用二进制日志。在备份被恢复后，备份后记录的二进制日志中的事件将被重新执行。这些事件将数据库从备份点更新到最新状态。参见第 9.5 节，“时间点（增量）恢复” Recovery")。

二进制日志不用于诸如`SELECT`或`SHOW`等不修改数据的语句。要记录所有语句（例如，以识别问题查询），请使用一般查询日志。参见第 7.4.3 节，“一般查询日志”。

启用二进制日志记录的服务器运行性能略有下降。然而，二进制日志在启用复制和进行恢复操作方面的好处通常超过了这种轻微的性能降低。

二进制日志对意外停止是有弹性的。只有完整的事件或事务才会被记录或读取回来。

写入二进制日志的语句中的密码由服务器重写，以避免明文出现。另请参见第 8.1.2.3 节，“密码和日志记录”。

从 MySQL 8.0.14 开始，二进制日志文件和中继日志文件可以加密，有助于保护这些文件以及其中可能包含的敏感数据免受外部攻击者的滥用，也免受存储它们的操作系统用户的未经授权查看。 您可以通过将 `binlog_encryption` 系统变量设置为 `ON` 在 MySQL 服务器上启用加密。 有关更多信息，请参见 Section 19.3.2, “加密二进制日志文件和中继日志文件”。

以下讨论描述了一些影响二进制日志记录操作的服务器选项和变量。 完整列表，请参见 Section 19.1.6.4, “二进制日志记录选项和变量”。

二进制日志记录默认启用（`log_bin` 系统变量设置为 ON）。 例外情况是，如果您使用 **mysqld** 手动调用 `--initialize` 或 `--initialize-insecure` 选项初始化数据目录，则默认情况下禁用二进制日志记录，但可以通过指定 `--log-bin` 选项启用。

要禁用二进制日志记录，您可以在启动时指定 `--skip-log-bin` 或 `--disable-log-bin` 选项。 如果指定了其中任何一个选项，并且同时指定了 `--log-bin`，则后面指定的选项优先。

`--log-slave-updates`和`--slave-preserve-commit-order`选项需要进行二进制日志记录。如果禁用二进制日志记录，要么省略这些选项，要么指定`--log-slave-updates=OFF`和`--skip-slave-preserve-commit-order`。当指定`--skip-log-bin`或`--disable-log-bin`时，MySQL 默认禁用这些选项。如果同时指定`--log-slave-updates`或`--slave-preserve-commit-order`和`--skip-log-bin`或`--disable-log-bin`，将发出警告或错误消息。

[`--log-bin[=*`base_name`*]`](replication-options-binary-log.html#option_mysqld_log-bin)选项用于指定二进制日志文件的基本名称。如果不提供`--log-bin`选项，MySQL 将使用`binlog`作为二进制日志文件的默认基本名称。为了与早期版本兼容，如果提供了`--log-bin`选项但没有字符串或为空字符串，则基本名称默认为`*`host_name`*-bin`，使用主机机器的名称。建议您指定一个基本名称，这样如果主机名更改，您可以轻松地继续使用相同的二进制日志文件名称（参见 Section B.3.7, “Known Issues in MySQL”）。如果在日志名称中提供了扩展名（例如，`--log-bin=*`base_name.extension`*`），则扩展名会被静默删除并忽略。

**mysqld**会在二进制日志基本名称后附加一个数字扩展名以生成二进制日志文件名称。每次服务器创建新的日志文件时，该数字会增加，从而创建一个有序的文件系列。每当发生以下事件之一时，服务器都会在系列中创建一个新文件：

+   服务器启动或重新启动

+   服务器会刷新日志。

+   当��日志文件的大小达到`max_binlog_size`设置的大小。

如果使用大型事务，二进制日志文件可能会比`max_binlog_size`设置的大小更大，因为事务会一次性写入文件，而不会在文件之间分割。

为了跟踪已使用的二进制日志文件，**mysqld**还会创建一个包含二进制日志文件名称的二进制日志索引文件。默认情况下，这个文件与二进制日志文件具有相同的基本名称，扩展名为`'.index'`。您可以使用[`--log-bin-index[=*`file_name`*]`](replication-options-binary-log.html#option_mysqld_log-bin-index)选项更改二进制日志索引文件的名称。在**mysqld**运行时不应手动编辑此文件；这样做会使**mysqld**混淆。

术语“二进制日志文件”通常表示包含数据库事件的单个编号文件。术语“二进制日志”集体表示一组编号的二进制日志文件和索引文件。

默认的二进制日志文件和二进制日志索引文件的位置是数据目录。您可以使用`--log-bin`选项来指定另一个位置，只需在基本名称前添加绝对路径名以指定不同的目录。当服务器从二进制日志索引文件中读取条目时（该文件跟踪已使用的二进制日志文件），它会检查条目是否包含相对路径。如果包含相对路径，则使用`--log-bin`选项设置的绝对路径将替换路径的相对部分。在二进制日志索引文件中记录的绝对路径保持不变；在这种情况下，必须手动编辑索引文件以启用新路径或路径的使用。二进制日志文件基本名称和任何指定的路径可作为`log_bin_basename`系统变量使用。

在 MySQL 5.7 中，启用二进制日志记录时必须指定服务器 ID，否则服务器将无法启动。在 MySQL 8.0 中，默认情况下将`server_id`系统变量设置为 1。当启用二进制日志记录时，服务器可以使用此默认 ID 启动，但如果您不使用`server_id`系统变量显式指定服务器 ID，则会发出信息消息。对于用于复制拓扑的服务器，必须为每个服务器指定唯一的非零服务器 ID。

拥有足够权限设置受限会话系统变量的客户端（参见第 7.1.9.1 节，“系统变量权限”）可以通过使用`SET sql_log_bin=OFF`语句禁用自己语句的二进制日志记录。

默认情况下，服务器记录事件的长度以及事件本身，并使用这些信息来验证事件是否正确写入。您还可以通过设置`binlog_checksum`系统变量来导致服务器为事件编写校验和。从二进制日志中读取时，默认情况下源使用事件长度，但可以通过启用系统变量`source_verify_checksum`（从 MySQL 8.0.26 开始）或`master_verify_checksum`（在 MySQL 8.0.26 之前）来使用校验和（如果可用）。副本上的复制 I/O（接收器）线程还会验证从源接收的事件。您可以通过启用系统变量`replica_sql_verify_checksum`（从 MySQL 8.0.26 开始）或`slave_sql_verify_checksum`（在 MySQL 8.0.26 之前）来导致复制 SQL（应用程序）线程在从中继日志读取时使用校验和（如果可用）。

记录在二进制日志中的事件的格式取决于二进制日志格式。支持三种格式类型：基于行的日志记录、基于语句的日志记录和混合基于日志记录。所使用的二进制日志格式取决于 MySQL 版本。有关日志格式的一般描述，请参见 Section 7.4.4.1, “Binary Logging Formats”。有关二进制日志格式的详细信息，请参见 MySQL Internals: The Binary Log。

服务器以与`--replicate-do-db`和`--replicate-ignore-db`选项相同的方式评估`--binlog-do-db`和`--binlog-ignore-db`选项。有关此操作的信息，请参见 Section 19.2.5.1, “Evaluation of Database-Level Replication and Binary Logging Options”。

一个复制品默认启用系统变量`log_replica_updates`（从 MySQL 8.0.26 开始）或`log_slave_updates`（MySQL 8.0.26 之前），这意味着复制品会将从源接收到的任何数据修改写入自己的二进制日志。必须启用二进制日志才能使此设置生效（参见第 19.1.6.3 节，“复制品服务器选项和变量”）。此设置使复制品能够作为其他复制品的源。

您可以使用`RESET MASTER`语句删除所有二进制日志文件，或使用`PURGE BINARY LOGS`删除其中的一部分。请参见第 15.7.8.6 节，“RESET 语句”，以及第 15.4.1.1 节，“PURGE BINARY LOGS 语句”。

如果您正在使用复制，应在确定没有复制品仍然需要使用旧二进制日志文件之前，不要删除源上的旧二进制日志文件。例如，如果您的复制品永远不会落后于三天，那么每天您可以在源上执行**mysqladmin flush-logs binary**，然后删除三天前的任何日志。您可以手动删除文件，但最好使用`PURGE BINARY LOGS`，这也会安全地为您更新二进制日志索引文件（并且可以接受日期参数）。请参见第 15.4.1.1 节，“PURGE BINARY LOGS 语句”。

您可以使用**mysqlbinlog**实用程序显示二进制日志文件的内容。当您想要重新处理日志中的语句以进行恢复操作时，这可能很有用。例如，您可以按以下方式从二进制日志更新 MySQL 服务器：

```sql
$> mysqlbinlog *log_file* | mysql -h *server_name*
```

**mysqlbinlog**还可以用于显示复制品上中继日志文件的内容，因为它们使用与二进制日志文件相同的格式进行编写。有关**mysqlbinlog**实用程序及其使用方法的更多信息，请参见第 6.6.9 节，“mysqlbinlog — 用于处理二进制日志文件的实用���序”。有关二进制日志和恢复操作的更多信息，请参见第 9.5 节，“时间点（增量）恢复”。

二进制日志记录在语句或事务完成后立即进行，但在释放任何锁或执行任何提交之前。这确保了日志按提交顺序记录。

对非事务表的更新会立即存储在二进制日志中。

在未提交的事务中，所有更新（`UPDATE`、`DELETE` 或 `INSERT`）对更改事务表（如 `InnoDB` 表）的操作都会被缓存，直到服务器接收到 `COMMIT` 语句。此时，**mysqld** 在执行 `COMMIT` 之前将整个事务写入二进制日志。

对非事务表的修改无法回滚。如果要回滚的事务包括对非事务表的修改，则整个事务将以 `ROLLBACK` 语句记录，以确保这些表的修改被复制。

当处理事务的线程启动时，它会分配一个大小为 `binlog_cache_size` 的缓冲区来缓冲语句。如果语句大于此值，线程将打开一个临时文件来存储事务。当线程结束时，临时文件将被删除。从 MySQL 8.0.17 开始，如果服务器上启用了二进制日志加密，则临时文件将被加密。

`Binlog_cache_use` 状态变量显示了使用此缓冲区（可能还包括临时文件）存储语句的事务数量。`Binlog_cache_disk_use` 状态变量显示了实际需要使用临时文件的事务数量。这两个变量可用于调整 `binlog_cache_size` 的值，使其足够大，避免使用临时文件。

`max_binlog_cache_size` 系统变量（默认为 4GB，也是最大值）可用于限制用于缓存多语句事务的总大小。如果事务大于此字节数，它将失败并回滚。最小值为 4096。

如果您正在使用二进制日志和基于行的日志记录，`CREATE ... SELECT`或`INSERT ... SELECT`语句中的并发插入将转换为普通插入。这样做是为了确保您可以通过在备份操作期间应用日志来重新创建表的精确副本。如果使用基于语句的日志记录，则原始语句将写入日志。

二进制日志格式存在一些已知限制，可能会影响从备份中恢复。参见第 19.5.1 节，“复制功能和问题”。

存储程序的二进制日志记录如第 27.7 节，“存储程序二进制日志记录”所述。

请注意，由于复制功能的增强，MySQL 8.0 中的二进制日志格式与 MySQL 先前版本不同。请参见第 19.5.2 节，“MySQL 版本之间的复制兼容性”。

如果服务器无法写入二进制日志，刷新二进制日志文件，或将二进制日志同步到磁盘，复制源服务器上的二进制日志可能会变得不一致，副本可能会与源失去同步。`binlog_error_action`系统变量控制在遇到此类错误时采取的操作。

+   默认设置`ABORT_SERVER`使服务器停止二进制日志记录并关闭。此时，您可以识别和纠正错误的原因。在重新启动时，恢复将如同意外服务器停止的情况一样进行（参见第 19.4.2 节，“处理副本意外停止”）。

+   设置`IGNORE_ERROR`提供与旧版本 MySQL 的向后兼容性。使用此设置，服务器将继续进行进行中的事务并记录错误，然后停止二进制日志记录，但继续执行更新。此时，您可以识别和纠正错误的原因。要恢复二进制日志记录，必须重新启用`log_bin`，这需要重新启动服务器。只有在需要向后兼容性，并且二进制日志在此 MySQL 服务器实例上是非必需的情况下才使用此选项。例如，您可能仅将二进制日志用于服务器的间歇性审计或调试，并且不将其用于从服务器复制或依赖于其进行时间点还原操作。

默认情况下，二进制日志在每次写入时都会同步到磁盘（`sync_binlog=1`）。如果未启用`sync_binlog`，并且操作系统或机器（不仅仅是 MySQL 服务器）崩溃，那么二进制日志的最后几条语句可能会丢失。为了防止这种情况发生，启用`sync_binlog`系统变量，以在每个*`N`*提交组后将二进制日志同步到磁盘。参见第 7.1.8 节，“服务器系统变量”。`sync_binlog`的最安全值是 1（默认值），但这也是最慢的。

在早期的 MySQL 版本中，即使将`sync_binlog`设置为 1，如果发生崩溃，表内容和二进制日志内容之间仍可能存在不一致的情况。例如，如果您正在使用`InnoDB`表，并且 MySQL 服务器处理一个`COMMIT`语句，它会按顺序将许多准备好的事务写入二进制日志，同步二进制日志，然后将事务提交到`InnoDB`。如果服务器在这两个操作之间意外退出，`InnoDB`会在重新启动时回滚事务，但事务仍然存在于二进制日志中。在以前的版本中，通过在 XA 事务中启用`InnoDB`支持两阶段提交来解决了这个问题。在 MySQL 8.0 中，`InnoDB`对 XA 事务中的两阶段提交始终是启用的。

`InnoDB`对 XA 事务中的两阶段提交支持确保了二进制日志和`InnoDB`数据文件的同步。然而，MySQL 服务器还应配置为在提交事务之前将二进制日志和`InnoDB`日志同步到磁盘。`InnoDB`日志默认是同步的，而`sync_binlog=1`确保了二进制日志的同步。隐式`InnoDB`对 XA 事务中的两阶段提交支持和`sync_binlog=1`的效果是，在崩溃后重新启动后，在回滚事务后，MySQL 服务器会扫描最新的二进制日志文件以收集事务*`xid`*值，并计算二进制日志文件中的最后有效位置。然后，MySQL 服务器告诉`InnoDB`完成已成功写入二进制日志的任何准备好的事务，并将二进制日志截断到最后的有效位置。这确保了二进制日志反映了`InnoDB`表的确切数据，因此复制品保持与源的同步，因为它不会接收已回滚的语句。

如果 MySQL 服务器在崩溃恢复时发现二进制日志比应该的长度短，那么至少缺少一个成功提交的`InnoDB`事务。如果`sync_binlog=1`，并且磁盘/文件系统在被请求时进行了实际同步（有些不会），那么不应该发生这种情况，因此服务器会打印错误消息`The binary log *`file_name`* is shorter than its expected size`。在这种情况下，此二进制日志不正确，复制应该从源数据的新快照重新启动。

以下系统变量的会话值将被写入二进制日志，并在解析二进制日志时被复制实例所遵守：

+   `sql_mode`（除了`NO_DIR_IN_CREATE`模式不会被复制；参见第 19.5.1.39 节，“复制和变量”）

+   `foreign_key_checks`

+   `unique_checks`

+   `character_set_client`

+   `collation_connection`

+   `collation_database`

+   `collation_server`

+   `sql_auto_is_null`
