> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-features-row-searches.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-features-row-searches.html)

#### 19.5.1.27 复制和行搜索

当使用基于行的复制格式的副本应用`UPDATE`或`DELETE`操作时，必须搜索相关表以查找匹配的行。执行此过程的算法首选使用表的一个索引进行搜索，如果没有合适的索引，则使用哈希表。

算法首先评估表定义中的可用索引，看是否有适合的索引可用，并且如果有多个可能性，哪个索引最适合该操作。算法忽略以下类型的索引：

+   全文索引。

+   隐藏索引。

+   生成的索引。

+   多值索引。

+   任何索引，其中行事件的前图像不包含索引的所有列。

如果在排除这些索引类型后没有合适的索引，则算法不使用索引进行搜索。如果有合适的索引，则从候选索引中选择一个索引，按以下优先顺序选择：

1.  主键。

1.  具有 NOT NULL 属性的索引，其中索引中的每一列都具有 NOT NULL 属性。如果有多个这样的索引可用，则算法选择这些索引中最左边的索引。

1.  任何其他索引。如果有多个这样的索引可用，则算法选择这些索引中最左边的索引。

如果算法能够选择主键或唯一索引，其中索引中的每一列都具有`NOT NULL`属性，则使用该索引来迭代`UPDATE`或`DELETE`操作中的行。对于行事件中的每一行，算法在索引中查找行以定位要更新的表记录。如果找不到匹配记录，则返回错误 ER_KEY_NOT_FOUND 并停止复制应用程序线程。

如果算法无法找到合适的索引，或者只能找到一个非唯一或包含空值的索引，那么将使用哈希表来帮助识别表记录。算法创建一个哈希表，其中包含`UPDATE`或`DELETE`操作中的行，键为行的完整前图像。然后，算法遍历目标表中的所有记录，如果找到索引则使用该索引，否则执行全表扫描。对于目标表中的每条记录，它确定该行是否存在于哈希表中。如果在哈希表中找到该行，则更新目标表中的记录，并从哈希表中删除该行。当检查完目标表中的所有记录后，算法验证哈希表是否为空。如果哈希表中仍有任何未匹配的行，则算法返回错误 ER_KEY_NOT_FOUND 并停止复制应用程序线程。

`slave_rows_search_algorithms`系统变量以前用于控制如何搜索匹配的行。现在不推荐使用这个系统变量，因为默认设置，即使用索引扫描后跟随哈希扫描的方式，对性能最优且在所有场景下都能正常工作。
