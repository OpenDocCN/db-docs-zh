# 25.6.5 执行 NDB Cluster 的滚动重启

> 原文：[`dev.mysql.com/doc/refman/8.0/en/mysql-cluster-rolling-restart.html`](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-rolling-restart.html)

本节讨论如何执行 NDB Cluster 安装的滚动重启，因为它涉及逐个停止和启动（或重启）每个节点，以确保集群本身保持运行。这通常作为滚动升级或滚动降级的一部分进行，其中集群的高可用性是必需的，整个集群不允许停机。在我们提到升级时，这里提供的信息通常也适用于降级。

有许多原因可能希望进行滚动重启。这些原因在接下来的几段中描述。

**配置更改。** 对集群的配置进行更改，例如向集群添加 SQL 节点，或将配置参数设置为新值。

**NDB Cluster 软件升级或降级。** 将集群升级到 NDB Cluster 软件的新版本（或将其降级到旧版本）。这通常被称为“滚动升级”（或“滚动降级”，当恢复到 NDB Cluster 的旧版本时）。

**节点主机更改。** 对运行一个或多个 NDB Cluster 节点进程的硬件或操作系统进行更改。

**系统重置（集群重置）。** 重置集群，因为它已经达到一个不良状态。在这种情况下，通常希望重新加载一个或多个数据节点的数据和元数据。这可以通过以下三种方式之一完成：

+   使用`--initial`选项启动每个数据节点进程（**ndbd**或可能是**ndbmtd**），该选项强制数据节点清除其文件系统，并从其他数据节点重新加载所有 NDB Cluster 数据和元数据。

    从 NDB 8.0.21 开始，这还会强制删除与这些对象相关的所有磁盘数据对象和文件。

+   使用**ndb_mgm**客户端的`START BACKUP`命令创建备份，然后执行重启操作。升级后，使用**ndb_restore**来恢复节点或节点。

    查看 Section 25.6.8, “Online Backup of NDB Cluster”和 Section 25.5.23, “ndb_restore — Restore an NDB Cluster Backup”获取更多信息。

+   使用**mysqldump**在升级之前创建备份；之后，使用`LOAD DATA`来恢复备份。

**资源回收。** 通过连续的`INSERT`和`DELETE`操作释放先前分配给表的内存，以便其他 NDB Cluster 表重复使用。

执行滚动重启的过程可以概括如下：

1.  停止所有集群管理节点（**ndb_mgmd**进程），重新配置它们，然后重新启动它们。 （参见使用多个管理服务器进行滚动重启.）

1.  依次停止、重新配置，然后重新启动每个集群数据节点（**ndbd**进程）。

    通过在前一步骤之后在**ndb_mgm**客户端为每个数据节点发出`RESTART`来更新一些节点配置参数。其他参数要求使用管理客户端`STOP`命令完全停止数据节点，然后通过在系统 shell 中调用适当的**ndbd**或**ndbmtd**")可执行文件来重新启动。 （在大多数 Unix 系统上，也可以使用类似**kill**的 shell 命令来停止数据节点进程，但通常更倾向于使用`STOP`命令，通常更简单。）

    注意

    在 Windows 上，您还可以使用**SC STOP**和**SC START**命令，`NET STOP`和`NET START`命令，或 Windows 服务管理器来停止和启动已安装为 Windows 服务的节点（参见 Section 25.3.2.4, “Installing NDB Cluster Processes as Windows Services”）。

    所需的重启类型在��个节点配置参数的文档中指示。请参阅 Section 25.4.3, “NDB Cluster Configuration Files”。

1.  依次停止、重新配置，然后重新启动每个集群 SQL 节点（**mysqld**进程）。

NDB Cluster 支持一种相对灵活的节点升级顺序。在升级 NDB Cluster 时，您可以在升级管理节点、数据节点或两者之前先升级 API 节点（包括 SQL 节点）。换句话说，您可以按任意顺序升级 API 和 SQL 节点。但需遵守以下规定：

+   此功能仅用于在线升级。不打算也不支持在生产环境中连续长期使用来自不同 NDB Cluster 版本的节点二进制文件的混合。

+   必须在升级任何不同类型节点（管理、数据或 API 节点）之前先升级所有相同类型的节点。无论节点升级顺序如何，这一点始终成立。

+   必须在升级任何数据节点之前升级所有管理节点。无论您以何种顺序升级集群的 API 和 SQL 节点，这一点始终成立。

+   在升级所有管理节点和数据节点之前，不能使用“新”版本特有的功能。

    这也适用于可能适用的任何 MySQL Server 版本更改，除了 NDB 引擎版本更改，因此在规划升级时不要忘记考虑这一点。（这对于一般 NDB Cluster 的在线升级也是适用的。）

任何 API 节点在节点重新启动期间都无法执行模式操作（如数据定义语句）。部分由于此限制，模式操作在在线升级或降级期间也不受支持。此外，在升级或降级进行时也无法执行本地备份。

**使用多个管理服务器进行滚动重启。** 在对具有多个管理节点的 NDB Cluster 执行滚动重启时，应注意**ndb_mgmd**会检查是否有其他管理节点正在运行，并尝试使用该节点的配置数据。为防止这种情况发生，并强制**ndb_mgmd**重新读取其配置文件，请执行以下步骤：

1.  停止所有 NDB Cluster 的**ndb_mgmd**进程。

1.  更新所有`config.ini`文件。

1.  启动一个单独的**ndb_mgmd**，使用所需的`--reload`、`--initial`或两个选项。

1.  如果您使用`--initial`选项启动了第一个**ndb_mgmd**，您还必须使用`--initial`启动任何剩余的**ndb_mgmd**进程。

    无论在启动第一个**ndb_mgmd**时使用了哪些其他选项，您都不应该在第一个使用`--reload`之后启动任何剩余的**ndb_mgmd**进程。

1.  按照正常流程完成数据节点和 API 节点的滚动重启。

在执行滚动重启以更新集群配置时，您可以使用`ndbinfo.nodes`表的`config_generation`列来跟踪哪些数据节点已成功使用新配置重新启动。请参阅 Section 25.6.16.47, “The ndbinfo nodes Table”。
