> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-setup-replicas.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-setup-replicas.html)

#### 19.1.2.6 设置副本

以下各节描述了如何设置副本。在继续之前，请确保您已经：

+   配置了具有必要配置属性的源。请参阅 Section 19.1.2.1, “设置复制源配置”。

+   获取源状态信息，或在数据快照期间关闭时制作源的二进制日志索引文件的副本。请参阅 Section 19.1.2.4, “获取复制源二进制日志坐标”。

+   在源上释放读锁：

    ```sql
    mysql> UNLOCK TABLES;
    ```

+   在副本上编辑了 MySQL 配置。请参阅 Section 19.1.2.2, “设置副本配置”。

接下来的步骤取决于您是否有要导入到副本的现有数据。有关更多信息，请参阅 Section 19.1.2.5, “选择数据快照方法”。选择以下之一：

+   如果没有要导入的数据库快照，请参阅 Section 19.1.2.6.1, “使用新源和副本设置复制”。

+   如果您有要导入的数据库快照，请参阅 Section 19.1.2.6.2, “使用现有数据设置复制”。

##### 19.1.2.6.1 使用新源和副本设置复制

如果没有以前数据库的快照要导入，请配置副本以从新源开始复制。

要在源和新副本之间设置复制：

1.  启动副本。

1.  在副本上执行`CHANGE REPLICATION SOURCE TO` | `CHANGE MASTER TO`语句，设置源配置。请参阅 Section 19.1.2.7, “在副本上设置源配置”。

在每个副本上执行以下副本设置步骤。

如果您正在设置新服务器，但有来自不同服务器的现有数据库转储，想要加载到您的复制配置中，也可以使用此方法。通过将数据加载到新源，数据会自动复制到副本。

如果您正在使用来自不同现有数据库服务器的数据创建新源来设置新的复制环境，请在新源上运行从该服务器生成的转储文件。数据库更新会自动传播到副本：

```sql
$> mysql -h source < fulldb.dump
```

##### 19.1.2.6.2 使用现有数据设置复制

在使用现有数据设置复制时，在开始复制之前，将快照从源传输到副本。将数据导入副本的过程取决于您如何在源上创建数据的快照。

提示

要部署多个 MySQL 实例，您可以使用 InnoDB Cluster，它使您能够轻松管理一组 MySQL 服务器实例在 MySQL Shell 中。InnoDB Cluster 在一个编程环境中封装了 MySQL Group Replication，使您可以轻松部署一组 MySQL 实例以实现高可用性。此外，InnoDB Cluster 与 MySQL Router 无缝接口，使您的应用程序可以连接到集群而无需编写自己的故障转移过程。然而，对于不需要高可用性的类似用例，您可以使用 InnoDB ReplicaSet。有关 MySQL Shell 的安装说明，请参见这里。

注意

如果要复制的复制源服务器或现有副本在创建新副本时有任何计划事件，请确保在启动新副本之前将其禁用。如果新副本上运行的事件已在源上运行，则重复的操作会导致错误。事件调度程序由`event_scheduler`系统变量控制，默认情况下从 MySQL 8.0 开始为`ON`，因此在新副本启动时默认情况下会运行在原始服务器上活动的事件。要停止新副本上的所有事件运行，请将`event_scheduler`系统变量设置为`OFF`或`DISABLED`。或者，您可以使用`ALTER EVENT`语句将单独的事件设置为`DISABLE`或`DISABLE ON SLAVE`以防止它们在新副本上运行。您可以使用`SHOW`语句或信息模式`EVENTS`表列出服务器上的事件。有关更多信息，请参见 Section 19.5.1.16, “Replication of Invoked Features”。

作为在这种方式下创建新副本的替代方案，MySQL Server 的克隆插件可以用于将所有数据和复制设置从现有副本传输到克隆中。有关使用此方法的说明，请参见 Section 7.6.7.7, “复制用于克隆”。

按照以下步骤设置使用现有数据的复制：

1.  如果您使用 MySQL Server 的克隆插件从现有副本创建克隆（参见 Section 7.6.7.7, “复制用于克隆”），则数据已经传输。否则，使用以下方法之一将数据导入到副本中。

    1.  如果您使用了**mysqldump**，启动副本服务器，确保使用`--skip-slave-start`选项或从 MySQL 8.0.24 开始，使用`skip_slave_start`系统变量来防止复制启动。然后导入转储文件：

        ```sql
        $> mysql < fulldb.dump
        ```

    1.  如果您使用原始数据文件创建快照，请将数据文件提取到副本的数据目录中。例如：

        ```sql
        $> tar xvf dbdump.tar
        ```

        您可能需要设置文件的权限和所有权，以便副本服务器可以访问和修改它们。然后启动副本服务器，确保使用`--skip-slave-start`选项或从 MySQL 8.0.24 开始，使用`skip_slave_start`系统变量来防止复制启动。

1.  使用源的复制坐标配置副本。这告诉副本需要开始复制的二进制日志文件和文件内位置。还要使用源的登录凭据和主机名配置副本。有关所需的`CHANGE REPLICATION SOURCE TO` | `CHANGE MASTER TO`语句的更多信息，请参见 Section 19.1.2.7, “在副本上设置源配置”。

1.  通过发出`START REPLICA`（或在 MySQL 8.0.22 之前，`START SLAVE`）语句来启动复制线程。

完成此过程后，副本将连接到源并复制自快照以来在源上发生的任何更新。如果由于任何原因副本无法复制，则会向副本的错误日志发出错误消息。

复制品使用其连接元数据存储库和应用程序元数据存储库中记录的信息来跟踪已处理源二进制日志的数量。从 MySQL 8.0 开始，默认情况下，这些存储库是`mysql`数据库中名为`slave_master_info`和`slave_relay_log_info`的表。除非您确切知道自己在做什么并完全了解其影响，否则*不要*删除或编辑这些表。即使在这种情况下，最好使用`CHANGE REPLICATION SOURCE TO` | `CHANGE MASTER TO`语句来更改复制参数。复制品使用语句中指定的值来自动更新复制元数据存储库。有关更多信息，请参见第 19.2.4 节，“中继日志和复制元数据存储库”。

注意

复制品的连接元数据存储库的内容会覆盖在命令行或`my.cnf`中指定的一些服务器选项。详细信息请参见第 19.1.6 节，“复制和二进制日志选项和变量”。

源的单个快照足以供多个复制品使用。要设置额外的复制品，请使用相同的源快照，并按照刚才描述的复制品部分的步骤进行操作。
