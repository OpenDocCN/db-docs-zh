# 10.3.8 InnoDB 和 MyISAM 索引统计收集

> 原文：[`dev.mysql.com/doc/refman/8.0/en/index-statistics.html`](https://dev.mysql.com/doc/refman/8.0/en/index-statistics.html)

存储引擎收集关于表的统计信息供优化器使用。表统计信息基于值组，其中值组是具有相同键前缀值的行集。对于优化器而言，一个重要的统计量是平均值组大小。

MySQL 使用平均值组大小的方式如下：

+   估计每次`ref`访问必须读取多少行

+   估计部分连接产生多少行，即由形式为的操作产生的行数

    ```sql
    (...) JOIN *tbl_name* ON *tbl_name*.*key* = *expr*
    ```

随着索引的平均值组大小增加，索引对这两个目的的用处减少，因为每次查找的平均行数增加：为了优化目的，最好是每个索引值都针对表中的少量行。当给定的索引值产生大量行时，索引的用处减少，MySQL 不太可能使用它。

平均值组大小与表基数有关，即值组的数量。`SHOW INDEX`语句显示基于*`N/S`*的基数值，其中*`N`*是表中的行数，*`S`*是平均值组大小。该比率产生表中值组的近似数量。

对于基于`<=>`比较运算符的连接，`NULL`与任何其他值没有区别：`NULL <=> NULL`，就像对于任何其他*`N`*，`*`N`* <=> *`N`*`一样。

然而，对于基于`=`运算符的连接，`NULL`与非`NULL`值不同：当*`expr1`*或*`expr2`*（或两者）为`NULL`时，`*`expr1`* = *`expr2`*`不成立。这影响了形式为`*`tbl_name.key`* = *`expr`*`的比较的`ref`访问：如果*`expr`*的当前值为`NULL`，则 MySQL 不访问表，因为比较不可能为真。

对于`=`比较，表中有多少`NULL`值并不重要。为了优化，相关值是非`NULL`值组的平均大小。然而，MySQL 目前不允许收集或使用该平均大小。

对于`InnoDB`和`MyISAM`表，您可以通过`innodb_stats_method`和`myisam_stats_method`系统变量来控制表统计信息的收集。这些变量有三个可能的值，区别如下：

+   当变量设置为`nulls_equal`时，所有`NULL`值被视为相同（即，它们都形成一个单一的值组）。

    如果`NULL`值组大小远高于平均非`NULL`值组大小，这种方法会使平均值组大小向上偏移。这会使索引在优化器看来比实际上对查找非`NULL`值的连接不那么有用。因此，`nulls_equal`方法可能会导致优化器在应该使用索引进行 `ref` 访问时不使用索引。

+   当变量设置为`nulls_unequal`时，`NULL`值不被视为相同。相反，每个`NULL`值形成一个大小为 1 的单独值组。

    如果有许多`NULL`值，这种方法会使平均值组大小向下偏移。如果平均非`NULL`值组大小较大，将每个`NULL`值计为大小为 1 的组会导致优化器高估用于查找非`NULL`值的连接的索引的价值。因此，`nulls_unequal`方法可能会导致优化器在其他方法更好的情况下使用此索引进行 `ref` 查找。

+   当变量设置为`nulls_ignored`时，`NULL`值被忽略。

如果你倾向于使用许多使用`<=>`而不是`=`的连接，`NULL`值在比较中并不特殊，一个`NULL`等于另一个`NULL`。在这种情况下，`nulls_equal`是适当的统计方法。

`innodb_stats_method` 系统变量具有全局值；`myisam_stats_method` 系统变量具有全局值和会话值。设置全局值会影响相应存储引擎的表的统计信息收集。设置会话值仅影响当前客户端连接的统计信息收集。这意味着你可以通过设置 `myisam_stats_method` 的会话值，强制重新生成表的统计信息。

要重新生成`MyISAM`表的统计信息，你可以使用以下任何方法：

+   执行 **myisamchk --stats_method=*`method_name`* --analyze**

+   更改表以使其统计信息过时（例如，插入一行然后删除它），然后设置 `myisam_stats_method` 并发出 `ANALYZE TABLE` 语句

关于使用 `innodb_stats_method` 和 `myisam_stats_method` 的一些建议：

+   您可以强制显式收集表统计信息，就像刚才描述的那样。但是，MySQL 也可能自动收集统计信息。例如，如果在执行表的语句过程中，其中一些语句修改了表，MySQL 可能会收集统计信息。（例如，这可能发生在大量插入或删除，或一些`ALTER TABLE`语句中。）如果发生这种情况，统计信息将使用`innodb_stats_method`或`myisam_stats_method`在那时的任何值进行收集。因此，如果您使用一种方法收集统计信息，但在以后自动收集表统计信息时系统变量设置为另一种方法，则将使用另一种方法。

+   没有办法知道为给定表生成统计信息时使用了哪种方法。

+   这些变量仅适用于`InnoDB`和`MyISAM`表。其他存储引擎只有一种收集表统计信息的方法。通常它更接近`nulls_equal`方法。
