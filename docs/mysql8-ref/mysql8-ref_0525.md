> 原文：[`dev.mysql.com/doc/refman/8.0/en/bnl-bka-optimization.html`](https://dev.mysql.com/doc/refman/8.0/en/bnl-bka-optimization.html)

#### 10.2.1.12 块嵌套循环和批量键访问连接

在 MySQL 中，有一个批量键访问（BKA）连接算法，它同时使用对连接表的索引访问和连接缓冲。BKA 算法支持内连接、外连接和半连接操作，包括嵌套外连接。BKA 的好处包括由于更有效的表扫描而改进的连接性能。此外，之前仅用于内连接的块嵌套循环（BNL）连接算法被扩展，可以用于外连接和半连接操作，包括嵌套外连接。

以下各节讨论了原始 BNL 算法、扩展 BNL 算法和 BKA 算法的基础连接缓冲管理。有关半连接策略的信息，请参见第 10.2.2.1 节，“使用半连接转换优化 IN 和 EXISTS 子查询谓词”

+   用于块嵌套循环和批量键访问算法的连接缓冲管理

+   用于外连接和半连接的块嵌套循环算法

+   批量键访问连接

+   块嵌套循环和批量键访问算法的优化提示

##### 用于块嵌套循环和批量键访问算法的连接缓冲管理

MySQL 可以利用 join 缓冲来执行不仅内连接而且没有对内部表进行索引访问的外连接和半连接，这些连接出现在子查询展开之后。此外，当对内部表进行索引访问时，可以有效地使用 join 缓冲。

join 缓冲管理代码在存储感兴趣的行列的值时，稍微更有效地利用了 join 缓冲空间：如果一个行列的值是`NULL`，则不会为其分配额外的字节，对于`VARCHAR`类型的任何值，都会分配最少数量的字节。

代码支持两种类型的缓冲区，常规和增量。假设使用 join 缓冲`B1`连接表`t1`和`t2`，并且将此操作的结果使用 join 缓冲`B2`连接到表`t3`：

+   一个常规的 join 缓冲包含每个连接操作数的列。如果`B2`是一个常规的 join 缓冲，那么放入`B2`的每一行*r*由来自`B1`的行*r1*的列和来自表`t3`的匹配行*r2*的感兴趣列组成。

+   增量连接缓冲区仅包含由第二个连接操作数产生的表的行的列。也就是说，它是相对于第一个操作数缓冲区的增量。如果 `B2` 是一个增量连接缓冲区，它包含行 *`r2`* 的有趣列以及与 `B1` 中的行 *`r1`* 的链接。

增量连接缓冲区始终相对于较早连接操作的连接缓冲区是增量的，因此第一个连接操作的缓冲区始终是常规缓冲区。在刚才给出的示例中，用于连接表 `t1` 和 `t2` 的缓冲区 `B1` 必须是常规缓冲区。

用于连接操作的增量缓冲区的每一行仅包含要连接的表的行的有趣列。这些列与来自第一个连接操作数产生的表的匹配行的有趣列的引用一起增加。增量缓冲区中的多行可以引用相同的行 *`r`*，其列存储在先前的连接缓冲区中，只要所有这些行都匹配行 *`r`*。

增量缓冲区使得从先前连接操作中使用的缓冲区复制列的频率降低。这样可以节省缓冲区空间，因为在一般情况下，第一个连接操作数产生的行可以与第二个连接操作数产生的多行匹配。从第一个操作数复制一行的多个副本是不必要的。增量缓冲区还通过减少复制时间节省了处理时间。

在 MySQL 8.0 中，`block_nested_loop` 标志的 `optimizer_switch` 系统变量的工作方式如下：

+   在 MySQL 8.0.20 之前，它控制优化器如何使用块嵌套循环连接算法。

+   在 MySQL 8.0.18 及更高版本中，它还控制哈希连接的使用（参见 第 10.2.1.4 节，“哈希连接优化”）。

+   从 MySQL 8.0.20 开始，该标志仅控制哈希连接，不再支持块嵌套循环算法。

`batched_key_access` 标志控制优化器如何使用批量键访问连接算法。

默认情况下，`block_nested_loop` 是 `on`，而 `batched_key_access` 是 `off`。参见 第 10.9.2 节，“可切换优化”。也可以应用优化提示；参见 块嵌套循环和批量键访问算法的优化提示。

有关半连接策略的信息，请参见第 10.2.2.1 节，“使用半连接转换优化 IN 和 EXISTS 子查询谓词”

##### 外连接和半连接的块嵌套循环算法

MySQL BNL 算法的原始实现已扩展以支持外连接和半连接操作（后来被哈希连接算法取代；请参见第 10.2.1.4 节，“哈希连接优化”）。

当这些操作与连接缓冲区一起执行时，放入缓冲区的每一行都附带一个匹配标志。

如果使用连接缓冲区执行外连接操作，则将第二个操作数生成的表的每一行与连接缓冲区中的每一行进行匹配检查。当找到匹配时，将形成一个新的扩展行（原始行加上第二个操作数的列），并发送给剩余的连接操作进行进一步扩展。此外，缓冲区中匹配的行的匹配标志将被启用。在检查完要连接的表的所有行之后，将扫描连接缓冲区。缓冲区中没有启用其匹配标志的每一行都将通过`NULL`补充（第二个操作数的每一列的`NULL`值）进行扩展，并发送给剩余的连接操作进行进一步扩展。

在 MySQL 8.0 中，`block_nested_loop`标志的`optimizer_switch`系统变量的工作方式如下：

+   在 MySQL 8.0.20 之前，它控制优化器如何使用块嵌套循环连接算法。

+   在 MySQL 8.0.18 及更高版本中，它还控制哈希连接的使用（请参见第 10.2.1.4 节，“哈希连接优化”）。

+   从 MySQL 8.0.20 开始，该标志仅控制哈希连接，不再支持块嵌套循环算法。

更多信息，请参见第 10.9.2 节，“可切换的优化”。也可以应用优化器提示；请参见块嵌套循环和批量键访问算法的优化器提示。

在`EXPLAIN`输出中，当`Extra`值包含`Using join buffer (Block Nested Loop)`且`type`值为`ALL`、`index`或`range`时，表示对表使用 BNL。

有关半连接策略的信息，请参见第 10.2.2.1 节，“使用半连接转换优化 IN 和 EXISTS 子查询谓词”

##### 批量键访问连接

MySQL 实现了一种称为批量键访问（BKA）连接算法的表连接方法。当第二个连接操作数产生的表具有索引访问时，可以应用 BKA。与 BNL 连接算法类似，BKA 连接算法使用连接缓冲区累积连接操作的第一个操作数产生的行的有趣列。然后，BKA 算法构建用于访问要连接的表的键，以便为缓冲区中的所有行提交这些键批量给数据库引擎进行索引查找。这些键通过多范围读取（MRR）接口提交给引擎（参见第 10.2.1.11 节，“多范围读取优化”）。提交键后，MRR 引擎函数以最佳方式在索引中执行查找，获取由这些键找到的连接表的行，并开始将匹配行提供给 BKA 连接算法。每个匹配行都与连接缓冲区中的行的引用相对应。

当使用 BKA 时，`join_buffer_size` 的值定义了每次请求到存储引擎的键批量有多大。缓冲区越大，对连接操作的右表进行的顺序访问就越多，这可以显著提高性能。

要使用 BKA，必须将`optimizer_switch` 系统变量的 `batched_key_access` 标志设置为 `on`。BKA 使用 MRR，因此 `mrr` 标志也必须为 `on`。目前，对于 MRR 的成本估算过于悲观。因此，还需要将 `mrr_cost_based` 设置为 `off` 才能使用 BKA。以下设置启用了 BKA：

```sql
mysql> SET optimizer_switch='mrr=on,mrr_cost_based=off,batched_key_access=on';
```

MRR 函数执行有两种情况：

+   第一种情况适用于传统基于磁盘的存储引擎，如`InnoDB`和`MyISAM`。对于这些引擎，通常将连接缓冲区中所有行的键一次性提交给 MRR 接口。引擎特定的 MRR 函数为提交的键执行索引查找，从中获取行 ID（或主键），然后通过 BKA 算法的请求逐个获取所有这些选定行 ID 的行。每行都返回一个关联引用，使得可以访问连接缓冲区中匹配的行。MRR 函数以最佳方式获取行：它们按行 ID（主键）顺序获取。这提高了性能，因为读取是按磁盘顺序而不是随机顺序进行的。

+   第二种情况适用于远程存储引擎，如`NDB`。 MySQL 服务器（SQL 节点）将一部分连接缓冲区中的行的键包以及它们的关联关系发送到 MySQL 集群数据节点。作为回报，SQL 节点接收到一组（或多组）匹配行及其对应的关联关系。BKA 连接算法获取这些行并构建新的连接行。然后一组新的键被发送到数据节点，返回的包中的行被用来构建新的连接行。这个过程持续进行，直到连接缓冲区中的最后一个键被发送到数据节点，并且 SQL 节点已经接收并连接了所有与这些键匹配的行。这提高了性能，因为 SQL 节点发送给数据节点的带键包数量较少，意味着在 SQL 节点和数据节点之间执行连接操作的往返次数较少。

在第一种情况下，连接缓冲区的一部分被保留用于存储通过索引查找选择的行 ID（主键），并作为参数传递给 MRR 函数。

没有专门的缓冲区用于存储从连接缓冲区构建的键。相反，构建下一个缓冲区中行的键的函数被作为参数传递给 MRR 函数。

在`EXPLAIN`输出中，当`Extra`值包含`Using join buffer (Batched Key Access)`，并且`type`值为`ref`或`eq_ref`时，表示对表使用了 BKA。

##### 用于块嵌套循环和批量键访问算法的优化器提示

除了使用`optimizer_switch`系统变量来控制全局会话中优化器使用 BNL 和 BKA 算法外，MySQL 还支持优化器提示来影响每个语句的优化器。请参阅第 10.9.3 节，“优化器提示”。

要使用 BNL 或 BKA 提示为外连接的任何内部表启用连接缓冲，必须为外连接的所有内部表启用连接缓冲。
