# 17.6.6 撤销日志

> 原文：[`dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html`](https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-logs.html)

撤销日志是与单个读写事务关联的撤销日志记录集合。撤销日志记录包含有关如何撤消事务对聚簇索引记录的最新更改的信息。如果另一个事务需要在一致性读操作的一部分中查看原始数据，则从撤销日志记录中检索未修改的数据。撤销日志存在于撤销日志段中，这些段包含在回滚段中。回滚段驻留在撤销表空间和全局临时表空间中。

驻留在全局临时表空间中的撤销日志用于修改用户定义临时表中的数据的事务。这些撤销日志不会被重做记录，因为它们不需要用于崩溃恢复。它们仅在服务器运行时用于回滚。这种类型的撤销日志通过避免重做日志 I/O 来提高性能。

有关撤销日志的数据静态加密信息，请参阅撤销日志加密。

每个撤销表空间和全局临时表空间分别支持最多 128 个回滚段。`innodb_rollback_segments`变量定义了回滚段的数量。

回滚段支持的事务数量取决于回滚段中的撤销槽数量以及每个事务所需的撤销日志数量。回滚段中的撤销槽数量根据`InnoDB`页面大小而异。

| InnoDB 页面大小 | 回滚段中的撤销槽数量（InnoDB 页面大小 / 16） |
| --- | --- |
| `4096 (4KB)` | `256` |
| `8192 (8KB)` | `512` |
| `16384 (16KB)` | `1024` |
| `32768 (32KB)` | `2048` |
| `65536 (64KB)` | `4096` |

每个事务分配最多四个撤销日志，分别用于以下每种操作类型：

1.  用户定义表上的`INSERT`操作

1.  用户定义表上的`UPDATE`和`DELETE`操作

1.  用户定义临时表上的`INSERT`操作

1.  用户定义临时表上的`UPDATE`和`DELETE`操作

撤销日志根据需要分配。例如，对常规表和临时表执行`INSERT`、`UPDATE`和`DELETE`操作的事务需要完整分配四个撤销日志。只对常规表执行`INSERT`操作的事务需要一个撤销日志。

在常规表上执行操作的事务从分配的撤销表空间回滚段中分配撤销日志。在临时表上执行操作的事务从分配的全局临时表空间回滚段中分配撤销日志。

一个分配给事务的撤销日志将一直附加到该事务，直到其结束。例如，分配给常规表上的`INSERT`操作的事务的撤销日志将用于该事务执行的所有常规表上的`INSERT`操作。

鉴于上述因素，可以使用以下公式来估计`InnoDB`能够支持的并发读写事务数量。

注意

在达到`InnoDB`能够支持的并发读写事务数量之前，可能会遇到并发事务限制错误。当分配给事务的回滚段用完撤销槽时会发生这种情况。在这种情况下，请尝试重新运行事务。

当事务在临时表上执行操作时，`InnoDB`能够支持的并发读写事务数量受限于分配给全局临时表空间的回滚段数量，默认为 128。

+   如果每个事务执行`INSERT` **或** `UPDATE`或`DELETE`操作，`InnoDB`能够支持的并发读写事务数量为：

    ```sql
    (innodb_page_size / 16) * innodb_rollback_segments * number of undo tablespaces
    ```

+   如果每个事务执行`INSERT` **和** `UPDATE`或`DELETE`操作，`InnoDB`能够支持的并发读写事务数量为：

    ```sql
    (innodb_page_size / 16 / 2) * innodb_rollback_segments * number of undo tablespaces
    ```

+   如果每个事务在临时表上执行`INSERT`操作，`InnoDB`能够支持的并发读写事务数量为：

    ```sql
    (innodb_page_size / 16) * innodb_rollback_segments
    ```

+   如果每个事务在临时表上执行`INSERT` **和** `UPDATE`或`DELETE`操作，`InnoDB`能够支持的并发读写事务数量为：

    ```sql
    (innodb_page_size / 16 / 2) * innodb_rollback_segments
    ```
