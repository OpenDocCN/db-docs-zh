# 19.4.10 半同步复制

> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-semisync.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.html)

19.4.10.1 安装半同步复制

19.4.10.2 配置半同步复制

19.4.10.3 半同步复制监视

除了内置的异步复制外，MySQL 8.0 还支持由插件实现的半同步复制接口。本节讨论了什么是半同步复制以及它是如何工作的。接下来的章节将涵盖半同步复制的管理接口以及如何安装、配置和监视它。

MySQL 默认情况下是异步复制。源将事件写入其二进制日志，副本在准备好时请求这些事件。源不知道副本是否何时检索和处理事务，并且不能保证任何事件是否会到达任何副本。使用异步复制时，如果源崩溃，它已经提交的事务可能尚未传输至任何副本。在这种情况下，从源切换到副本可能导致切换到相对于源缺少事务的服务器。

使用完全同步复制时，当源提交事务时，所有副本在源返回执行事务的会话之前也已经提交了该事务。完全同步复制意味着可以随时从源切换到任何副本。完全同步复制的缺点是可能会有很多延迟来完成一个事务。

半同步复制介于异步和完全同步复制之间。源会等待至少一个副本接收并记录事件（所需副本数量可配置），然后提交事务。源不会等待所有副本确认接收，并且只需要副本的确认，而不需要事件在副本端完全执行和提交。因此，半同步复制保证了如果源崩溃，它已经提交的所有事务都已传输至至少一个副本。

与异步复制相比，半同步复制提供了改进的数据完整性，因为当提交成功返回时，可以知道数据至少存在于两个地方。在半同步源接收到所需数量的副本的确认之前，事务会被暂停并且不会被提交。

与完全同步复制相比，半同步复制更快，因为它可以配置以平衡数据完整性要求（确认接收事务的副本数量）与提交速度之间的要求，由于需要等待副本，提交速度较慢。

重要提示

使用半同步复制，如果源崩溃并进行故障转移到副本，则失败的源不应重新用作复制源，并应丢弃。它可能有一些事务尚未被任何副本确认，因此在故障转移之前未提交。

如果您的目标是实现一个容错的复制拓扑结构，其中所有服务器以相同顺序接收相同的事务，并且崩溃的服务器可以重新加入组并自动更新，您可以使用组复制来实现这一目标。有关详细信息，请参见第二十章，*组复制*。

与异步复制相比，半同步复制的性能影响是为了增加数据完整性而进行的权衡。减速的量至少是将提交发送到副本并等待副本确认接收的 TCP/IP 往返时间。这意味着半同步复制最适合在快速网络上通信的近距离服务器，并且对于在慢速网络上通信的远程服务器最不利。半同步复制还通过限制二进制日志事件从源到副本发送的速度来对繁忙会话进行速率限制。当一个用户太忙时，这会减慢速度，在某些部署情况下可能会很有用。

源和其副本之间的半同步复制操作如下：

+   当副本连接到源时，副本指示其是否支持半同步。

+   如果在源端启用了半同步复制并且至少有一个半同步副本，则在源上执行事务提交的线程将被阻塞，并等待至少一个半同步副本确认已接收到该事务的所有事件，或者直到超时发生。

+   副本仅在将事件写入其中继日志并刷新到磁盘后才确认接收到事务的事件。

+   如果超时发生而没有任何副本确认事务，则源将恢复为异步复制。当至少一个半同步副本赶上时，源将恢复为半同步复制。

+   必须在源端和副本端启用半同步复制。如果在源端禁用了半同步复制，或者在源端启用了半同步复制但没有在任何副本上启用，则源将使用异步复制。

当源正在阻塞（等待来自副本的确认）时，它不会返回到执行事务的会话。当阻塞结束时，源会返回到会话，然后可以继续执行其他语句。此时，在源端事务已经提交，并且至少一个副本已经确认接收到其事件。源在返回到会话之前必须接收每个事务的副本确认数量是可配置的，默认为一个确认（参见 Section 19.4.10.2, “Configuring Semisynchronous Replication”）。

阻塞也会发生在写入二进制日志的回滚之后，这种情况发生在回滚修改非事务表的事务时。即使对于事务表来说回滚的事务没有影响，但对于非事务表的修改无法回滚，必须发送到副本中，因此回滚的事务会被记录。

对于不在事务上下文中发生的语句（也就是说，没有使用`START TRANSACTION`或`SET autocommit = 0`启动事务时），自动提交被启用，每个语句都会隐式提交。在半同步复制中，源会为每个这样的语句阻塞，就像为显式事务提交一样。

默认情况下，源在将二进制日志同步到磁盘后等待副本确认事务接收，但在将事务提交到存储引擎之前。作为替代方案，您可以配置源，使其在将事务提交到存储引擎后等待副本确认，使用`rpl_semi_sync_source_wait_point`或`rpl_semi_sync_master_wait_point`系统变量。此设置会影响复制特性和客户端在源端可以看到的数据。有关更多信息，请参见 Section 19.4.10.2, “Configuring Semisynchronous Replication”。

从 MySQL 8.0.23 开始，您可以通过启用系统变量`replication_sender_observe_commit_only`和`replication_optimize_for_static_plugin_config`来提高半同步复制的性能，前者限制回调，后者添加共享锁并避免不必要的锁获取。这些设置在副本数量增加时非常有帮助，因为锁争用可能会降低性能。半同步复制源服务器还可以通过启用这些系统变量获得性能优势，因为它们使用与副本相同的锁定机制。
