# 19.5.3 升级复制拓扑

> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-upgrade.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-upgrade.html)

当您升级参与复制拓扑的服务器时，您需要考虑每个服务器在拓扑中的角色，并注意与复制相关的问题。有关升级 MySQL 服务器实例的一般信息和说明，请参阅第三章，*升级 MySQL*。

如第 19.5.2 节，“MySQL 版本之间的复制兼容性”中所解释的，MySQL 支持从运行一个发布系列的源到运行下一个更高发布系列的副本的复制，但不支持从运行较新发布的源到运行较早发布的副本的复制。较早发布的副本可能没有处理源在较新发布中可以处理的事务所需的能力。因此，在升级源服务器到目标发布之前，您必须将复制拓扑中的所有副本升级到目标 MySQL 服务器版本。这样，您永远不会出现仍在较早发布的副本尝试处理来自较新发布源的事务的情况。

在存在多个源（多源复制）的复制拓扑中，不支持使用两个以上的 MySQL 服务器版本，无论源或副本 MySQL 服务器的数量如何。此限制不仅适用于发布系列，还适用于同一发布系列中的版本号。例如，在这样的设置中，您不能同时使用 MySQL 8.0.22、MySQL 8.0.24 和 MySQL 8.0.28，尽管您可以同时使用这些版本中的任意两个。

如果您需要降级复制拓扑中的服务器，则必须在降级副本之前降级源。在副本上，您必须确保二进制日志和中继日志已完全处理，并在继续降级之前将其删除。

#### 发行版之间的行为变化

虽然这个升级顺序是正确的，但在从一个尚未升级的早期版本源复制到一个已经升级的后续版本副本时，仍然可能遇到复制困难。如果源使用了在副本上安装的后续版本中不再支持的语句或依赖行为，这种情况可能发生。您可以使用 MySQL Shell 的升级检查工具`util.checkForServerUpgrade()`来检查 MySQL 5.7 服务器实例或 MySQL 8.0 服务器实例是否可以升级到 GA MySQL 8.0 版本。该工具识别需要修复的任何内容，以确保在升级后不会出现问题，包括在后续版本中不再可用的功能和行为。有关升级检查工具的信息，请参见升级检查工具。

如果您正在将现有的 MySQL 版本不支持全局事务标识符（GTID）的复制设置升级到支持 GTID 的版本，则只有在确保设置符合基于 GTID 的复制的所有要求时，才在源和副本上启用 GTID。有关将基于二进制日志文件位置的复制设置转换为使用基于 GTID 的复制的信息，请参见 Section 19.1.3.4, “Setting Up Replication Using GTIDs”。

在严格 SQL 模式下（`STRICT_TRANS_TABLES`或`STRICT_ALL_TABLES`）影响操作的更改可能导致升级后副本的复制失败。如果使用基于语句的日志记录（`binlog_format=STATEMENT`），如果副本在源之前升级，源执行的语句在那里成功，但在副本上可能失败，从而导致复制停止。为了解决这个问题，停止源上的所有新语句，并等待副本赶上，然后升级副本。或者，如果无法停止新语句，暂时在源上切换到基于行的日志记录（`binlog_format=ROW`），并等待所有副本处理到达此更改点之前产生的所有二进制日志，然后升级副本。

默认字符集从`latin1`更改为`utf8mb4`在 MySQL 8.0 中。在复制设置中，当从 MySQL 5.7 升级到 8.0 时，建议在升级之前将默认字符集更改回 MySQL 5.7 中使用的字符集。升级完成后，可以将默认字符集更改为`utf8mb4`。假设之前使用了默认设置，保留它们的一种方法是在`my.cnf`文件中使用以下行启动服务器：

```sql
[mysqld]
character_set_server=latin1
collation_server=latin1_swedish_ci
```

#### 标准升级程序

要升级复制拓扑，请按照第三章“*升级 MySQL*”中的说明为每个单独的 MySQL 服务器实例执行此整体过程：

1.  首先升级副本。在每个副本实例上：

    +   执行第 3.6 节“准备升级安装”中描述的初步检查和步骤。

    +   关闭 MySQL 服务器。

    +   升级 MySQL 服务器二进制文件或软件包。

    +   重新启动 MySQL 服务器。

    +   如果您已升级到早于 MySQL 8.0.16 的版本，请手动调用**mysql_upgrade**来升级系统表和模式。当服务器以全局事务标识符（GTIDs）启用时（`gtid_mode=ON`），不要通过**mysql_upgrade**启用二进制日志记录（因此不要使用`--write-binlog`选项）。然后关闭并重新启动服务器。

    +   如果您已升级到 MySQL 8.0.16 或更高版本，请不要调用**mysql_upgrade**。从该版本开始，MySQL 服务器将执行整个 MySQL 升级过程，在升级过程中禁用二进制日志记录。

    +   使用`START REPLICA`或`START SLAVE`语句重新启动复制。

1.  当所有副本都已升级时，按照相同步骤升级和重新启动源服务器，但不包括`START REPLICA`或`START SLAVE`语句。如果您对基于行的日志记录或默认字符集进行了临时更改，现在可以恢复更改。

#### 使用表修复或重建的升级过程

在从一个 MySQL 系列移动到下一个系列时，某些升级可能需要您删除并重新创建数据库对象。例如，排序规则更改可能需要重建表索引。如果需要这样的操作，则在第 3.5 节“MySQL 8.0 中的更改”中有详细说明。最安全的做法是在副本和源上分别执行这些操作，并禁用从源到副本的这些操作的复制。为此，请使用以下过程：

1.  停止所有复制实例并升级二进制文件或软件包。使用`--skip-slave-start`选项或从 MySQL 8.0.24 开始，使用`skip_slave_start`系统变量重新启动它们，以便它们不连接到源。执行任何需要重新创建数据库对象的表修复或重建操作，例如使用`REPAIR TABLE`或`ALTER TABLE`，或者转储和重新加载表或触发器。

1.  在源上禁用二进制日志。要在不重新启动源的情况下执行此操作，请执行`SET sql_log_bin = OFF`语句。或者，停止源并使用`--skip-log-bin`选项重新启动它。如果重新启动源，则可能还希望禁止客户端连接。例如，如果所有客户端都使用 TCP/IP 连接，请在重新启动源时启用`skip_networking`系统变量。

1.  禁用二进制日志后，执行任何需要重新创建数据库对象的表修复或重建操作。在此步骤中必须禁用二进制日志，以防止这些操作被记录并稍后发送到复制实例。

1.  在源上重新启用二进制日志。如果之前将`sql_log_bin`设置为`OFF`，则执行`SET sql_log_bin = ON`语句。如果重新启动源以禁用二进制日志，请在不使用`--skip-log-bin`的情况下重新启动，并且不启用`skip_networking`系统变量，以便客户端和复制实例可以连接。

1.  重新启动复制实例，这次不使用`--skip-slave-start`选项或`skip_slave_start`系统变量。
