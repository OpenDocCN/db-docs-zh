> 原文：[`dev.mysql.com/doc/refman/8.0/en/replication-features-triggers.html`](https://dev.mysql.com/doc/refman/8.0/en/replication-features-triggers.html)

#### 19.5.1.36 复制和触发器

在基于语句的复制中，源上执行的触发器也会在副本上执行。在基于行的复制中，源上执行的触发器不会在副本上执行。相反，源上由触发器执行导致的行更改会被复制并应用到副本上。

这种行为是有意设计的。如果在基于行的复制下，副本服务器应用触发器以及由它们引起的行更改，那么实际上更改会在副本上应用两次，导致源和副本上的数据不同。

如果希望触发器在源和副本上都执行，可能是因为源和副本上有不同的触发器，则必须使用基于语句的复制。然而，为了启用副本端触发器，不必完全使用基于语句的复制。只需在希望产生此效果的语句上切换到基于语句的复制即可，其余时间继续使用基于行的复制。

调用导致对`AUTO_INCREMENT`列进行更新的触发器（或函数）的语句在使用基于语句的复制时无法正确复制。MySQL 8.0 将这类语句标记为不安全。（Bug #45677）

触发器可以针对不同的触发事件组合（`INSERT`、`UPDATE`、`DELETE`）和动作时间（`BEFORE`、`AFTER`）拥有触发器，并且允许多个触发器。

为简洁起见，“多个触发器”在这里是“具有相同触发事件和动作时间的多个触发器”的简称。

**升级。** 早于 MySQL 5.7 版本不支持多个触发器。如果在使用早于 MySQL 5.7 的版本的复制拓扑中升级服务器，请先升级副本，然后再升级源。如果升级后的复制源服务器仍有使用不支持多个触发器的 MySQL 版本的旧副本，那么如果在源上为已经具有相同触发事件和动作时间的触发器的表创建触发器，则在这些副本上会出现错误。

**降级。** 如果将支持多个触发器的服务器降级到不支持多个触发器的旧版本，降级会产生以下影响：

+   对于具有触发器的每个表，所有触发器定义都在该表的`.TRG`文件中。然而，如果存在具有相同触发事件和动作时间的多个触发器，当触发事件发生时，服务器只会执行其中一个。有关`.TRG`文件的信息，请参阅 MySQL 服务器 Doxygen 文档中的表触发器存储部分，网址为`dev.mysql.com/doc/index-other.html`。

+   如果在降级后添加或删除表的触发器，则服务器会重写表的`.TRG`文件。重写后的文件仅保留每个触发器事件和动作时间组合中的一个触发器；其他触发器将丢失。

为避免这些问题，在降级之前修改您的触发器。对于每个表，如果每个触发器事件和动作时间组合中有多个触发器，请将每组触发器转换为单个触发器，方法如下：

1.  对于每个触发器，创建一个包含触发器中所有代码的存储过程。使用`NEW`和`OLD`访问的值可以通过参数传递给存储过程。如果触发器需要代码中的单个结果值，可以将代码放入存储函数中，并让函数返回该值。如果触发器需要代码中的多个结果值，可以将代码放入存储过程中，并使用`OUT`参数返回这些值。

1.  删除表的所有触发器。

1.  为表创建一个新的触发器，调用刚刚创建的存储过程。因此，这个触发器的效果与它替代的多个触发器相同。
