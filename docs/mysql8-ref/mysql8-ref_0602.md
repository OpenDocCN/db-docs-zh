# 10.9.1 控制查询计划评估

> 原文：[`dev.mysql.com/doc/refman/8.0/en/controlling-query-plan-evaluation.html`](https://dev.mysql.com/doc/refman/8.0/en/controlling-query-plan-evaluation.html)

查询优化器的任务是找到执行 SQL 查询的最佳计划。因为“好”和“坏”计划之间的性能差异可能是数量级的（即秒与小时甚至天），大多数查询优化器，包括 MySQL 的优化器，在所有可能的查询评估计划中执行更多或更少的详尽搜索以找到最佳计划。对于连接查询，MySQL 优化器研究的可能计划数量随查询中引用的表的数量呈指数增长。对于少量表（通常少于 7 到 10 个），这不是问题。然而，当提交较大的查询时，查询优化所花费的时间很容易成为服务器性能的主要瓶颈。

一种更灵活的查询优化方法使用户能够控制优化器在寻找最佳查询评估计划时的详尽程度。一般的想法是，优化器研究的计划越少，编译查询所花费的时间就越少。另一方面，因为优化器跳过了一些计划，它可能会错过找到最佳计划的机会。

优化器关于评估计划数量的行为可以通过两个系统变量进行控制：

+   `optimizer_prune_level` 变量告诉优化器根据每个表访问的行数的估计跳过某些计划。我们的经验表明，这种“有根据的猜测”很少会错过最佳计划，并且可能显著减少查询编译时间。这就是为什么默认情况下此选项为开启状态（`optimizer_prune_level=1`）。然而，如果您认为优化器错过了更好的查询计划，可以关闭此选项（`optimizer_prune_level=0`），但这样做可能会导致查询编译时间更长。请注意，即使使用了这种启发式方法，优化器仍然会探索大致指数数量的计划。

+   `optimizer_search_depth`变量告诉优化器应该查看每个不完整计划的“未来”多远，以评估是否应进一步扩展。较小的`optimizer_search_depth`值可能导致查询编译时间减少数个数量级。例如，具有 12、13 或更多表的查询如果`optimizer_search_depth`接近查询中的表数，可能需要几小时甚至几天才能编译。同时，如果使用`optimizer_search_depth`等于 3 或 4 进行编译，优化器可能在不到一分钟内为相同的查询编译完成。如果您不确定`optimizer_search_depth`的合理值是多少，可以将此变量设置为 0，告诉优化器自动确定该值。
