# 25.6.4 NDB 集群启动阶段摘要

> 原文：[`dev.mysql.com/doc/refman/8.0/en/mysql-cluster-start-phases.html`](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-start-phases.html)

本节提供了 NDB 集群数据节点启动时涉及的步骤的简化概述。更完整的信息可以在 NDB 集群启动阶段中找到，*`NDB`内部指南*中。

这些阶段与管理客户端中`*`node_id`* STATUS`命令输出中报告的相同（请参见第 25.6.1 节，“NDB 集群管理客户端中的命令”）。这些启动阶段也在`ndbinfo.nodes`表的`start_phase`列中报告。

**启动类型。** 有几种不同的启动类型和模式，如下列表所示：

+   **初始启动。** 集群在所有数据节点上都有一个干净的文件系统启动。这要么是当集群第一次启动时发生，要么是当所有数据节点使用`--initial`选项重新启动时发生。

    注意

    使用`--initial`重新启动节点时，磁盘数据文件不会被删除。

+   **系统重新启动。** 集群启动并读取存储在数据节点中的数据。当集群在使用后关闭后，希望集群从离开的地方恢复操作时发生。

+   **节点重新启动。** 这是在集群本身正在运行时对集群节点进行在线重新启动。

+   **初始节点重新启动。** 这与节点重新启动相同，只是节点被重新初始化并以干净的文件系统启动。

**设置和初始化（阶段-1）。** 在启动之前，每个数据节点（**ndbd**进程）必须被初始化。初始化包括以下步骤：

1.  获取节点 ID

1.  获取配置数据

1.  为节点间通信分配端口

1.  根据配置文件中的设置分配内存

当数据节点或 SQL 节点首次连接到管理节点时，它会保留一个集群节点 ID。为了确保没有其他节点分配相同的节点 ID，此 ID 将保留，直到节点成功连接到集群并至少一个**ndbd**报告此节点已连接。此节点 ID 的保留由问题节点与**ndb_mgmd**之间的连接保护。

在每个数据节点初始化后，集群启动过程可以继续进行。集群在此过程中经历的阶段如下：

+   **第 0 阶段。** `NDBFS` 和 `NDBCNTR` 块启动。对于使用 `--initial` 选项启动的数据节点，这些数据节点的文件系统会被清除。

+   **第 1 阶段。** 在此阶段，所有剩余的 `NDB` 内核块启动。建立 NDB 集群连接，建立块间通信，并启动心跳。在节点重新启动的情况下，还会检查 API 节点连接。

    注意

    当一个或多个节点在第 1 阶段挂起，而其余节点在第 2 阶段挂起时，通常表示存在网络问题。造成此类问题的一个可能原因是一个或多个集群主机具有多个网络接口。导致此条件的问题的另一个常见来源是阻止集群节点之间通信所需的 TCP/IP 端口。在后一种情况下，这通常是由于防火墙配置错误造成的。

+   **第 2 阶段。** `NDBCNTR` 内核块检查所有现有节点的状态。选择主节点，并初始化集群模式文件。

+   **第 3 阶段。** `DBLQH` 和 `DBTC` 内核块之间建立通信。确定启动类型；如果这是一个重新启动，`DBDIH` 块获得执行重新启动的权限。

+   **第 4 阶段。** 对于初始启动或初始节点重新启动，会创建重做日志文件。这些文件的数量等于 `NoOfFragmentLogFiles`。

    对于系统重新启动：

    +   读取模式或模式。

    +   从本地检查点读取数据。

    +   应用所有重做信息，直到达到最新可恢复的全局检查点。

    对于节点重新启动，找到重做日志的尾部。

+   **第 5 阶段。** 数据节点启动的大部分与数据库相关的工作在此阶段完成。对于初始启动或系统重新启动，会执行本地检查点，然后是全局检查点。在此阶段开始定期检查内存使用情况，并执行任何必要的节点接管。

+   **第 6 阶段。** 在此阶段，定义并设置节点组。

+   **第 7 阶段。** 选择仲裁节点并开始运行。设置下一个备份 ID，以及备份磁盘写入速度。达到此启动阶段���节点被标记为`已启动`。现在 API 节点（包括 SQL 节点）可以连接到集群。

+   **第 8 阶段。** 如果这是系统重新启动，所有索引都将被重建（由`DBDIH`）。

+   **第 9 阶段。** 节点内部启动变量被重置。

+   **第 100 阶段（已过时）。** 以前，在节点重新启动或初始节点重新启动期间，API 节点可以连接到节点并开始接收事件。目前，此阶段为空。

+   **第 101 阶段。** 在节点重新启动或初始节点重新启动期间，事件传递被移交给加入集群的节点。新加入的节点负责将其主要数据传递给订阅者。这个阶段也被称为`SUMA`移交阶段。

初始启动或系统重新启动完成后，事务处理被启用。对于节点重新启动或初始节点重新启动，启动过程的完成意味着节点现在可以充当事务协调器。
