> 原文：[`dev.mysql.com/doc/refman/8.0/en/mysql-cluster-shm-definition.html`](https://dev.mysql.com/doc/refman/8.0/en/mysql-cluster-shm-definition.html)

#### 25.4.3.12 NDB 集群共享内存连接

NDB 集群节点之间的通信通常使用 TCP/IP 处理。共享内存（SHM）传输器的特点是通过在内存中写入信号而不是在套接字上传输来区分。共享内存传输器（SHM）可以在将 API 节点（通常是 SQL 节点）和数据节点一起运行在同一主机上时，通过消除 TCP 连接所需的高达 20% 的开销来提高性能。您可以通过以下两种方式之一启用共享内存连接：

+   通过将数据节点配置参数 `UseShm` 设置为 `1`，并将数据节点的 `HostName` 和 API 节点的 `HostName` 设置为相同值。

+   通过在集群配置文件中使用包含 `NodeId1` 和 `NodeId2` 设置的 `[shm]` 部分。稍后在本节中将更详细地描述这种方法。

假设一个集群在同一主机计算机上运行具有节点 ID 1 的数据节点和具有节点 ID 51 的 SQL 节点，IP 地址为 10.0.0.1\. 要在这两个节点之间启用 SHM 连接，只需确保集群配置文件中包含以下条目：

```sql
[ndbd]
NodeId=1
HostName=10.0.0.1
UseShm=1

[mysqld]
NodeId=51
HostName=10.0.0.1
```

重要提示

刚刚显示的两个条目是在集群中需要的任何其他条目和参数设置之外的。稍后在本节中将展示一个更完整的示例。

在启动使用 SHM 连接的数据节点之前，还需要确保托管此类数据节点的每台计算机的操作系统为共享内存段分配了足够的内存。有关此信息，请参阅您操作平台的文档。在每个运行数据节点和 API 节点的多个主机的设置中，可以通过在配置文件的 `[ndbd default]` 部分中设置 `UseShm` 来在所有这些主机上启用共享内存。稍后在本节中将展示示例。

虽然不是严格要求，但可以通过在集群配置（`config.ini`）文件的 `[shm default]` 部分中设置以下一个或多个参数来调整集群中所有 SHM 连接：

+   `ShmSize`：共享内存大小

+   `ShmSpinTime`：在休眠之前旋转的时间（以微秒为单位）

+   `SendBufferMemory`：从此节点发送的信号的缓冲区大小，以字节为单位。

+   `SendSignalId`：表示每个通过传输器发送的信号中都包含信号 ID。

+   `Checksum`：表示每个通过传输器发送的信号中都包含校验和。

+   `PreSendChecksum`：在发送信号之前进行校验和检查；此功能也需要启用校验和。

这个例子展示了在多个主机上定义的 SHM 连接的简单设置，在一个使用 3 台计算机列出的 NDB 集群中，托管了所示节点类型的主机名：

1.  `10.0.0.0`：管理服务器

1.  `10.0.0.1`：一个数据节点和一个 SQL 节点

1.  `10.0.0.2`：一个数据节点和一个 SQL 节点

在这种情况下，每个数据节点使用 TCP 传输器与管理服务器和其他数据节点通信；每个 SQL 节点使用共享内存传输器与本地数据节点通信，并使用 TCP 传输器与远程数据节点通信。反映此设置的基本配置由 config.ini 文件启用，其内容如下所示：

```sql
[ndbd default]
DataDir=*/path/to/datadir*
UseShm=1

[shm default]
ShmSize=8M
ShmSpintime=200
SendBufferMemory=4M

[tcp default]
SendBufferMemory=8M

[ndb_mgmd]
NodeId=49
Hostname=10.0.0.0
DataDir=*/path/to/datadir*

[ndbd]
NodeId=1
Hostname=10.0.0.1
DataDir=*/path/to/datadir*

[ndbd]
NodeId=2
Hostname=10.0.0.2
DataDir=*/path/to/datadir*

[mysqld]
NodeId=51
Hostname=10.0.0.1

[mysqld]
NodeId=52
Hostname=10.0.0.2

[api]
[api]
```

影响所有共享内存传输器的参数在 `[shm default]` 部分设置；这些可以在一个或多个 `[shm]` 部分中按连接覆盖。每个这样的部分必须使用 `NodeId1` 和 `NodeId2` 关联给定 SHM 连接的节点 ID；也可以使用 `HostName1` 和 `HostName2` 通过主机名标识节点，但这些参数不是必需的。

对于未设置主机名的 API 节点，使用 TCP 传输器与数据节点通信，独立于它们启动的主机；配置文件中 `[tcp default]` 部分设置的参数和值适用于集群中的所有 TCP 传输器。

为了获得最佳性能，您可以为 SHM 传输器定义一个自旋时间（`ShmSpinTime` 参数）；这会影响数据节点接收线程和 `NDB` 中的轮询所有者（接收线程或用户线程）。

+   `Checksum`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 布尔型 |
    | 默认 | true |
    | 范围 | true, false |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    这个参数是一个布尔型（`Y`/`N`）参数，默认情况下是禁用的。启用后，在将消息放入发送缓冲区之前会计算所有消息的校验和。

    此功能可防止消息在等待发送缓冲区时被损坏。它还可用作在传输过程中检查数据是否被损坏的检查。

+   `组`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 无符号 |
    | 默认值 | 35 |
    | 范围 | 0 - 200 |
    | 重启类型 | **节点重启：** 需要进行滚动重启（NDB 8.0.13） |

    确定组的接近程度；较小的值被解释为更接近。默认值对大多数情况足够。

+   `HostName1`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 名称或 IP 地址 |
    | 默认值 | [...] |
    | 范围 | ... |
    | 重启类型 | **节点重启：** 需要进行滚动重启（NDB 8.0.13） |

    `HostName1`和`HostName2`参数可用于指定用于两个节点之间给定 SHM 连接的特定网络接口。这些参数的值可以是主机名或 IP 地址。

+   `HostName2`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 名称或 IP 地址 |
    | 默认值 | [...] |
    | 范围 | ... |
    | 重启类型 | **节点重启：** 需要进行滚动重启（NDB 8.0.13） |

    `HostName1`和`HostName2`参数可用于指定用于两个节点之间给定 SHM 连接的特定网络接口。这些参数的值可以是主机名或 IP 地址。

+   `NodeId1`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 数字 |
    | 默认值 | [无] |
    | 范围 | 1 - 255 |
    | 重启类型 | **节点重启：** 需要进行滚动重启（NDB 8.0.13） |

    要识别两个节点之间的连接，需要为每个节点提供节点标识符，如`NodeId1`和`NodeId2`。

+   `NodeId2`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 数字 |
    | 默认值 | [无] |
    | 范围 | 1 - 255 |
    | 重启类型 | **节点重启：** 需要进行滚动重启（NDB 8.0.13） |

    要识别两个节点之间的连接，需要为每个节点提供节点标识符，如`NodeId1`和`NodeId2`。

+   `NodeIdServer`

    | 版本（或更高版本） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 数字 |
    | 默认值 | [无] |
    | 范围 | 1 - 63 |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    识别共享内存连接的服务器端。默认情况下，这是数据节点的节点 ID。

+   `OverloadLimit`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字节 |
    | 默认值 | 0 |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    当发送缓冲区中有超过这么多未发送字节时，连接被视为过载。有关更多信息，请参阅第 25.4.3.14 节，“配置 NDB 集群发送缓冲区参数”和第 25.6.16.65 节，“ndbinfo transporters 表”。

+   `PreSendChecksum`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 布尔值 |
    | 默认值 | false |
    | 范围 | 真，假 |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    如果启用此参数和`Checksum`，则执行预发送校验和检查所有节点之间的所有 SHM 信号是否存在错误。如果未启用`Checksum`，则不起作用。

+   `SendBufferMemory`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 整数 |
    | 默认值 | 2M |
    | 范围 | 256K - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    从此节点使用共享内存连接发送的信号的共享内存缓冲区大小（以字节为单位）。

+   `SendSignalId`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 布尔值 |
    | 默认值 | false |
    | 范围 | 真，假 |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    为了追踪分布式消息的路径，需要为每个消息提供唯一标识符。将此参数设置为`Y`会导致这些消息 ID 也通过网络传输。此功能在生产构建中默认禁用，在`-debug`构建中启用。

+   `ShmKey`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 无符号 |
    | 默认值 | 0 |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    在设置共享内存段时，使用一个表示为整数的节点 ID 来唯一标识用于通信的共享内存段。没有默认值。如果启用了`UseShm`，则共享内存键会由`NDB`自动计算。

+   `ShmSize`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 字节 |
    | 默认 | 4M |
    | 范围 | 64K - 4294967039 (0xFFFFFEFF) |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    每个 SHM 连接都有一个共享内存段，发送者将消息放入其中，读者从中读取消息。该段的大小由`ShmSize`定义。默认值为 4MB。

+   `ShmSpinTime`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 整数 |
    | 默认 | 0 |
    | 范围 | 0 - 2000 |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    接收时，等待睡眠之前的时间，单位为微秒。

+   `SigNum`

    | 版本（或更高） | NDB 8.0.13 |
    | --- | --- |
    | 类型或单位 | 无符号 |
    | 默认 | [...] |
    | 范围 | 0 - 4294967039 (0xFFFFFEFF) |
    | 已弃用 | 是（在 NDB 7.6 中） |
    | 重启类型 | **节点重启：** 需要进行滚动重启。 (NDB 8.0.13) |

    此参数以前用于覆盖操作系统信号编号；在 NDB 8.0 中不再使用，对其进行的任何设置都将被忽略。

**重启类型。** 本节参数描述中使用的重启类型信息如下表所示：

**表 25.22 NDB 集群重启类型**

| 符号 | 重启类型 | 描述 |
| --- | --- | --- |
| N | 节点 | 可以使用滚动重启更新该参数（参见第 25.6.5 节，“执行 NDB 集群的滚动重启”） |
| S | 系统 | 必须完全关闭所有集群节点，然后重新启动，以更改此参数 |
| I | 初始 | 数据节点必须使用`--initial`选项重新启动 |
