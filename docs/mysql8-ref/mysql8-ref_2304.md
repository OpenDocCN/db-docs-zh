> 原文：[`dev.mysql.com/doc/refman/8.0/en/gone-away.html`](https://dev.mysql.com/doc/refman/8.0/en/gone-away.html)

#### B.3.2.7 MySQL 服务器已断开连接

本节还涵盖了相关的`在查询期间与服务器的连接丢失`错误。

`MySQL 服务器已断开连接`错误最常见的原因是服务器超时并关闭了连接。在这种情况下，通常会收到以下错误代码之一（您收到的错误代码取决于操作系统）。

| 错误代码 | 描述 |
| --- | --- |
| `CR_SERVER_GONE_ERROR` | 客户端无法向服务器发送问题。 |
| `CR_SERVER_LOST` | 客户端在向服务器写入时没有收到错误，但没有得到完整的答案（或任何答案）。 |

默认情况下，如果没有任何操作发生，服务器在八小时后会关闭连接。您可以通过在启动**mysqld**时设置`wait_timeout`变量来更改时间限制。请参见第 7.1.8 节，“服务器系统变量”。

如果您有一个脚本，只需再次发出查询以使客户端进行自动重新连接。这假定您已在客户端启用了自动重新连接（这是`mysql`命令行客户端的默认设置）。

`MySQL 服务器已断开连接`错误的一些其他常见原因是：

+   您（或数据库管理员）已使用`KILL`语句或**mysqladmin kill**命令终止了正在运行的线程。

+   在关闭与服务器的连接后尝试运行查询。这表明应用程序中存在逻辑错误，应该进行更正。

+   在不同主机上运行的客户端应用程序没有连接到该主机的 MySQL 服务器所需的权限。

+   您在客户端端从 TCP/IP 连接中获得了超时。如果您一直在使用命令：`mysql_options(..., MYSQL_OPT_READ_TIMEOUT,...)`或`mysql_options(..., MYSQL_OPT_WRITE_TIMEOUT,...)`，则可能会发生这种情况。在这种情况下，增加超时时间可能有助于解决问题。

+   您在服务器端遇到了超时，并且客户端中的自动重新连接已禁用（`MYSQL`结构中的`reconnect`标志等于 0）。

+   您正在使用 Windows 客户端，而在发出命令之前服务器已经断开连接（可能是因为`wait_timeout`已过期）。

    在 Windows 上的问题是，在某些情况下，MySQL 在向服务器的 TCP/IP 连接写入时未从操作系统那里收到错误，而是在尝试从连接中读取答案时收到错误。

    解决方法是，如果距上次查询已经很长时间，则在连接上执行`mysql_ping()`（这是 Connector/ODBC 所做的）或将**mysqld**服务器上的`wait_timeout`设置得非常高，以至于实际上永远不会超时。

+   如果向服务器发送的查询不正确或太大，也可能会出现这些错误。如果**mysqld**收到一个太大或乱序的数据包，它会假设客户端出现问题并关闭连接。如果需要大型查询（例如，如果您使用大型`BLOB`列），可以通过设置服务器的`max_allowed_packet`变量来增加查询限制，其默认值为 64MB。您可能还需要增加客户端端的最大数据包大小。有关设置数据包大小的更多信息，请参阅第 B.3.2.8 节，“数据包过大”。

    插入大量行的`INSERT`或`REPLACE`语句也可能导致这些错误。这两个语句中的任一个都会向服务器发送一个请求，而不管要插入的行数如何；因此，通过减少每个`INSERT`或`REPLACE`发送的行数，通常可以避免错误。

+   如果主机名查找失败（例如，您的服务器或网络依赖的 DNS 服务器崩溃），也可能出现此错误。这是因为 MySQL 依赖主机系统进行名称解析，但无法知道它是否正常工作——从 MySQL 的角度来看，问题与任何其他网络超时问题无法区分。

    如果使用`skip_networking`系统变量启用 MySQL 启动，则可能还会看到`MySQL 服务器已断开连接`错误。

    另一个可能导致此错误的网络问题是，如果您的防火墙阻止了 MySQL 端口（默认为 3306），从而完全阻止了与 MySQL 服务器的任何连接。

+   您还可能遇到这个错误，如果应用程序 fork 子进程，所有这些进程都尝试使用与 MySQL 服务器相同的连接。可以通过为每个子进程使用单独的连接来避免这种情况。

+   在执行查询时服务器崩溃时，您可能会遇到一个错误。

您可以通过执行**mysqladmin version**并检查服务器的正常运行时间来检查 MySQL 服务器是否已崩溃并重新启动。如果客户端连接中断是因为**mysqld**崩溃并重新启动，您应该集中精力找出崩溃原因。首先检查再次发出查询是否再次导致服务器崩溃。请参阅第 B.3.3.3 节，“如果 MySQL 一直崩溃该怎么办”。

您可以通过将`log_error_verbosity`系统变量设置为 3 来启动**mysqld**以获取有关丢失连接的更多信息。这会将一些断开连接的消息记录在`hostname.err`文件中。请参阅第 7.4.2 节，“错误日志”。

如果您想就此问题创建一个错误报告，请确保包含以下信息：

+   指示 MySQL 服务器是否已崩溃。您可以在服务器错误日志中找到有关此信息的信息。请参阅第 B.3.3.3 节，“如果 MySQL 一直崩溃该怎么办”。

+   如果特定查询导致**mysqld**崩溃，并且在运行查询之前已经使用`CHECK TABLE`检查了涉及的表，您能提供一个可重现的测试案例吗？请参阅第 7.9 节，“调试 MySQL”。

+   MySQL 服务器中`wait_timeout`系统变量的值是多少？(**mysqladmin variables**可以为您提供此变量的值。)

+   您是否尝试启用常规查询日志来运行**mysqld**，以确定问题查询是否出现在日志中？(参见第 7.4.3 节，“常规查询日志”。)

另请参阅第 B.3.2.9 节，“通信错误和中止连接”和第 1.5 节，“如何报告错误或问题”。
