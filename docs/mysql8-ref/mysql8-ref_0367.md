# 8.2.7 访问控制，第 2 阶段：请求验证

> 原文：[`dev.mysql.com/doc/refman/8.0/en/request-access.html`](https://dev.mysql.com/doc/refman/8.0/en/request-access.html)

服务器接受连接后，进入访问控制的第 2 阶段。对于通过连接发出的每个请求，服务器确定您要执行的操作，然后检查您的权限是否足够。这是授予权限表中的权限列发挥作用的地方。这些权限可以来自`user`、`global_grants`、`db`、`tables_priv`、`columns_priv`或`procs_priv`表。（您可能会发现参考第 8.2.3 节，“授予权限表”有所帮助，该节列出了每个授予权限表中存在的列。）

`user`和`global_grants`表授予全局权限。这些表中的行针对给定帐户指示适用于全局基础的帐户权限，无论默认数据库是什么。例如，如果`user`表授予您`DELETE`权限，您可以在服务器主机上的任何数据库中删除行。明智的做法是仅向需要这些权限的人授予`user`表中的权限，例如数据库管理员。对于其他用户，将`user`表中的所有权限设置为`'N'`，并仅在更具体的级别（特定数据库、表、列或例程）上授予权限。还可以全局授予数据库权限，但使用部分撤销来限制它们在特定数据库上的执行（参见第 8.2.12 节，“使用部分撤销限制权限”）。

`db`表授予特定数据库的权限。此表的范围列中的值可以采用以下形式：

+   空白的`User`值匹配匿名用户。非空值字面匹配；用户名称中没有通配符。

+   通配符字符`%`和`_`可以在`Host`和`Db`列中使用。这些字符的含义与使用`LIKE`运算符执行的模式匹配操作相同。如果要在授予权限时使用这两个字符，必须使用反斜杠进行转义。例如，要将下划线字符(`_`)包含在数据库名称中，请在`GRANT`语句中指定为`\_`。

+   `'%'`或空白的`Host`值表示“任何主机”。

+   空白的`Db`值或`%`表示“任何数据库”。

服务器将`db`表读入内存并同时对其进行排序，同时读取`user`表。服务器根据`Host`、`Db`和`User`范围列对`db`表进行排序。与`user`表一样，排序将最具体的值放在最前面，最不具体的值放在最后，当服务器查找匹配行时，它使用找到的第一个匹配项。

`tables_priv`、`columns_priv`和`procs_priv`表授予特定于表、特定于列和特定于例程的权限。这些表的作用域列中的值可以采用以下形式：

+   通配符字符`%`和`_`可以在`Host`列中使用。这些与使用`LIKE`运算符执行的模式匹配操作具有相同的含义。

+   一个`'%'`或空白的`Host`值表示“任何主机”。

+   `Db`、`Table_name`、`Column_name`和`Routine_name`列不能包含通配符或为空。

服务器根据`Host`、`Db`和`User`列对`tables_priv`、`columns_priv`和`procs_priv`表进行排序。这类似于`db`表的排序，但更简单，因为只有`Host`列可以包含通配符。

服务器使用排序后的表来验证收到的每个请求。对于需要管理员权限的请求，如`SHUTDOWN`或`RELOAD`，服务器仅检查`user`和`global_privilege`表，因为这些是唯一指定管理员权限的表。如果这些表中的帐户行允许请求的操作，则授予访问权限；否则拒绝访问。例如，如果您想执行**mysqladmin shutdown**，但您的`user`表行没有授予您`SHUTDOWN`权限，服务器会拒绝访问，甚至不会检查`db`表。（后者表中不包含`Shutdown_priv`列，因此无需检查它。）

对于与数据库相关的请求（`INSERT`、`UPDATE`等），服务器首先检查`user`表行中的用户全局权限（减去部分撤销所施加的权限限制）。如果行允许请求的操作，则授予访问权限。如果`user`表中的全局权限不足，则服务器从`db`表中确定用户的数据库特定权限：

+   服务器在`db`表中查找与`Host`、`Db`和`User`列匹配的内容。

+   `Host`和`User`列与连接用户的主机名和 MySQL 用户名匹配。

+   `Db`列与用户想要访问的数据库匹配。

+   如果`Host`和`User`没有对应的行，则拒绝访问。

在确定由`db`表行授予的特定于数据库的权限后，服务器将其添加到由`user`表授予的全局权限中。如果结果允许请求的操作，则授予访问权限。否则，服务器将逐个检查`tables_priv`和`columns_priv`表中的用户表和列权限，将它们添加到用户的权限中，并根据结果允许或拒绝访问。对于存储过程操作，服务器使用`procs_priv`表而不是`tables_priv`和`columns_priv`。

用布尔术语表达，关于如何计算用户权限的前述描述可以总结如下：

```sql
global privileges
OR database privileges
OR table privileges
OR column privileges
OR routine privileges
```

如果发现全局权限最初不足以执行请求的操作，为什么服务器会在后来将这些权限添加到数据库、表和列权限中可能并不明显。原因在于一个请求可能需要多种类型的权限。例如，如果执行`INSERT INTO ... SELECT`语句，您需要`INSERT`和`SELECT`权限。您的权限可能是`user`表行全局授予一个权限，而`db`表行专门为相关数据库授予另一个权限。在这种情况下，您具有执行请求所需的权限，但服务器无法仅从您的全局或数据库权限中判断出来。它必须根据综合权限做出访问控制决定。
