> 译文：[`dev.mysql.com/doc/refman/8.0/en/ndb-restore-to-different-version.html`](https://dev.mysql.com/doc/refman/8.0/en/ndb-restore-to-different-version.html)

#### 25.5.23.1 将 NDB 备份还原到不同版本的 NDB 集群

以下两个部分提供了有关将本机 NDB 备份还原到与备份所在版本不同的 NDB 集群版本的信息。

此外，您应该参考第 25.3.7 节，“升级和降级 NDB 集群”，了解尝试将 NDB 备份还原到运行不同版本 NDB 软件的集群时可能遇到的其他问题。

此外，建议查看 What is New in NDB Cluster 8.0 以及第 3.5 节，“MySQL 8.0 中的更改”，了解 NDB 8.0 与 NDB 集群以前版本之间的其他变化，这些变化可能与您的特定情况相关。

##### 25.5.23.1.1 将 NDB 备份还原到较旧版本的 NDB 集群

当尝试将从较新版本的 NDB 集群中获取的备份还原到较旧版本时，可能会遇到问题，原因是使用了在较早版本中不存在的功能。以下列出了一些问题：

+   **utf8mb4_ai_ci 字符集。** NDB 8.0 中默认使用`utf8mb4_ai_ci`字符集创建的表，在 NDB 7.6 及更早版本中不可用，因此无法被这些较早版本中的**ndb_restore**二进制文件读取。在这种情况下，必须修改任何使用`utf8mb4_ai_ci`的表，以便它们使用较旧版本支持的字符集进行备份前的操作。

+   **表元数据格式。** 由于 MySQL 服务器和 NDB 处理表元数据的方式发生了变化，使用 NDB 8.0 中包含的 MySQL 服务器二进制文件创建或更改的表无法使用**ndb_restore**还原到 NDB 7.6 或更早版本的 NDB 集群。这些表使用`.sdi`文件，较旧版本的**mysqld**无法理解。

    一个在 NDB 8.0 中备份的表，该表在 NDB 7.6 或更早版本中创建，并且自升级到 NDB 8.0 以来未被修改，应该可以恢复到较旧版本的 NDB 集群。

    由于可以分别恢复元数据和表数据，因此在这种情况下，您可以使用**mysqldump**制作的转储文件恢复表模式，或者手动执行必要的`CREATE TABLE`语句，然后仅使用**ndb_restore**和`--restore-data`选项导入表数据。

+   **多线程备份。** 在 NDB 8.0 中进行的多线程备份可以通过以下两种方式之一还原到运行较早版本`NDB`的集群中：

    +   使用 NDB 8.0 中的**ndb_restore**二进制文件执行并行还原。参见第 25.5.23.3.1 节，“并行还原并行备份”。

    +   串行还原备份；在这种情况下，不需要较新版本的**ndb_restore**。请参见第 25.5.23.3.2 节，“串行还原并行备份”。

+   **加密备份。** 在 NDB 8.0.22 及更高版本中创建的加密备份无法使用 NDB 8.0.21 或更早版本的**ndb_restore**进行还原。

+   **NDB_STORED_USER 权限。** `NDB_STORED_USER`权限仅在 NDB 8.0 中受支持。

+   **数据节点的最大数量。** NDB Cluster 8.0 支持最多 144 个数据节点，而较早版本仅支持最多 48 个数据节点。有关此不兼容性引起问题的情况，请参见第 25.5.23.2.1 节，“还原到少于原始节点数”。

##### 25.5.23.1.2 将 NDB 备份还原到较新版本的 NDB Cluster

一般来说，应该可以将使用 **ndb_mgm** 客户端的 `START BACKUP` 命令创建的备份从旧版本的 NDB 恢复到新版本，只要你使用新版本附带的 **ndb_restore** 二进制文件即可。（可能可以使用旧版本的 **ndb_restore**，但不建议这样做。）其他潜在问题列在这里：

+   在从备份中恢复元数据时（`--restore-meta` 选项），**ndb_restore** 通常会尝试精确复制备份时的表模式。

    在 NDB 8.0 之前的版本中创建的表使用 `.frm` 文件存储它们的元数据。这些文件可以被 **mysqld** 在 NDB 8.0 中读取，mysqld 可以使用其中包含的信息来创建后续版本中 MySQL 数据字典使用的 `.sdi` 文件。

+   在将旧备份恢复到新版本的 NDB 时，可能无法利用新功能，如 hashmap 分区、更多的 hashmap 桶、读取备份和不同的分区布局。因此，最好使用 **mysqldump** 和 **mysql** 客户端来恢复旧模式，这样 NDB 就可以利用新的模式功能。

+   使用旧的时间类型且不支持小数秒（用于 MySQL 5.6.4 之前和 NDB 7.3.31 之前）的表无法使用 **ndb_restore** 恢复到 NDB 8.0。您可以使用 `CHECK TABLE` 检查这样的表，然后在 **mysql** 客户端中使用 `REPAIR TABLE` 必要时将其升级到新的时间列格式；这必须在进行备份之前完成。有关更多信息，请参见 Section 3.6, “Preparing Your Installation for Upgrade”。

    您还可以使用使用 **mysqldump** 创建的转储来恢复这样的表。

+   在 NDB 7.6 及更早版本中创建的分布式授权表在 NDB 8.0 中不受支持。这些表可以恢复到 NDB 8.0 集群，但对访问控制没有影响。
