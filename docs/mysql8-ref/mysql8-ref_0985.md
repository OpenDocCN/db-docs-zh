> 原文：[`dev.mysql.com/doc/refman/8.0/en/xa-restrictions.html`](https://dev.mysql.com/doc/refman/8.0/en/xa-restrictions.html)

#### 15.3.8.3 XA 事务的限制

XA 事务支持仅限于`InnoDB`存储引擎。

对于“外部 XA”，一个 MySQL 服务器充当资源管理器，客户端程序充当事务管理器。对于“内部 XA”，MySQL 服务器内的存储引擎充当 RMs，服务器本身充当 TM。内部 XA 支持受到各个存储引擎能力的限制。处理涉及多个存储引擎的 XA 事务需要内部 XA。实现内部 XA 要求存储引擎在表处理程序级别支持两阶段提交，目前只有`InnoDB`符合这一要求。

对于`XA START`，识别`JOIN`和`RESUME`子句但不起作用。

对于`XA END`，识别`SUSPEND [FOR MIGRATE]`子句但不起作用。

要求`xid`值的*bqual*部分在全局事务中的每个 XA 事务中不同是当前 MySQL XA 实现的限制。这不是 XA 规范的一部分。

XA 事务分两部分写入二进制日志。当发出`XA PREPARE`时，事务的第一部分直到`XA PREPARE`使用初始 GTID 写入。`XA_prepare_log_event`用于在二进制日志中标识这类事务。当发出`XA COMMIT`或`XA ROLLBACK`时，包含仅`XA COMMIT`或`XA ROLLBACK`语句的事务的第二部分使用第二个 GTID 写入。请注意，由`XA_prepare_log_event`标识的事务的初始部分不一定会跟随其`XA COMMIT`或`XA ROLLBACK`，这可能导致任意两个 XA 事务的二进制日志交错记录。XA 事务的两部分甚至可以出现在不同的二进制日志文件中。这意味着处于`PREPARED`状态的 XA 事务现在持久存在，直到发出显式的`XA COMMIT`或`XA ROLLBACK`语句，确保 XA 事务与复制兼容。

在副本上，在 XA 事务准备完成后，它会从复制应用程序线程中分离，并可以由副本上的任何线程提交或回滚。这意味着相同的 XA 事务可以在不同线程上以不同状态出现在`events_transactions_current`表中。`events_transactions_current`表显示线程上最近监视的事务事件的当前状态，并在线程空闲时不更新此状态。因此，即使在被另一个线程处理后，XA 事务仍可能以`PREPARED`状态显示在原始应用程序线程中。要明确识别仍处于`PREPARED`状态且需要恢复的 XA 事务，请使用`XA RECOVER`语句，而不是性能模式事务表。

使用 XA 事务存在以下限制：

+   在 MySQL 8.0.30 之前，XA 事务在意外停机时对于二进制日志不是完全具有弹性。如果在服务器正在执行`XA PREPARE`、`XA COMMIT`、`XA ROLLBACK`或`XA COMMIT ... ONE PHASE`语句时发生意外停机，服务器可能无法恢复到正确状态，导致服务器和二进制日志处于不一致状态。在这种情况下，二进制日志可能包含未应用的额外 XA 事务，或者缺少已应用的 XA 事务。此外，如果启用了 GTIDs，在恢复后，`@@GLOBAL.GTID_EXECUTED`可能无法正确描述已应用的事务。请注意，如果在`XA PREPARE`之前、在`XA PREPARE`和`XA COMMIT`（或`XA ROLLBACK`）之间，或在`XA COMMIT`（或`XA ROLLBACK`）之后发生意外停机，则服务器和二进制日志将正确恢复并处于一致状态。

    从 MySQL 8.0.30 开始，这不再是一个问题；服务器将`XA PREPARE`实现为一个两阶段操作，它在存储引擎和服务器之间维护准备操作的状态，并在存储引擎和二进制日志之间强制执行执行顺序，以便在服务器节点上的状态在一致和持久之前不进行广播。

    请注意，当使用相同的事务 XID 依次执行 XA 事务并且在处理 `XA COMMIT ... ONE PHASE` 过程中发生中断时，可能无法再同步二进制日志和存储引擎之间的状态。如果在此事务在存储引擎中准备后发生了刚描述的一系列事件，而 `XA COMMIT` 语句仍在执行，则可能会发生这种情况。这是一个已知问题。

+   不支持在 XA 事务中使用复制过滤器或二进制日志过滤器。对表的过滤可能导致副本上的 XA 事务为空，并且不支持空的 XA 事务。此外，副本的连接元数据存储库和应用程序元数据存储库存储在 `InnoDB` 表中，这在 MySQL 8.0 中成为默认设置，过滤的 XA 事务会改变数据引擎事务的内部状态，并可能与复制事务上下文状态不一致。

    当 XA 事务受到复制过滤器的影响时，无论事务是否为空，都会记录错误 `ER_XA_REPLICATION_FILTERS`。如果事务不为空，则副本可以继续运行，但您应该采取措施停止使用 XA 事务的复制过滤器以避免潜在问题。如果事务为空，则副本将停止。在这种情况下，副本可能处于一个不确定的状态，其中复制过程的一致性可能会受到损害。特别是，副本的 `gtid_executed` 集合可能与源端不一致。要解决这种情况，请隔离源端并停止所有复制，然后检查复制拓扑结构中的 GTID 一致性。撤消生成错误消息的 XA 事务，然后重新启动复制。

+   XA 事务被认为对于基于语句的复制是不安全的。如果在源端并行提交了两个 XA 事务，并且在副本上以相反的顺序准备这些事务，可能会发生无法安全解决的锁定依赖关系，并且复制可能会因副本上的死锁而失败。这种情况可能发生在单线程或多线程副本上。当设置 `binlog_format=STATEMENT` 时，对于 XA 事务中的 DML 语句会发出警告。当设置 `binlog_format=MIXED` 或 `binlog_format=ROW` 时，XA 事务中的 DML 语句将使用基于行的复制进行记录，潜在问题将不再存在。
