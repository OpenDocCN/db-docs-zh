# 17.11.2 文件空间管理

> 原文：[`dev.mysql.com/doc/refman/8.0/en/innodb-file-space.html`](https://dev.mysql.com/doc/refman/8.0/en/innodb-file-space.html)

您在配置文件中使用`innodb_data_file_path`配置选项定义的数据文件形成`InnoDB`系统表空间。这些文件在逻辑上连接在一起形成系统表空间。没有使用条带化。您无法定义表在系统表空间内的分配位置。在新创建的系统表空间中，`InnoDB`从第一个数据文件开始分配空间。

为了避免将所有表和索引存储在系统表空间内带来的问题，您可以启用`innodb_file_per_table`配置选项（默认情况下），该选项将每个新创建的表存储在单独的表空间文件中（扩展名为`.ibd`）。以这种方式存储的表在磁盘文件内部的碎片较少，当表被截断时，空间将被返回给操作系统，而不是仍然被 InnoDB 在系统表空间内保留。更多信息，请参阅第 17.6.3.2 节，“每表一个表空间”。

您还可以将表存储在通用表空间中。通用表空间是使用`CREATE TABLESPACE`语法创建的共享表空间。它们可以在 MySQL 数据目录之外创建，能够容纳多个表，并支持所有行格式的表。更多信息，请参阅第 17.6.3.3 节，“通用表空间”。

#### 页、区、段和表空间

每个表空间由数据库页组成。MySQL 实例中的每个表空间具有相同的页大小。默认情况下，所有表空间的页大小为 16KB；您可以通过在创建 MySQL 实例时指定`innodb_page_size`选项来将页大小减小到 8KB 或 4KB。您还可以将页大小增加到 32KB 或 64KB。更多信息，请参考`innodb_page_size`文档。

页面被分组为大小为 1MB 的 extent，用于大小不超过 16KB 的页面（64 个连续的 16KB 页面，或 128 个 8KB 页面，或 256 个 4KB 页面）。对于 32KB 的页面大小，extent 大小为 2MB。对于 64KB 的页面大小，extent 大小为 4MB。表空间中的“文件”被称为`InnoDB`中的 segments。（这些段与实际包含许多表空间段的 rollback segment 不同。）

当段在表空间内增长时，`InnoDB`逐个为其分配前 32 页。之后，`InnoDB`开始为段分配整个 extent。`InnoDB`可以一次向大段添加多达 4 个 extent，以确保数据的良好顺序性。

在`InnoDB`中，每个索引分配两个段。一个用于 B-tree 的非叶节点，另一个用于叶节点。在磁盘上保持叶节点连续使得更好的顺序 I/O 操作成为可能，因为这些叶节点包含实际的表数据。

表空间中的一些页面包含其他页面的位图，因此`InnoDB`表空间中的一些 extent 无法作为整体分配给段，而只能作为单个页面分配。

通过发出`SHOW TABLE STATUS`语句来查询表空间中的可用空闲空间时，`InnoDB`报告表空间中明确空闲的 extent。`InnoDB`始终保留一些 extent 用于清理和其他内部目的；这些保留的 extent 不包括在空闲空间中。

当您从表中删除数据时，`InnoDB`会收缩相应的 B-tree 索引。释放的空间是否可供其他用户使用取决于删除模式是否将单个页面或 extent 释放到表空间。删除表或从表中删除所有行将确保将空间释放给其他用户，但请记住，删除的行只有在不再需要进行事务回滚或一致性读取后一段时间自动执行的 purge 操作才会被物理删除。（参见 Section 17.3，“InnoDB 多版本”.）

#### 配置保留文件段页面的百分比

`innodb_segment_reserve_factor`变量，引入于 MySQL 8.0.26，是一个高级功能，允许定义作为空页面保留的表空间文件段页面的百分比。保留一定比例的页面用于未来增长，以便 B-tree 中的页面可以连续分配。修改保留页面百分比的能力允许对`InnoDB`进行微调，以解决数据碎片化或存储空间的低效使用问题。

该设置适用于每表文件和通用表空间。`innodb_segment_reserve_factor` 的默认设置为 12.5%，与之前的 MySQL 版本中保留的页面百分比相同。

`innodb_segment_reserve_factor` 变量是动态的，可以使用 `SET` 语句进行配置。例如：

```sql
mysql> SET GLOBAL innodb_segment_reserve_factor=10;
```

#### 页面与表行的关系

对于 4KB、8KB、16KB 和 32KB 的 `innodb_page_size` 设置，最大行长度略小于半个数据库页面大小。例如，默认的 16KB `InnoDB` 页面大小的最大行长度略小于 8KB。对于 64KB 的 `innodb_page_size` 设置，最大行长度略小于 16KB。

如果行未超过最大行长度，则所有内容都存储在页面内。如果行超过最大行长度，变长列 被选择进行外部页存储，直到行符合最大行长度限制。变长列的外部页存储根据行格式而异：

+   *紧凑和冗余行格式*

    当选择变长列进行外部页存储时，`InnoDB` 将前 768 字节存储在行内，其余部分存储在溢出页中。每个这样的列都有自己的溢出页列表。768 字节前缀伴随着一个 20 字节的值，存储列的真实长度，并指向溢出列表，其中存储了值的其余部分。参见 第 17.10 节，“InnoDB 行格式”。

+   *动态和压缩行格式*

    当选择变长列进行外部页存储时，`InnoDB` 在行内存储一个 20 字节的指针，其余部分存储在溢出页中。参见 第 17.10 节，“InnoDB 行格式”。

`LONGBLOB` 和 `LONGTEXT` 列必须小于 4GB，包括 `BLOB` 和 `TEXT` 列在内的总行长度必须小于 4GB。
