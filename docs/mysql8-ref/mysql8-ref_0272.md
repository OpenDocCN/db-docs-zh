# 7.4.3 通用查询日志

> 译文：[`dev.mysql.com/doc/refman/8.0/en/query-log.html`](https://dev.mysql.com/doc/refman/8.0/en/query-log.html)

通用查询日志是**mysqld**正在执行的一般记录。当客户端连接或断开连接时，服务器会将信息写入此日志，并记录从客户端接收的每个 SQL 语句。当您怀疑客户端中存在错误并想确切知道客户端发送给**mysqld**的内容时，通用查询日志可能非常有用。

每当客户端连接时显示的每一行还包括`using *`connection_type`*`，表示建立连接所使用的协议。*`connection_type`*可以是`TCP/IP`（未使用 SSL 建立的 TCP/IP 连接）、`SSL/TLS`（使用 SSL 建立的 TCP/IP 连接）、`Socket`（Unix 套接字文件连接）、`Named Pipe`（Windows 命名管道连接）或`Shared Memory`（Windows 共享内存连接）。

**mysqld**按照接收到的顺序将语句写入查询日志，这可能与执行顺序不同。这种记录顺序与二进制日志的记录顺序相反，二进制日志中的语句是在执行后但在释放任何锁之前写入的。此外，查询日志可能包含仅选择数据的语句，而这些语句永远不会写入二进制日志。

在复制源服务器上使用基于语句的二进制日志记录时，其副本接收的语句将写入每个副本的查询日志。如果客户端使用**mysqlbinlog**实用程序读取事件并将其传递给服务器，则语句将写入源的查询日志。

然而，当使用基于行的二进制日志记录时，更新以行更改的形式发送，而不是 SQL 语句，因此当`binlog_format`设置为`ROW`时，这些语句永远不会写入查询日志。当此变量设置为`MIXED`时，根据使用的语句，给定的更新也可能不会写入查询日志。有关更多信息，请参见 Section 19.2.1.1, “基于语句和基于行的复制的优缺点”。

默认情况下，通用查询日志被禁用。要明确指定初始通用查询日志状态，请使用[`--general_log[={0|1}]`](server-system-variables.html#sysvar_general_log)。没有参数或参数为 1 时，`--general_log`启用日志。参数为 0 时，此选项禁用日志。要指定日志文件名，请使用`--general_log_file=*`file_name`*`。要指定日志目的地，请使用`log_output`系统变量（如第 7.4.1 节，“选择通用查询日志和慢查询日志输出目的地”中所述）。

注意

如果指定了`TABLE`日志目的地，请参阅日志表和“打开文件过多”错误。

如果未为通用查询日志文件指定名称，则默认名称为`*`host_name`*.log`。服务器会在数据目录中创建文件，除非给定绝对路径名以指定不同的目录。

要在运行时禁用或启用通用查询日志或更改日志文件名，请使用全局`general_log`和`general_log_file`系统变量。将`general_log`设置为 0（或`OFF`）以禁用日志，设置为 1（或`ON`）以启用日志。设置`general_log_file`以指定日志文件的名称。如果已经打开了日志文件，则会关闭该文件并打开新文件。

当启用通用查询日志时，服务器会将输出写入由`log_output`系统变量指定的任何目的地。如果启用日志，服务器会打开日志文件并将启动消息写入其中。但是，除非选择了`FILE`日志目的地，否则不会进一步记录查询到文件中。如果目的地是`NONE`，即使启用了通用日志，服务器也不会写入任何查询。如果日志目的地值不包含`FILE`，设置日志文件名对日志记录没有影响。

服务器重启和日志刷新不会导致生成新的通用查询日志文件（尽管刷新会关闭并重新打开它）。要重命名文件并创建一个新文件，请使用以下命令：

```sql
$> mv *host_name*.log *host_name*-old.log
$> mysqladmin flush-logs general
$> mv *host_name*-old.log *backup-directory*
```

在 Windows 上，使用**rename**而不是**mv**。

您还可以通过禁用日志来在运行时重命名通用查询日志文件：

```sql
SET GLOBAL general_log = 'OFF';
```

禁用日志后，通过外部重命名日志文件（例如，从命令行）然后再次启用日志：

```sql
SET GLOBAL general_log = 'ON';
```

这种方法适用于任何平台，不需要服务器重启。

要为当前会话禁用或启用一般查询日志记录，请将会话 `sql_log_off` 变量设置为 `ON` 或 `OFF`。（这假定一般查询日志本身已启用。）

写入一般查询日志的语句中的密码会被服务器重写，以避免以明文形式出现。可以通过使用 `--log-raw` 选项启动服务器来阻止一般查询日志的密码重写。这个选项可能对诊断目的有用，以查看服务器接收到的语句的确切文本，但出于安全原因，不建议在生产环境中使用。另请参见 Section 8.1.2.3, “Passwords and Logging”。

密码重写的一个影响是无法解析的语句（例如由于语法错误）不会被写入一般查询日志，因为无法知道它们是否不包含密码。需要记录所有语句（包括带有错误的语句）的用例应该使用 `--log-raw` 选项，需要注意的是这也会绕过密码重写。

只有在预期明文密码时才会进行密码重写。对于期望密码哈希值的语法的语句，不会进行重写。如果错误地为这种语法提供了明文密码，则密码将按原样记录，而不进行重写。

`log_timestamps` 系统变量控制着写入一般查询日志文件（以及慢查询日志文件和错误日志）中的时间戳的时区。它不影响写入日志表的一般查询日志和慢查询日志消息的时区，但是从这些表中检索的行可以通过 `CONVERT_TZ()` 或设置会话 `time_zone` 系统变量将其从本地系统时区转换为任何所需的时区。
