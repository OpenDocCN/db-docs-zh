# 1\. 设置错误日志回调

> 原文：[`sqlite.com/errlog.html`](https://sqlite.com/errlog.html)

## 概述

SQLite 可以配置为在发生异常时调用一个回调函数，其中包含错误代码和简短的错误消息。这种机制在追踪偶尔发生且在现场出现的隐晦问题方面非常有帮助。鼓励应用程序开发人员在其产品中充分利用 SQLite 的错误日志功能，因为它在 CPU 和内存成本上非常低，但在调试方面可以提供巨大帮助。

每个进程只能有一个错误日志回调。错误日志回调在启动时使用类似以下 C 代码注册：

> ```sql
> sqlite3_config(SQLITE_CONFIG_LOG, errorLogCallback, pData);
> 
> ```

错误记录器回调函数可能如下所示：

> ```sql
> void errorLogCallback(void *pArg, int iErrCode, const char *zMsg){
>   fprintf(stderr, "(%d) %s\n", iErrCode, zMsg);
> }
> 
> ```

上面的示例说明了错误记录器回调函数的签名。然而，在嵌入式应用中，通常不会在标准错误流上打印消息。相反，可以将消息存储在预分配的循环缓冲区中，在调试期间需要诊断信息时可以访问这些消息。或者，消息可以发送到[Syslog](http://en.wikipedia.org/wiki/Syslog)。无论如何，这些消息需要存储在开发人员可访问的地方，而不是显示给最终用户。

不要误解：将错误记录器消息显示给最终用户没有任何技术上的问题。这些消息不包含必须保护免受未经授权查看的敏感或私密信息。相反，这些消息具有技术性质，对于典型的最终用户来说并不有用或有意义。来自错误记录器的消息是为数据库极客而设计的。请相应地显示它们。

# 2\. 接口详细信息

sqlite3_config(SQLITE_CONFIG_LOG,...) 接口的第三个参数（上面示例中的 "pData" 参数）是指向任意数据的指针。SQLite 将此指针传递给错误记录器回调的第一个参数。如果需要，可以使用该指针传递应用程序特定的设置或状态信息。或者，它可以简单地是一个被回调忽略的 NULL 指针。

错误记录器回调的第二个参数是整数扩展错误代码。错误记录器的第三个参数是错误消息的文本。错误消息文本存储在调用函数的固定长度堆栈缓冲区中，因此只在错误记录器回调函数的持续时间内有效。如果需要保留消息，则错误记录器应将此消息复制到持久存储中。

错误记录器回调应该像信号处理器一样对待。应用程序应保存或以其他方式处理错误，然后尽快返回。不应从错误记录器直接或间接地调用其他 SQLite API。SQLite 在错误记录器回调中不可重入。特别是在内存分配失败时会调用错误记录器回调，因此尝试在错误记录器中分配内存通常是一个坏主意。甚至不要考虑尝试将错误消息存储在另一个 SQLite 数据库中。

应用程序可以使用 sqlite3_log(E,F,..) API 将新消息发送到日志中，如果需要的话，但这是不鼓励的。 sqlite3_log() 接口仅用于扩展使用，而不是应用程序使用。

# 3\. 各种错误消息

可能发送到错误记录器的错误消息及其确切格式在一个版本到下一个版本可能会发生变化。因此，应用程序不应依赖于任何特定的错误消息文本格式或错误代码。事情并非随意变更，但有时确实会发生变更。

以下是可能出现在错误记录器回调中的消息种类的部分列表。

+   每当编译 SQL 语句（使用 sqlite3_prepare_v2() 或其姊妹函数之一）时出错或运行 SQL 语句（使用 sqlite3_step()）时出错，都会记录错误。

+   当发生需要重新解析和重新准备已经准备好的语句的模式更改时，将使用错误代码 SQLITE_SCHEMA 记录此事件。重新解析和重新准备通常是自动的（假设最初使用了 sqlite3_prepare_v2() 来准备语句，这是推荐的做法），因此这些记录事件通常是了解重新准备正在进行的唯一方法。

+   SQLITE_NOTICE 消息会在必须恢复数据库时记录，因为前一个写入者在未完成其事务的情况下崩溃。当恢复一个 回滚日志 时，错误代码是 SQLITE_NOTICE_RECOVER_ROLLBACK；当恢复一个 预写式日志 时，错误代码是 SQLITE_NOTICE_RECOVER_WAL。

+   SQLITE_WARNING 消息在数据库文件被重命名或以可能导致数据库损坏的方式别名时被记录。（参见 1 和 2 获取额外信息。）

+   内存不足（OOM）错误条件会生成带有 SQLITE_NOMEM 错误代码和消息的错误记录事件，消息说明了失败分配请求的字节数。

+   OS 接口中的 I/O 错误会生成错误记录事件。这些事件的消息会给出源代码中产生错误的行号以及与事件相关联的文件名（当有对应文件时）。

+   当检测到数据库损坏时，会调用一个 SQLITE_CORRUPT 错误记录回调函数。与 I/O 错误一样，错误消息文本中包含了在原始源代码中首次检测到错误的行号。

+   在 SQLITE_MISUSE 错误时会调用错误记录回调函数。这对于检测应用程序设计问题在应用程序代码中未一致检查返回码时非常有用。

SQLite 致力于保持错误记录流量的低延迟，并且仅在真正有问题时才向错误记录器发送消息。应用程序可以通过有意忽略它们不关心的某些类别的错误消息进一步减少错误消息的流量。例如，频繁进行数据库模式更改的应用程序可能希望忽略所有 SQLITE_SCHEMA 错误。

# 4\. 总结

强烈推荐使用错误记录回调函数。错误记录器提供的调试信息在追踪应用程序在投入使用后出现的隐秘问题方面非常有用。错误记录回调函数还被证明在捕捉由于 API 返回码的不一致检查而应用程序遗漏的偶发错误方面非常有用。开发者被鼓励在开发周期的早期阶段实现错误记录回调函数，以便快速发现意外行为，并在部署中保持错误记录回调函数的开启状态。如果错误记录回调函数从未发现问题，那么也不会造成任何损害。但是，未设置适当的错误记录器可能会影响后续的诊断能力。
