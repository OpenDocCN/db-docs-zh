# SQLite 和 8+3 文件名

> 原文：[`sqlite.com/shortnames.html`](https://sqlite.com/shortnames.html)

SQLite 的默认配置假定底层文件系统支持长文件名。

SQLite 对数据库文件的命名没有任何要求。SQLite 可以轻松地处理具有任何文件扩展名或没有扩展名的数据库文件。当需要用于回滚日志、预写式日志或其他一些临时磁盘文件时，辅助文件的名称通常是通过在数据库文件名的末尾添加后缀来构建的。例如，如果原始数据库称为 "`app.db`"，那么回滚日志将被称为 "`app.db-journal`"，而预写式日志将被称为 "`app.db-wal`"。这种辅助文件命名方法在支持长文件名的系统上非常有效。但是在强制使用 8+3 文件名约束的系统上，辅助文件并不符合 8+3 格式，尽管原始数据库文件符合。

## 更改文件系统

解决此问题的推荐方法是选择不同的文件系统。如今，有大量高性能、可靠且无专利的文件系统可供选择，支持长文件名。在可能的情况下，建议嵌入式设备使用其中之一。这将避免兼容性问题和由不一致使用 8+3 文件名导致的数据库损坏的风险。

## 调整 SQLite 以使用 8+3 文件名

一些设备由于向后兼容性或其他非技术因素而被迫使用具有 8+3 文件名限制的旧文件系统。在这种情况下，可以强制 SQLite 使用符合 8+3 模式的辅助文件，方法如下：

1.  使用编译时选项 SQLITE_ENABLE_8_3_NAMES=1 或 SQLITE_ENABLE_8_3_NAMES=2 编译 SQLite 库。SQLite 默认情况下不包含对 8+3 文件名的支持，因为这会引入一些开销。尽管开销微乎其微，但我们不希望增加数十亿不需要 8+3 文件名支持的 SQLite 应用程序的负担。

1.  如果使用了 SQLITE_ENABLE_8_3_NAMES=1 选项，则 SQLite 能够使用 8+3 文件名，但该功能被禁用，并且必须通过在打开或 ATTACH 数据库文件时使用 URI 文件名 并在 URI 中包含 "`8_3_names=1`" 查询参数来单独启用每个数据库连接。如果使用 SQLITE_ENABLE_8_3_NAMES=2 编译 SQLite，则默认启用 8+3 文件名，可以跳过此步骤。

1.  确保数据库文件名符合 8+3 文件名格式，并且没有空名称或扩展名。换句话说，数据库文件名必须包含 1 到 8 个字符的基本名称和 1 到 3 个字符的扩展名。不允许空扩展名。

当使用上述步骤时，SQLite 将通过仅使用扩展名的最后 3 个字符来缩短文件名扩展。因此，例如，通常称为"`app.db-journal`"的文件将缩短为"`app.nal`"。类似地，"`app.db-wal`"将变为"`app.wal`"，"`app.db-shm`"将变为"`app.shm`"。

请注意，数据库文件名必须具有某种扩展名非常重要。如果没有扩展名，那么 SQLite 将通过在文件的基本名称后附加来创建辅助文件名。因此，名为"`db01`"的数据库将具有名为"`db01-journal`"的回滚日志文件。由于该文件名没有扩展名可以缩短到 3 个字符，因此将按原样使用，并违反 8+3 命名规则。

## 数据库损坏警告

如果数据库文件使用的是 8+3 命名格式而不是默认的长文件名格式访问，那么每次打开时每个数据库连接都必须一致地使用 8+3 命名格式，否则存在数据库损坏的风险。辅助的回滚日志和预写式日志文件对于 SQLite 至关重要，可以在崩溃后进行恢复。如果应用程序使用 8+3 命名格式并且崩溃，那么安全恢复所需的信息将存储在扩展名为"`.nal`"或"`.wal`"的文件中。如果下一个打开数据库的应用程序未指定"`8_3_names=1`"的 URI 参数，那么 SQLite 将使用长文件名尝试定位回滚日志或预写式日志文件。它将找不到它们，因为它们是由崩溃的应用程序使用 8+3 名称保存的，因此数据库将无法正确恢复，很可能会损坏。

在某些情况下使用 8+3 文件名格式的数据库文件，而在其他情况下使用长文件名格式相当于删除热日志。
