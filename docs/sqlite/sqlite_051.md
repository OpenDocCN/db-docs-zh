# SQLite 中的内部与外部 BLOB

> 原文：[`sqlite.com/intern-v-extern-blob.html`](https://sqlite.com/intern-v-extern-blob.html)

如果您有大型 BLOB 的数据库，直接将完整的 BLOB 内容存储在数据库中，还是将每个 BLOB 存储在单独的文件中并仅在数据库中存储相应的文件名，哪种方式能获得更好的读取性能？

为了尝试回答这个问题，我们在 Linux 工作站（Ubuntu 约 2011 年，使用 Ext4 文件系统和快速 SATA 硬盘）上运行了 49 个测试案例，分别使用不同的 BLOB 大小和 SQLite 页面大小。对于每个测试案例，创建了一个包含 100MB BLOB 内容的数据库。BLOB 的大小范围从 10KB 到 1MB 不等。BLOB 的数量因此而变化，以保持总 BLOB 内容约为 100MB。（因此，1MB 大小的 BLOB 有 100 个，10K 大小的有 10000 个，依此类推。）使用了 SQLite 版本 3.7.8（2011-09-19）。

> *更新：针对 SQLite 版本 3.19.0（2017-05-22）的新测量结果显示，SQLite 在读写 10KB BLOB 时比直接磁盘 I/O 快约 35%。*

下面的矩阵显示了读取存储在单独文件中的 BLOB 所需时间与读取完全存储在数据库中的 BLOB 所需时间之比。因此，对于大于 1.0 的数字，直接将 BLOB 存储在数据库中更快。对于小于 1.0 的数字，将 BLOB 存储在单独文件中更快。

在每种情况下，页面缓存大小都被调整以保持大约 2MB 的缓存内存量。例如，对于 1024 字节的页面，使用了 2000 页缓存，对于 65536 字节的页面，使用了 31 页缓存。BLOB 值是以随机顺序读取的。

| 数据库页面大小 | BLOB 大小 |
| --- | --- |
| 10k | 20k | 50k | 100k | 200k | 500k | 1m |
| 1024 | 1.535 | 1.020 | 0.608 | 0.456 | 0.330 | 0.247 | 0.233 |
| 2048 | 2.004 | 1.437 | 0.870 | 0.636 | 0.483 | 0.372 | 0.340 |
| 4096 | 2.261 | 1.886 | 1.173 | 0.890 | 0.701 | 0.526 | 0.487 |
| 8192 | 2.240 | 1.866 | 1.334 | 1.035 | 0.830 | 0.625 | 0.720 |
| 16384 | 2.439 | 1.757 | 1.292 | 1.023 | 0.829 | 0.820 | 0.598 |
| 32768 | 1.878 | 1.843 | 1.296 | 0.981 | 0.976 | 0.675 | 0.613 |
| 65536 | 1.256 | 1.255 | 1.339 | 0.983 | 0.769 | 0.687 | 0.609 |

我们从上述矩阵中得出以下经验法则：

+   数据库页面大小为 8192 或 16384 时，对大型 BLOB I/O 性能最佳。

+   对于小于 100KB 的 BLOB，将 BLOB 直接存储在数据库文件中时读取速度更快。对于大于 100KB 的 BLOB，从单独文件中读取速度更快。

当然，实际情况可能因硬件、文件系统和操作系统而异。在确定特定设计之前，请在目标硬件上仔细检查这些数据。
