- en: 原文：[https://dev.mysql.com/doc/refman/8.0/en/audit-log-logging-configuration.html](https://dev.mysql.com/doc/refman/8.0/en/audit-log-logging-configuration.html)
  id: totrans-0
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://dev.mysql.com/doc/refman/8.0/en/audit-log-logging-configuration.html](https://dev.mysql.com/doc/refman/8.0/en/audit-log-logging-configuration.html)
- en: 8.4.5.5 Configuring Audit Logging Characteristics
  id: totrans-1
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 8.4.5.5 配置审计日志特性
- en: This section describes how to configure audit logging characteristics, such
    as the file to which the audit log plugin writes events, the format of written
    events, whether to enable log file compression and encryption, and space management.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本节描述了如何配置审计日志特性，例如审计日志插件写入事件的文件、写入事件的格式、是否启用日志文件压缩和加密以及空间管理。
- en: '[Naming Conventions for Audit Log Files](audit-log-logging-configuration.html#audit-log-file-name
    "Naming Conventions for Audit Log Files")'
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[审计日志文件命名约定](audit-log-logging-configuration.html#audit-log-file-name "审计日志文件命名约定")'
- en: '[Selecting Audit Log File Format](audit-log-logging-configuration.html#audit-log-file-format
    "Selecting Audit Log File Format")'
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[选择审计日志文件格式](audit-log-logging-configuration.html#audit-log-file-format "选择审计日志文件格式")'
- en: '[Enabling the Audit Log Flush Task](audit-log-logging-configuration.html#audit-log-flush-task
    "Enabling the Audit Log Flush Task")'
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[启用审计日志刷新任务](audit-log-logging-configuration.html#audit-log-flush-task "启用审计日志刷新任务")'
- en: '[Adding Query Statistics for Outlier Detection](audit-log-logging-configuration.html#audit-log-query-statistics
    "Adding Query Statistics for Outlier Detection")'
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[为异常检测添加查询统计信息](audit-log-logging-configuration.html#audit-log-query-statistics
    "为异常检测添加查询统计信息")'
- en: '[Compressing Audit Log Files](audit-log-logging-configuration.html#audit-log-file-compression
    "Compressing Audit Log Files")'
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[压缩审计日志文件](audit-log-logging-configuration.html#audit-log-file-compression
    "压缩审计日志文件")'
- en: '[Encrypting Audit Log Files](audit-log-logging-configuration.html#audit-log-file-encryption
    "Encrypting Audit Log Files")'
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[加密审计日志文件](audit-log-logging-configuration.html#audit-log-file-encryption "加密审计日志文件")'
- en: '[Manually Uncompressing and Decrypting Audit Log Files](audit-log-logging-configuration.html#audit-log-file-uncompression-decryption
    "Manually Uncompressing and Decrypting Audit Log Files")'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[手动解压和解密审计日志文件](audit-log-logging-configuration.html#audit-log-file-uncompression-decryption
    "手动解压和解密审计日志文件")'
- en: '[Audit Log File Encryption Prior to MySQL 8.0.17](audit-log-logging-configuration.html#audit-log-file-encryption-old
    "Audit Log File Encryption Prior to MySQL 8.0.17")'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[MySQL 8.0.17之前的审计日志文件加密](audit-log-logging-configuration.html#audit-log-file-encryption-old
    "MySQL 8.0.17之前的审计日志文件加密")'
- en: '[Space Management of Audit Log Files](audit-log-logging-configuration.html#audit-log-space-management
    "Space Management of Audit Log Files")'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[审计日志文件空间管理](audit-log-logging-configuration.html#audit-log-space-management
    "审计日志文件空间管理")'
- en: '[Write Strategies for Audit Logging](audit-log-logging-configuration.html#audit-log-strategy
    "Write Strategies for Audit Logging")'
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[审计日志编写策略](audit-log-logging-configuration.html#audit-log-strategy "审计日志编写策略")'
- en: Note
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Encryption capabilities described here apply as of MySQL 8.0.17, with the exception
    of the section that compares current encryption capabilities to the previous more-limited
    capabilities; see [Audit Log File Encryption Prior to MySQL 8.0.17](audit-log-logging-configuration.html#audit-log-file-encryption-old
    "Audit Log File Encryption Prior to MySQL 8.0.17").
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 此处描述的加密功能适用于MySQL 8.0.17，除了比较当前加密功能与以前更有限功能的部分之外；请参阅[MySQL 8.0.17之前的审计日志文件加密](audit-log-logging-configuration.html#audit-log-file-encryption-old
    "MySQL 8.0.17之前的审计日志文件加密")。
- en: For additional information about the functions and system variables that affect
    audit logging, see [Audit Log Functions](audit-log-reference.html#audit-log-routines
    "Audit Log Functions"), and [Audit Log Options and Variables](audit-log-reference.html#audit-log-options-variables
    "Audit Log Options and Variables").
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 有关影响审计日志的函数和系统变量的额外信息，请参阅[审计日志函数](audit-log-reference.html#audit-log-routines
    "审计日志函数")和[审计日志选项和变量](audit-log-reference.html#audit-log-options-variables "审计日志选项和变量")。
- en: The audit log plugin can also control which audited events are written to the
    audit log file, based on event content or the account from which events originate.
    See [Section 8.4.5.7, “Audit Log Filtering”](audit-log-filtering.html "8.4.5.7 Audit
    Log Filtering").
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 审计日志插件还可以根据事件内容或事件来源的帐户控制写入审计日志文件的审计事件。请参阅[第8.4.5.7节，“审计日志过滤”](audit-log-filtering.html
    "8.4.5.7 审计日志过滤")。
- en: Naming Conventions for Audit Log Files
  id: totrans-17
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 审计日志文件命名约定
- en: To configure the audit log file name, set the [`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)
    system variable at server startup. The default name is `audit.log` in the server
    data directory. For best security, write the audit log to a directory accessible
    only to the MySQL server and to users with a legitimate reason to view the log.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置审计日志文件名，请在服务器启动时设置[`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)系统变量。默认名称是服务器数据目录中的`audit.log`。为了最佳安全性，将审计日志写入仅对
    MySQL 服务器和有合法查看日志原因的用户可访问的目录。
- en: 'The plugin interprets the [`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)
    value as composed of an optional leading directory name, a base name, and an optional
    suffix. If compression or encryption are enabled, the effective file name (the
    name actually used to create the log file) differs from the configured file name
    because it has additional suffixes:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 该插件将[`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)值解释为由可选的前导目录名、基本名称和可选后缀组成。如果启用了压缩或加密，则有效文件名（实际用于创建日志文件的名称）与配置文件名不同，因为它具有额外的后缀：
- en: If compression is enabled, the plugin adds a suffix of `.gz`.
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果启用了压缩，插件会添加一个后缀为`.gz`。
- en: If encryption is enabled, the plugin adds a suffix of `.*`pwd_id`*.enc`, where
    *`pwd_id`* indicates which encryption password to use for log file operations.
    The audit log plugin stores encryption passwords in the keyring; see [Encrypting
    Audit Log Files](audit-log-logging-configuration.html#audit-log-file-encryption
    "Encrypting Audit Log Files").
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果启用了加密，插件会添加一个后缀为`.*`pwd_id`*.enc`，其中`pwd_id`指示用于日志文件操作的加密密码。审计日志插件将加密密码存储在密钥环中；请参阅[加密审计日志文件](audit-log-logging-configuration.html#audit-log-file-encryption
    "加密审计日志文件")。
- en: The effective audit log file name is the name resulting from the addition of
    applicable compression and encryption suffixes to the configured file name. For
    example, if the configured [`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)
    value is `audit.log`, the effective file name is one of the values shown in the
    following table.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 有效的审计日志文件名是通过将适用的压缩和加密后缀添加到配置文件名中得到的名称。例如，如果配置的[`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)值为`audit.log`，则有效文件名是以下表中显示的值之一。
- en: '| Enabled Features | Effective File Name |'
  id: totrans-23
  prefs: []
  type: TYPE_TB
  zh: '| 启用功能 | 有效文件名 |'
- en: '| No compression or encryption | `audit.log` |'
  id: totrans-24
  prefs: []
  type: TYPE_TB
  zh: '| 无压缩或加密 | `audit.log` |'
- en: '| Compression | `audit.log.gz` |'
  id: totrans-25
  prefs: []
  type: TYPE_TB
  zh: '| 压缩 | `audit.log.gz` |'
- en: '| Encryption | `audit.log.*`pwd_id`*.enc` |'
  id: totrans-26
  prefs: []
  type: TYPE_TB
  zh: '| 加密 | `audit.log.*`pwd_id`*.enc` |'
- en: '| Compression, encryption | `audit.log.gz.*`pwd_id`*.enc` |'
  id: totrans-27
  prefs: []
  type: TYPE_TB
  zh: '| 压缩，加密 | `audit.log.gz.*`pwd_id`*.enc` |'
- en: '*`pwd_id`* indicates the ID of the password used to encrypt or decrypt a file.
    *`pwd_id`* format is *`pwd_timestamp-seq`*, where:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: '`pwd_id`指示用于加密或解密文件的密码的 ID。`pwd_id`格式为`pwd_timestamp-seq`，其中：'
- en: '*`pwd_timestamp`* is a UTC value in `*`YYYYMMDD`*T*`hhmmss`*` format indicating
    when the password was created.'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`pwd_timestamp`是一个以`*`YYYYMMDD`*T*`hhmmss`*`格式表示的 UTC 值，指示密码创建的时间。'
- en: '*`seq`* is a sequence number. Sequence numbers start at 1 and increase for
    passwords that have the same *`pwd_timestamp`* value.'
  id: totrans-30
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`seq`是一个序列号。序列号从1开始，对于具有相同`pwd_timestamp`值的密码递增。'
- en: 'Here are some example *`pwd_id`* password ID values:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一些示例`pwd_id`密码 ID 值：
- en: '[PRE0]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To construct the corresponding keyring IDs for storing passwords in the keyring,
    the audit log plugin adds a prefix of `audit_log-` to the *`pwd_id`* values. For
    the example password IDs just shown, the corresponding keyring IDs are:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 为了构建用于在密钥环中存储密码的相应密钥环 ID，审计日志插件将`pwd_id`值的前缀添加为`audit_log-`。对于刚刚显示的示例密码 ID，相应的密钥环
    ID 是：
- en: '[PRE1]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The ID of the password currently used for encryption by the audit log plugin
    is the one having the largest *`pwd_timestamp`* value. If multiple passwords have
    that *`pwd_timestamp`* value, the current password ID is the one with the largest
    sequence number. For example, in the preceding set of password IDs, two of them
    have the largest timestamp, `20190403T142400`, so the current password ID is the
    one with the largest sequence number (`2`).
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 当前由审计日志插件用于加密的密码的 ID 是具有最大`pwd_timestamp`值的密码。如果多个密码具有该`pwd_timestamp`值，则当前密码
    ID 是具有最大序列号的密码。例如，在前面的密码 ID 集合中，有两个具有最大时间戳`20190403T142400`，因此当前密码 ID 是具有最大序列号（`2`）的密码。
- en: 'The audit log plugin performs certain actions during initialization and termination
    based on the effective audit log file name:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 审计日志插件根据有效的审计日志文件名在初始化和终止期间执行某些操作：
- en: During initialization, the plugin checks whether a file with the audit log file
    name already exists and renames it if so. (In this case, the plugin assumes that
    the previous server invocation exited unexpectedly with the audit log plugin running.)
    The plugin then writes to a new empty audit log file.
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在初始化期间，插件会检查是否已存在具有审计日志文件名的文件，并在有时重命名它。（在这种情况下，插件假定之前的服务器调用以审计日志插件运行而异常退出。）然后插件会写入一个新的空审计日志文件。
- en: During termination, the plugin renames the audit log file.
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在终止期间，插件会重命名审计日志文件。
- en: File renaming (whether during plugin initialization or termination) occurs according
    to the usual rules for automatic size-based log file rotation; see [Manual Audit
    Log File Rotation (Before MySQL 8.0.31)](audit-log-logging-configuration.html#audit-log-manual-rotation
    "Manual Audit Log File Rotation (Before MySQL 8.0.31)").
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 文件重命名（无论是在插件初始化还是终止期间）都遵循自动基于大小的日志文件轮换的通常规则；请参阅[手动审计日志文件轮换（MySQL 8.0.31之前）](audit-log-logging-configuration.html#audit-log-manual-rotation
    "手动审计日志文件轮换（MySQL 8.0.31之前）")。
- en: Selecting Audit Log File Format
  id: totrans-40
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 选择审计日志文件格式
- en: 'To configure the audit log file format, set the [`audit_log_format`](audit-log-reference.html#sysvar_audit_log_format)
    system variable at server startup. These formats are available:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置审计日志文件格式，请在服务器启动时设置[`audit_log_format`](audit-log-reference.html#sysvar_audit_log_format)系统变量。这些格式可用：
- en: '`NEW`: New-style XML format. This is the default.'
  id: totrans-42
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`NEW`：新式XML格式。这是默认值。'
- en: '`OLD`: Old-style XML format.'
  id: totrans-43
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`OLD`：旧式XML格式。'
- en: '`JSON`: JSON format. Writes the audit log as a JSON array. Only this format
    supports the optional query time and size statistics, which are available from
    MySQL 8.0.30.'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`JSON`：JSON格式。将审计日志写入JSON数组。只有此格式支持可选的查询时间和大小统计信息，这些信息从MySQL 8.0.30开始提供。'
- en: For details about each format, see [Section 8.4.5.4, “Audit Log File Formats”](audit-log-file-formats.html
    "8.4.5.4 Audit Log File Formats").
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 有关每种格式的详细信息，请参阅[第8.4.5.4节，“审计日志文件格式”](audit-log-file-formats.html "8.4.5.4 审计日志文件格式")。
- en: Enabling the Audit Log Flush Task
  id: totrans-46
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 启用审计日志刷新任务
- en: Starting in MySQL 8.0.34, MySQL Enterprise Audit provides the capability of
    setting a refresh interval to dispose of the in-memory cache automatically. A
    flush task configured using the [`audit_log_flush_interval_seconds`](audit-log-reference.html#sysvar_audit_log_flush_interval_seconds)
    system variable has a value of zero by default, which means the task is not scheduled
    to run.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 从MySQL 8.0.34开始，MySQL企业审计提供了设置刷新间隔以自动处理内存缓存的功能。使用[`audit_log_flush_interval_seconds`](audit-log-reference.html#sysvar_audit_log_flush_interval_seconds)系统变量配置的刷新任务默认值为零，这意味着未安排运行任务。
- en: 'When the task is configured to run (the value is non-zero), MySQL Enterprise
    Audit attempts to call the [scheduler](scheduler-component.html "7.5.5 Scheduler
    Component") component at its initialization and configure a regular, recurring
    flush of its memory cache:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 当任务配置为运行时（值为非零），MySQL企业审计尝试在其初始化时调用[scheduler](scheduler-component.html "7.5.5 Scheduler
    Component")组件，并配置其内存缓存的定期定期刷新：
- en: If the audit log cannot find an implementation of the scheduler registration
    service, it does not schedule the flush and continue loading.
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果审计日志找不到调度程序注册服务的实现，则不会安排刷新并继续加载。
- en: Audit log implements the `dynamic_loader_services_loaded_notification` service
    and listens for new registrations of `mysql_scheduler` so that audit log can register
    its scheduled task into the newly loaded scheduler.
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 审计日志实现了`dynamic_loader_services_loaded_notification`服务，并监听`mysql_scheduler`的新注册，以便审计日志可以将其计划任务注册到新加载的调度程序中。
- en: Audit log only registers itself into the first scheduler implementation loaded.
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 审计日志仅注册到加载的第一个调度程序实现中。
- en: Similarly, MySQL Enterprise Audit calls the `scheduler` component at its deinitialization
    and unconfigures the recurring flush that it has scheduled. It keeps an active
    reference to the scheduler registration service until the scheduled task is unregistered,
    ensuring that the `scheduler` component cannot be unloaded while there are active
    scheduled jobs. All of the results from executing the scheduler and its tasks
    are written to the server error log.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 类似地，MySQL企业审计在其去初始化时调用`scheduler`组件，并取消其已计划的定期刷新。它保持对调度程序注册服务的活动引用，直到计划任务被注销，确保在有活动计划任务时无法卸载`scheduler`组件。执行调度程序及其任务的所有结果都写入服务器错误日志。
- en: 'To schedule an audit log flush task:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 要安排审计日志刷新任务：
- en: Confirm that the `scheduler` component is loaded and enabled. The component
    is enabled (`ON`) by default (see [`component_scheduler.enabled`](server-system-variables.html#sysvar_component_scheduler.enabled)).
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确认`scheduler`组件已加载并启用。该组件默认启用（`ON`）（参见[`component_scheduler.enabled`](server-system-variables.html#sysvar_component_scheduler.enabled)）。
- en: '[PRE2]'
  id: totrans-55
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Install the `audit_log` plugin, if it is not installed already (see [Section 8.4.5.2,
    “Installing or Uninstalling MySQL Enterprise Audit”](audit-log-installation.html
    "8.4.5.2 Installing or Uninstalling MySQL Enterprise Audit")).
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果尚未安装`audit_log`插件，请安装它（参见[Section 8.4.5.2, “Installing or Uninstalling MySQL
    Enterprise Audit”](audit-log-installation.html "8.4.5.2 Installing or Uninstalling
    MySQL Enterprise Audit")）。
- en: 'Start the server using [`audit_log_flush_interval_seconds`](audit-log-reference.html#sysvar_audit_log_flush_interval_seconds)
    and set the value to a number greater than 59\. The upper limit of the value varies
    by platform. For example, to configure the flush task to recur every two minutes:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用[`audit_log_flush_interval_seconds`](audit-log-reference.html#sysvar_audit_log_flush_interval_seconds)启动服务器，并将值设置为大于59的数字。该值的上限因平台而异。例如，要配置刷新任务每两分钟重复一次：
- en: '[PRE3]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: For more information, see the [`audit_log_flush_interval_seconds`](audit-log-reference.html#sysvar_audit_log_flush_interval_seconds)
    system variable.
  id: totrans-59
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 更多信息，请参阅[`audit_log_flush_interval_seconds`](audit-log-reference.html#sysvar_audit_log_flush_interval_seconds)系统变量。
- en: Adding Query Statistics for Outlier Detection
  id: totrans-60
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 添加用于异常值检测的查询统计信息
- en: In MySQL 8.0.30 and later, you can extend log files in JSON format with optional
    data fields to show the query time, the number of bytes sent and received, the
    number of rows returned to the client, and the number of rows examined. This data
    is available in the slow query log for qualifying queries, and in the context
    of the audit log it similarly helps to detect outliers for activity analysis.
    The extended data fields can be added only when the audit log is in JSON format
    ([`audit_log_format=JSON`](audit-log-reference.html#sysvar_audit_log_format)),
    which is not the default setting.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在MySQL 8.0.30及更高版本中，您可以通过可选数据字段扩展JSON格式的日志文件，以显示查询时间、发送和接收的字节数、返回给客户端的行数以及检查的行数。对于符合条件的查询，此数据在慢查询日志中可用，并且在审计日志的上下文中，类似地有助于检测活动分析的异常值。只有当审计日志处于JSON格式（[`audit_log_format=JSON`](audit-log-reference.html#sysvar_audit_log_format)）时，扩展数据字段才能添加，这不是默认设置。
- en: The query statistics are delivered to the audit log through component services
    that you set up as an audit log filtering function. The services are named `mysql_audit_print_service_longlong_data_source`
    and `mysql_audit_print_service_double_data_source`. You can choose either data
    type for each output item. For the query time, `longlong` outputs the value in
    microseconds, and `double` outputs the value in seconds.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 查询统计信息通过您设置的组件服务传递到审计日志，作为审计日志过滤函数。这些服务分别命名为`mysql_audit_print_service_longlong_data_source`和`mysql_audit_print_service_double_data_source`。您可以为每个输出项选择任一数据类型。对于查询时间，`longlong`以微秒输出值，而`double`以秒输出值。
- en: 'You add the query statistics using the [`audit_log_filter_set_filter()`](audit-log-reference.html#function_audit-log-filter-set-filter)
    audit log function, as the `service` element of the JSON filtering syntax, as
    follows:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用[`audit_log_filter_set_filter()`](audit-log-reference.html#function_audit-log-filter-set-filter)审计日志函数将查询统计信息添加为JSON过滤语法的`service`元素，如下所示：
- en: '[PRE4]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: For the `bytes_sent` and `bytes_received` fields to be populated, the system
    variable [`log_slow_extra`](server-system-variables.html#sysvar_log_slow_extra)
    must be set to `ON`. If the system variable is value is `OFF`, a null value is
    written to the log file for these fields.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 要填充`bytes_sent`和`bytes_received`字段，系统变量[`log_slow_extra`](server-system-variables.html#sysvar_log_slow_extra)必须设置为`ON`。如果系统��量值为`OFF`，则这些字段的日志文件中将写入空值。
- en: 'If you want to stop collecting the query statistics, use the [`audit_log_filter_set_filter()`](audit-log-reference.html#function_audit-log-filter-set-filter)
    audit log function to remove the filter, for example:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想停止收集查询统计信息，请使用[`audit_log_filter_set_filter()`](audit-log-reference.html#function_audit-log-filter-set-filter)审计日志函数来移除过滤器，例如：
- en: '[PRE5]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Compressing Audit Log Files
  id: totrans-68
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 压缩审计日志文件
- en: Audit log file compression can be enabled for any logging format.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 可以为任何日志格式启用审计日志文件压缩。
- en: To configure audit log file compression, set the [`audit_log_compression`](audit-log-reference.html#sysvar_audit_log_compression)
    system variable at server startup. Permitted values are `NONE` (no compression;
    the default) and `GZIP` (GNU Zip compression).
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置审计日志文件压缩，请在服务器启动时设置[`audit_log_compression`](audit-log-reference.html#sysvar_audit_log_compression)系统变量。允许的值为`NONE`（无压缩；默认值）和`GZIP`（GNU
    Zip压缩）。
- en: If both compression and encryption are enabled, compression occurs before encryption.
    To recover the original file manually, first decrypt it, then uncompress it. See
    [Manually Uncompressing and Decrypting Audit Log Files](audit-log-logging-configuration.html#audit-log-file-uncompression-decryption
    "Manually Uncompressing and Decrypting Audit Log Files").
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 如果同时启用了压缩和加密，则压缩会在加密之前发生。要手动恢复原始文件，首先解密，然后解压缩。请参阅[手动解压缩和解密审计日志文件](audit-log-logging-configuration.html#audit-log-file-uncompression-decryption
    "手动解压缩和解密审计日志文件")。
- en: Encrypting Audit Log Files
  id: totrans-72
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 加密审计日志文件
- en: Audit log file encryption can be enabled for any logging format. Encryption
    is based on user-defined passwords (with the exception of the initial password
    that the audit log plugin generates). To use this feature, the MySQL keyring must
    be enabled because audit logging uses it for password storage. Any keyring component
    or plugin can be used; for instructions, see [Section 8.4.4, “The MySQL Keyring”](keyring.html
    "8.4.4 The MySQL Keyring").
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 可以为任何日志格式启用审计日志文件加密。加密基于用户定义的密码（除了审计日志插件生成的初始密码）。要使用此功能，必须启用MySQL密钥环，因为审计日志使用它进行密码存储。可以使用任何密钥环组件或插件；有关说明，请参阅[第8.4.4节，“MySQL密钥环”](keyring.html
    "8.4.4 MySQL密钥环")。
- en: To configure audit log file encryption, set the [`audit_log_encryption`](audit-log-reference.html#sysvar_audit_log_encryption)
    system variable at server startup. Permitted values are `NONE` (no encryption;
    the default) and `AES` (AES-256-CBC cipher encryption).
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置审计日志文件加密，请在服务器启动时设置[`audit_log_encryption`](audit-log-reference.html#sysvar_audit_log_encryption)系统变量。允许的值为`NONE`（无加密；默认）和`AES`（AES-256-CBC密码加密）。
- en: 'To set or get an encryption password at runtime, use these audit log functions:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 要在运行时设置或获取加密密码，请使用这些审计日志函数：
- en: To set the current encryption password, invoke [`audit_log_encryption_password_set()`](audit-log-reference.html#function_audit-log-encryption-password-set).
    This function stores the new password in the keyring. If encryption is enabled,
    it also performs a log file rotation operation that renames the current log file,
    and begins a new log file encrypted with the password. File renaming occurs according
    to the usual rules for automatic size-based log file rotation; see [Manual Audit
    Log File Rotation (Before MySQL 8.0.31)](audit-log-logging-configuration.html#audit-log-manual-rotation
    "Manual Audit Log File Rotation (Before MySQL 8.0.31)").
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要设置当前的加密密码，请调用[`audit_log_encryption_password_set()`](audit-log-reference.html#function_audit-log-encryption-password-set)。此函数将新密码存储在密钥环中。如果启用了加密，它还会执行一个日志文件旋转操作，重命名当前日志文件，并开始一个新的使用密码加密的日志文件。文件重命名遵循自动基于大小的日志文件旋转的通常规则；请参阅[手动审计日志文件旋转（MySQL
    8.0.31之前）](audit-log-logging-configuration.html#audit-log-manual-rotation "手动审计日志文件旋转（MySQL
    8.0.31之前）")。
- en: If the [`audit_log_password_history_keep_days`](audit-log-reference.html#sysvar_audit_log_password_history_keep_days)
    system variable is nonzero, invoking [`audit_log_encryption_password_set()`](audit-log-reference.html#function_audit-log-encryption-password-set)
    also causes expiration of old archived audit log encryption passwords. For information
    about audit log password history, including password archiving and expiration,
    see the description of that variable.
  id: totrans-77
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果[`audit_log_password_history_keep_days`](audit-log-reference.html#sysvar_audit_log_password_history_keep_days)系统变量不为零，则调用[`audit_log_encryption_password_set()`](audit-log-reference.html#function_audit-log-encryption-password-set)也会导致旧的存档审计日志加密密码过期。有关审计日志密码历史的信息，包括密码存档和过期，请参阅该变量的描述。
- en: To get the current encryption password, invoke [`audit_log_encryption_password_get()`](audit-log-reference.html#function_audit-log-encryption-password-get)
    with no argument. To get a password by ID, pass an argument that specifies the
    keyring ID of the current password or an archived password.
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要获取当前的加密密码，请调用不带参数的[`audit_log_encryption_password_get()`](audit-log-reference.html#function_audit-log-encryption-password-get)。要通过ID获取密码，请传递一个指定当前密码或存档密码的密钥环ID的参数。
- en: 'To determine which audit log keyring IDs exist, query the Performance Schema
    [`keyring_keys`](performance-schema-keyring-keys-table.html "29.12.18.2 The keyring_keys
    table") table:'
  id: totrans-79
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要确定存在哪些审计日志密钥环ID，请查询性能模式[`keyring_keys`](performance-schema-keyring-keys-table.html
    "29.12.18.2 keyring_keys表")表：
- en: '[PRE6]'
  id: totrans-80
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: For additional information about audit log encryption functions, see [Audit
    Log Functions](audit-log-reference.html#audit-log-routines "Audit Log Functions").
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 有关审计日志加密函数的其他信息，请参阅[审计日志函数](audit-log-reference.html#audit-log-routines "审计日志函数")。
- en: When the audit log plugin initializes, if it finds that log file encryption
    is enabled, it checks whether the keyring contains an audit log encryption password.
    If not, the plugin automatically generates a random initial encryption password
    and stores it in the keyring. To discover this password, invoke [`audit_log_encryption_password_get()`](audit-log-reference.html#function_audit-log-encryption-password-get).
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 当审计日志插件初始化时，如果发现日志文件加密已启用，则会检查密钥环是否包含审计日志加密密码。如果没有，则插件会自动生成一个随机初始加密密码并将其存储在密钥环中。要查找此密码，请调用[`audit_log_encryption_password_get()`](audit-log-reference.html#function_audit-log-encryption-password-get)。
- en: If both compression and encryption are enabled, compression occurs before encryption.
    To recover the original file manually, first decrypt it, then uncompress it. See
    [Manually Uncompressing and Decrypting Audit Log Files](audit-log-logging-configuration.html#audit-log-file-uncompression-decryption
    "Manually Uncompressing and Decrypting Audit Log Files").
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 如果同时启用了压缩和加密，则压缩会在加密之前发生。要手动恢复原始文件，请先解密，然后解压缩。请参阅[手动解压缩和解密审计日志文件](audit-log-logging-configuration.html#audit-log-file-uncompression-decryption
    "手动解压缩和解密审计日志文件")。
- en: Manually Uncompressing and Decrypting Audit Log Files
  id: totrans-84
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 手动解压缩和解密审计日志文件
- en: Audit log files can be uncompressed and decrypted using standard tools. This
    should be done only for log files that have been closed (archived) and are no
    longer in use, not for the log file that the audit log plugin is currently writing.
    You can recognize archived log files because they have been renamed by the audit
    log plugin to include a timestamp in the file name just after the base name.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 审计日志文件可以使用标准工具进行解压缩和解密。这应该仅针对已关闭（已归档）且不再使用的日志文件进行，而不是当前审计日志插件正在写入的日志文件。您可以通过审计日志插件将时间戳添加到基本名称后的文件名中来识别已归档的日志文件。
- en: For this discussion, assume that [`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)
    is set to `audit.log`. In that case, an archived audit log file has one of the
    names shown in the following table.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 在本讨论中，假设[`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file)设置为`audit.log`。在这种情况下，已归档的审计日志文件具有以下表中显示的名称之一。
- en: '| Enabled Features | Archived File Name |'
  id: totrans-87
  prefs: []
  type: TYPE_TB
  zh: '| 启用功能 | 已归档文件名 |'
- en: '| No compression or encryption | `audit.*`timestamp`*.log` |'
  id: totrans-88
  prefs: []
  type: TYPE_TB
  zh: '| 无压缩或加密 | `audit.*`timestamp`*.log` |'
- en: '| Compression | `audit.*`timestamp`*.log.gz` |'
  id: totrans-89
  prefs: []
  type: TYPE_TB
  zh: '| 压缩 | `audit.*`timestamp`*.log.gz` |'
- en: '| Encryption | `audit.*`timestamp`*.log.*`pwd_id`*.enc` |'
  id: totrans-90
  prefs: []
  type: TYPE_TB
  zh: '| 加密 | `audit.*`timestamp`*.log.*`pwd_id`*.enc` |'
- en: '| Compression, encryption | `audit.*`timestamp`*.log.gz.*`pwd_id`*.enc` |'
  id: totrans-91
  prefs: []
  type: TYPE_TB
  zh: '| 压缩，加密 | `audit.*`timestamp`*.log.gz.*`pwd_id`*.enc` |'
- en: As discussed in [Naming Conventions for Audit Log Files](audit-log-logging-configuration.html#audit-log-file-name
    "Naming Conventions for Audit Log Files"), *`pwd_id`* format is *`pwd_timestamp-seq`*.
    Thus, the names of archived encrypted log files actually contain two timestamps.
    The first indicates file rotation time, and the second indicates when the encryption
    password was created.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 如[审计日志文件命名约定](audit-log-logging-configuration.html#audit-log-file-name "审计日志文件命名约定")所述，*`pwd_id`*格式为*`pwd_timestamp-seq`*。因此，已归档的加密日志文件的名称实际上包含两个时间戳。第一个时间戳表示文件旋转时间，第二个时间戳表示加密密码创建时间。
- en: 'Consider the following set of archived encrypted log file names:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑以下一组已归档的加密日志文件名称：
- en: '[PRE7]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Each file name has a unique rotation-time timestamp. By contrast, the password
    timestamps are not unique:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 每个文件名都有一个唯一的旋转时间戳。相比之下，密码时间戳不是唯一的：
- en: The first two files have the same password ID and sequence number (`20190403T185337-1`).
    They have the same encryption password.
  id: totrans-96
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 前两个文件具有相同的密码ID和序列号（`20190403T185337-1`）。它们具有相同的加密密码。
- en: The second two files have the same password ID (`20190414T223342`) but different
    sequence numbers (`1`, `2`). These files have different encryption passwords.
  id: totrans-97
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 后两个文件具有相同的密码ID（`20190414T223342`），但不同的序列号（`1`，`2`）。这些文件具有不同的加密密码。
- en: 'To uncompress a compressed log file manually, use **gunzip**, **gzip -d**,
    or equivalent command. For example:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 要手动解压缩压缩的日志文件，请使用**gunzip**，**gzip -d**或等效命令。例如：
- en: '[PRE8]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'To decrypt an encrypted log file manually, use the **openssl** command. For
    example:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 要手动解密加密的日志文件，请使用**openssl**命令。例如：
- en: '[PRE9]'
  id: totrans-101
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'To execute that command, you must obtain *`password`*, the encryption password.
    To do this, use [`audit_log_encryption_password_get()`](audit-log-reference.html#function_audit-log-encryption-password-get).
    For example, if the audit log file name is `audit.20190415T151322.log.20190414T223342-2.enc`,
    the password ID is `20190414T223342-2` and the keyring ID is `audit-log-20190414T223342-2`.
    Retrieve the keyring password like this:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 要执行该命令，你必须获取*`password`*，即加密密码。为此，请使用[`audit_log_encryption_password_get()`](audit-log-reference.html#function_audit-log-encryption-password-get)。例如，如果审计日志文件名为`audit.20190415T151322.log.20190414T223342-2.enc`，密码
    ID 为`20190414T223342-2`，密钥环 ID 为`audit-log-20190414T223342-2`。像这样检索密钥环密码：
- en: '[PRE10]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'If both compression and encryption are enabled for audit logging, compression
    occurs before encryption. In this case, the file name has `.gz` and `.*`pwd_id`*.enc`
    suffixes added, corresponding to the order in which those operations occur. To
    recover the original file manually, perform the operations in reverse. That is,
    first decrypt the file, then uncompress it:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 如果审计日志既启用了压缩又启用了加密，压缩会在加密之前发生。在这种情况下，文件名会添加`.gz`和`.*`pwd_id`*.enc`后缀，对应这些操作发生的顺序。要手动恢复原始文件，请按相反顺��执行操作。也就是说，首先解密文件，然后解压缩：
- en: '[PRE11]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Audit Log File Encryption Prior to MySQL 8.0.17
  id: totrans-106
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: MySQL 8.0.17 之前的审计日志文件加密
- en: This section covers the differences in audit log file encryption capabilities
    prior to and as of MySQL 8.0.17, which is when password history was implemented
    (which includes password archiving and expiration). It also indicates how the
    audit log plugin handles upgrades to MySQL 8.0.17 or higher from versions lower
    than 8.0.17.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 本节介绍了 MySQL 8.0.17 之前和之后审计日志文件加密功能的差异，这是在实现密码历史记录（包括密码归档和过期）时的情况。还指出了审计日志插件如何处理从低于
    8.0.17 版本升级到 MySQL 8.0.17 或更高版本的情况。
- en: '| Feature | Prior to MySQL 8.0.17 | As of MySQL 8.0.17 |'
  id: totrans-108
  prefs: []
  type: TYPE_TB
  zh: '| 功能 | 在 MySQL 8.0.17 之前 | 截至 MySQL 8.0.17 |'
- en: '| Number of passwords | Single password only | Multiple passwords permitted
    |'
  id: totrans-109
  prefs: []
  type: TYPE_TB
  zh: '| 密码数量 | 仅单个密码 | 允许多个密码 |'
- en: '| Encrypted log file names | `.enc` suffix | `.*`pwd_id`*.enc` suffix |'
  id: totrans-110
  prefs: []
  type: TYPE_TB
  zh: '| 加密日志文件名称 | `.enc` 后缀 | `.*`pwd_id`*.enc` 后缀 |'
- en: '| Password keyring ID | `audit_log` | `audit_log-*`pwd_id`*` |'
  id: totrans-111
  prefs: []
  type: TYPE_TB
  zh: '| 密码密钥环 ID | `audit_log` | `audit_log-*`pwd_id`*` |'
- en: '| Password history | No | Yes |'
  id: totrans-112
  prefs: []
  type: TYPE_TB
  zh: '| 密码历史记录 | 否 | 是 |'
- en: Prior to MySQL 8.0.17, there is no password history, so setting a new password
    makes the old password inaccessible, rendering MySQL Enterprise Audit unable to
    read log files encrypted with the old password. Should you anticipate a need to
    decrypt those files manually, you must maintain a record of previous passwords.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 在 MySQL 8.0.17 之前，没有密码历史记录，因此设置新密码会使旧密码无法访问，导致 MySQL 企业审计无法读取用旧密码加密的日志文件。如果你预期需要手动解密这些文件，你必须保留以前的密码记录。
- en: 'If audit log file encryption is enabled when you upgrade to MySQL 8.0.17 or
    higher from a lower version, the audit log plugin performs these upgrade actions:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在从低版本升级到 MySQL 8.0.17 或更高版本时启用了审计日志文件加密，则审计日志插件执行以下升级操作：
- en: During plugin initialization, the plugin checks for an encryption password with
    a keyring ID of `audit_log`. If it finds one, the plugin duplicates the password
    using a keyring ID in `audit_log-*`pwd_id`*` format and uses it as the current
    encryption password. (For details about *`pwd_id`* syntax, see [Naming Conventions
    for Audit Log Files](audit-log-logging-configuration.html#audit-log-file-name
    "Naming Conventions for Audit Log Files").)
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在插件初始化期间，插件会检查具有`audit_log`密钥环 ID的加密密码。如果找到一个，插件会使用`audit_log-*`pwd_id`*`格式中的密钥环
    ID 复制密码，并将其用作当前的加密密码。（有关*`pwd_id`*语法的详细信息，请参阅[审计日志文件命名约定](audit-log-logging-configuration.html#audit-log-file-name
    "审计日志文件命名约定").）
- en: Existing encrypted log files have a suffix of `.enc`. The plugin does not rename
    these to have a suffix of `.*`pwd_id`*.enc`, but can read them as long as the
    key with the ID of `audit_log` remains in the keyring.
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 现有加密的日志文件具有后缀`.enc`。插件不会将这些重命名为后缀为`.*`pwd_id`*.enc`，但只要具有`audit_log` ID的密钥保留在密钥环中，就可以读取它们。
- en: When password cleanup occurs, if the plugin expires any password with a keyring
    ID in `audit_log-*`pwd_id`*` format, it also expires the password with a keyring
    ID of `audit_log`, if it exists. (At this point, encrypted log files that have
    a suffix of `.enc` rather than `.*`pwd_id`*.enc` become unreadable by the plugin,
    so it is assumed that you no longer need them.)
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当密码清理发生时，如果插件过期任何具有`audit_log-*`pwd_id`*`格式的密钥环 ID 的密码，它也会过期具有`audit_log`密钥环
    ID 的密码（如果存在）。此时，具有后缀`.enc`而不是`.*`pwd_id`*.enc`的加密日志文件变得无法被插件读取，因此可以假定你不再需要它们。
- en: Space Management of Audit Log Files
  id: totrans-118
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 审计日志文件的空间管理
- en: The audit log file has the potential to grow quite large and consume a great
    deal of disk space. If you are collecting the optional query time and size statistics,
    which are available from MySQL 8.0.30, this increases the space requirements.
    The query statistics are only supported with JSON format.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 审计日志文件有可能变得非常庞大，占用大量磁盘空间。如果您正在收集自MySQL 8.0.30起可用的可选查询时间和大小统计信息，则会增加空间要求。查询统计仅支持JSON格式。
- en: 'To manage the space used, employ these methods:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 为管理使用的空间，采用以下方法：
- en: Log file rotation. This involves rotating the current log file by renaming it,
    then opening a new current log file using the original name. Rotation can be performed
    manually, or configured to occur automatically.
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 日志文件轮换。这涉及通过重命名当前日志文件来轮换它，然后使用原始名称打开一个新的当前日志文件。轮换可以手动执行，也可以配置为自动执行。
- en: Pruning of rotated JSON-format log files, if automatic rotation is enabled.
    Pruning can be performed based on log file age (as of MySQL 8.0.24), or combined
    log file size (as of MySQL 8.0.26).
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果启用了自动轮换，则对已轮换的JSON格式日志文件进行修剪。修剪可以基于日志文件的年龄（自MySQL 8.0.24起），或组合日志文件大小（自MySQL
    8.0.26起）进行。
- en: 'To configure audit log file space management, use the following system variables:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 要配置审计日志文件空间管理，请使用以下系统变量：
- en: If [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    is 0 (the default), automatic log file rotation is disabled.
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)为0（默认值），则禁用自动日志文件轮换。
- en: No rotation occurs unless performed manually.
  id: totrans-125
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 除非手动执行，否则不会发生轮换。
- en: 'To rotate the current file, use one of the following methods:'
  id: totrans-126
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 要轮换当前文件，请使用以下方法之一：
- en: Before MySQL 8.0.31, manually rename the file, then enable [`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)
    to close it and open a new current log file using the original name. This file
    rotation method and the [`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)
    variable are deprecated in MySQL 8.0.31.
  id: totrans-127
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在MySQL 8.0.31之前，手动重命名文件，然后启用[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)来关闭它，并使用原始名称打开一个新的当前日志文件。此文件轮换方法和[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)变量在MySQL
    8.0.31中已弃用。
- en: With this file rotation method, pruning of rotated JSON-format log files does
    not occur; [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    and [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)
    have no effect.
  id: totrans-128
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_IND
  type: TYPE_NORMAL
  zh: 使用此文件轮换方法，不会发生对已轮换的JSON格式日志文件进行修剪；[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)和[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)不起作用。
- en: From MySQL 8.0.31, run `SELECT audit_log_rotate();` to rename the file and open
    a new audit log file using the original name.
  id: totrans-129
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从MySQL 8.0.31开始，运行`SELECT audit_log_rotate();`来重命名文件，并使用原始名称打开一个新的审计日志文件。
- en: With this file rotation method, pruning of rotated JSON-format log files occurs
    if [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    or [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)
    has a value greater than 0.
  id: totrans-130
  prefs:
  - PREF_IND
  - PREF_IND
  - PREF_IND
  type: TYPE_NORMAL
  zh: 使用此文件轮换方法，如果[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)或[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)的值大于0，则会对已轮换的JSON格式日志文件进行修剪。
- en: See [Manual Audit Log File Rotation (Before MySQL 8.0.31)](audit-log-logging-configuration.html#audit-log-manual-rotation
    "Manual Audit Log File Rotation (Before MySQL 8.0.31)").
  id: totrans-131
  prefs:
  - PREF_IND
  - PREF_IND
  type: TYPE_NORMAL
  zh: 参见[手动审计日志文件轮换（MySQL 8.0.31之前）](audit-log-logging-configuration.html#audit-log-manual-rotation
    "手动审计日志文件轮换（MySQL 8.0.31之前）")。
- en: 'If [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    is greater than 0, automatic audit log file rotation is enabled:'
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)大于0，则启用自动审计日志文件轮换：
- en: Automatic rotation occurs when a write to the current log file causes its size
    to exceed the [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    value, as well as under certain other conditions; see [Automatic Audit Log File
    Rotation](audit-log-logging-configuration.html#audit-log-automatic-rotation "Automatic
    Audit Log File Rotation"). When automatic rotation occurs, the audit log plugin
    renames the current log file and opens a new current log file using the original
    name.
  id: totrans-133
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当对当前日志文件进行写入导致其大小超过[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)值时，以及在某些其他条件下，会自动进行轮换；参见[自动审计日志文件轮换](audit-log-logging-configuration.html#audit-log-automatic-rotation
    "自动审计日志文件轮换")。当自动轮换发生时，审计日志插件会重命名当前日志文件，并使用原始名称打开一个新的当前日志文件。
- en: Pruning of rotated JSON-format log files occurs if [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    or [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)
    has a value greater than 0.
  id: totrans-134
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)或[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)的值大于
    0，则会对旋转的 JSON 格式日志文件进行修剪。
- en: '[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush) has no
    effect.'
  id: totrans-135
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)没有效果。'
- en: Note
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: For JSON-format log files, rotation also occurs when the value of the [`audit_log_format_unix_timestamp`](audit-log-reference.html#sysvar_audit_log_format_unix_timestamp)
    system variable is changed at runtime. However, this does not occur for space-management
    purposes, but rather so that, for a given JSON-format log file, all records in
    the file either do or do not include the `time` field.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 JSON 格式的日志文件，在运行时更改[`audit_log_format_unix_timestamp`](audit-log-reference.html#sysvar_audit_log_format_unix_timestamp)系统变量的值时也会发生旋转。然而，这并不是为了空间管理目的，而是为了使给定的
    JSON 格式日志文件中的所有记录要么包含`time`字段，要么不包含。
- en: Note
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'Rotated (renamed) log files are not removed automatically. For example, with
    size-based log file rotation, renamed log files have unique names and accumulate
    indefinitely. They do not rotate off the end of the name sequence. To avoid excessive
    use of space:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 旋转（重命名）的日志文件不会自动删除。例如，基于大小的日志文件旋转，重命名的日志文件具有唯一名称并且会无限累积。它们不会在名称序列的末尾旋转。为避免过度使用空间：
- en: 'As of MySQL 8.0.24 (for JSON-format log files): Enable log file pruning as
    described in [Audit Log File Pruning](audit-log-logging-configuration.html#audit-log-pruning
    "Audit Log File Pruning").'
  id: totrans-140
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从 MySQL 8.0.24 开始（针对 JSON 格式日志文件）：按照[审计日志文件修剪](audit-log-logging-configuration.html#audit-log-pruning
    "审计日志文件修剪")中描述的方式启用日志文件修剪。
- en: 'Otherwise (for non-JSON files, or prior to MySQL 8.0.24 for all log formats):
    Remove old files periodically, backing them up first as necessary. If backed-up
    log files are encrypted, also back up the corresponding encryption passwords to
    a safe place, should you need to decrypt the files later.'
  id: totrans-141
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 否则（对于非 JSON 文件，或者在 MySQL 8.0.24 之前的所有日志格式）：定期删除旧文件，必要时首先备份它们。如果备份的日志文件已加密，还需将相应的加密密码备份到安全位置，以便以后解密文件时使用。
- en: The following sections describe log file rotation and pruning in greater detail.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 以下部分详细描述了日志文件旋转和修剪。
- en: '[Manual Audit Log File Rotation (Before MySQL 8.0.31)](audit-log-logging-configuration.html#audit-log-manual-rotation
    "Manual Audit Log File Rotation (Before MySQL 8.0.31)")'
  id: totrans-143
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[手动审计日志文件旋转（MySQL 8.0.31 之前）](audit-log-logging-configuration.html#audit-log-manual-rotation
    "手动审计日志文件旋转（MySQL 8.0.31 之前）")'
- en: '[Manual Audit Log File Rotation (From MySQL 8.0.31)](audit-log-logging-configuration.html#audit-log-manual-rotation-31
    "Manual Audit Log File Rotation (From MySQL 8.0.31)")'
  id: totrans-144
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[手动审计日志文件旋转（从 MySQL 8.0.31 开始）](audit-log-logging-configuration.html#audit-log-manual-rotation-31
    "手动审计日志文件旋转（从 MySQL 8.0.31 开始）")'
- en: '[Automatic Audit Log File Rotation](audit-log-logging-configuration.html#audit-log-automatic-rotation
    "Automatic Audit Log File Rotation")'
  id: totrans-145
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[自动审计日志文件旋转](audit-log-logging-configuration.html#audit-log-automatic-rotation
    "自动审计日志文件旋转")'
- en: '[Audit Log File Pruning](audit-log-logging-configuration.html#audit-log-pruning
    "Audit Log File Pruning")'
  id: totrans-146
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[审计日志文件修剪](audit-log-logging-configuration.html#audit-log-pruning "审计日志文件修剪")'
- en: Manual Audit Log File Rotation (Before MySQL 8.0.31)
  id: totrans-147
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 手动审计日志文件旋转（MySQL 8.0.31 之前）
- en: Note
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: From MySQL 8.0.31, the [`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)
    variable and this method of audit log file rotation are deprecated; expect support
    to be removed in a future version of MySQL.
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 从 MySQL 8.0.31 开始，[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)变量和这种审计日志文件旋转方法已被弃用；预计在未来的
    MySQL 版本中将不再支持。
- en: 'If [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    is 0 (the default), no log rotation occurs unless performed manually. In this
    case, the audit log plugin closes and reopens the log file when the [`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)
    value changes from disabled to enabled. Log file renaming must be done externally
    to the server. Suppose that the log file name is `audit.log` and you want to maintain
    the three most recent log files, cycling through the names `audit.log.1` through
    `audit.log.3`. On Unix, perform rotation manually like this:'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 如果[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)为0（默认值），除非手动执行，否则不会发生日志轮换。在这种情况下，当[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)值从禁用更改为启用时，审计日志插件会关闭并重新打开日志文件。日志文件重命名必须在服务器外部完成。假设日志文件名为`audit.log`，并且您希望保留最近的三个日志文件，循环使用名称`audit.log.1`到`audit.log.3`。在Unix上，执行以下手动旋转：
- en: 'From the command line, rename the current log files:'
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从命令行，重命名当前的日志文件：
- en: '[PRE12]'
  id: totrans-152
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: This strategy overwrites the current `audit.log.3` contents, placing a bound
    on the number of archived log files and the space they use.
  id: totrans-153
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 此策略会覆盖当前的`audit.log.3`内容，限制已归档的日志文件的数量和它们使用的空间。
- en: 'At this point, the plugin is still writing to the current log file, which has
    been renamed to `audit.log.1`. Connect to the server and flush the log file so
    the plugin closes it and reopens a new `audit.log` file:'
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 此时，插件仍在写入当前的日志文件，该文件已重命名为`audit.log.1`。连接到服务器并刷新日志文件，以便插件关闭它并重新打开一个新的`audit.log`文件：
- en: '[PRE13]'
  id: totrans-155
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: '[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush) is special
    in that its value remains `OFF` so that you need not disable it explicitly before
    enabling it again to perform another flush.'
  id: totrans-156
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)是特殊的，其值保持为`OFF`，因此您无需在再次启用它以执行另一个刷新之前显式禁用它。'
- en: Note
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: If compression or encryption are enabled, log file names include suffixes that
    signify the enabled features, as well as a password ID if encryption is enabled.
    If file names include a password ID, be sure to retain the ID in the name of any
    files you rename manually so that the password to use for decryption operations
    can be determined.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 如果启用了压缩或加密功能，则日志文件名包括表示已启用功能的后缀，以及如果启用了加密则包括密码ID。如果文件名包括密码ID，请确保在手动重命名任何文件时保留ID，以便确定用于解密操作的密码。
- en: Note
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: For JSON-format logging, renaming audit log files manually makes them unavailable
    to the log-reading functions because the audit log plugin can no longer determine
    that they are part of the log file sequence (see [Section 8.4.5.6, “Reading Audit
    Log Files”](audit-log-file-reading.html "8.4.5.6 Reading Audit Log Files")). Consider
    setting [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    greater than 0 to use size-based rotation instead.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 对于JSON格式日志记录，手动重命名审计日志文件会使它们对于日志读取功能不可用，因为审计日志插件无法再确定它们是日志文件序列的一部分（参见[第8.4.5.6节，“读取审计日志文件”](audit-log-file-reading.html
    "8.4.5.6 读取审计日志文件")）。考虑设置[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)大于0以使用基于大小的轮换。
- en: Manual Audit Log File Rotation (From MySQL 8.0.31)
  id: totrans-161
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 手动审计日志文件旋转（从MySQL 8.0.31开始）
- en: If [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    is 0 (the default), no log rotation occurs unless performed manually.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 如果[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)为0（默认值），除非手动执行，否则不会发生日志轮换。
- en: To rotate the audit log file manually, run `SELECT audit_log_rotate();` to rename
    the current audit log file and open a new audit log file. Files are renamed according
    to the conventions described in [Naming Conventions for Audit Log Files](audit-log-logging-configuration.html#audit-log-file-name
    "Naming Conventions for Audit Log Files").
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 要手动旋转审计日志文件，请运行`SELECT audit_log_rotate();`以重命名当前的审计日志文件并打开一个新的审计日志文件。文件将根据[审计日志文件命名约定](audit-log-logging-configuration.html#audit-log-file-name
    "审计日志文件命名约定")中描述的约定进行重命名。
- en: The `AUDIT_ADMIN` privilege is required to use the [`audit_log_rotate()`](audit-log-reference.html#function_audit-log-rotate)
    function.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 使用[`audit_log_rotate()`](audit-log-reference.html#function_audit-log-rotate)函数需要`AUDIT_ADMIN`特权。
- en: Managing the number of archived log files (the files that have been renamed)
    and the space they use is a manual task that involves removing archived audit
    log files that are no longer needed from your file system.
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 管理已归档的日志文件（已重命名的文件）的数量和它们使用的空间是一个手动任务，涉及从文件系统中删除不再需要的已归档审计日志文件。
- en: The content of audit log files that are renamed using the `audit_log_rotate()`
    function can be read by [`audit_log_read()`](audit-log-reference.html#function_audit-log-read)
    function.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`audit_log_rotate()`函数重命名的审计日志文件的内容可以通过[`audit_log_read()`](audit-log-reference.html#function_audit-log-read)函数读取。
- en: Automatic Audit Log File Rotation
  id: totrans-167
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 自动审计日志文件旋转
- en: If [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    is greater than 0, setting [`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)
    has no effect. Instead, whenever a write to the current log file causes its size
    to exceed the [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    value, the audit log plugin automatically renames the current log file and opens
    a new current log file using the original name.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 如果[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)大于0，则设置[`audit_log_flush`](audit-log-reference.html#sysvar_audit_log_flush)无效。相反，每当对当前日志文件的写入导致其大小超过[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)值时，审计日志插件会自动重命名当前日志文件，并使用原始名称打开一个新的当前日志文件。
- en: 'Automatic size-based rotation also occurs under these conditions:'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下情况下也会自动基于大小进行旋转：
- en: During plugin initialization, if a file with the audit log file name already
    exists (see [Naming Conventions for Audit Log Files](audit-log-logging-configuration.html#audit-log-file-name
    "Naming Conventions for Audit Log Files")).
  id: totrans-170
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在插件初始化期间，如果具有审计日志文件名的文件已经存在（参见[审计日志文件命名约定](audit-log-logging-configuration.html#audit-log-file-name
    "审计日志文件命名约定")）。
- en: During plugin termination.
  id: totrans-171
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在插件终止期间。
- en: When the [`audit_log_encryption_password_set()`](audit-log-reference.html#function_audit-log-encryption-password-set)
    function is called to set the encryption password, if encryption is enabled. (Rotation
    does not occur if encryption is disabled.)
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当调用[`audit_log_encryption_password_set()`](audit-log-reference.html#function_audit-log-encryption-password-set)函数设置加密密码时，如果启用了加密。（如果禁用加密，则不会发生旋转。）
- en: The plugin renames the original file by inserting a timestamp just after its
    base name. For example, if the file name is `audit.log`, the plugin renames it
    to a value such as `audit.20210115T140633.log`. The timestamp is a UTC value in
    `*`YYYYMMDD`*T*`hhmmss`*` format. For XML logging, the timestamp indicates rotation
    time. For JSON logging, the timestamp is that of the last event written to the
    file.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 插件通过在基本名称后插入时间戳来重命名原始文件。例如，如果文件名为`audit.log`，插件将将其重命名为类似`audit.20210115T140633.log`的值。时间戳是`*`YYYYMMDD`*T*`hhmmss`*`格式的UTC值。对于XML日志记录，时间戳表示旋转时间。对于JSON日志记录，时间戳是写入文件的最后一个事件的时间。
- en: If log files are encrypted, the original file name already contains a timestamp
    indicating the encryption password creation time (see [Naming Conventions for
    Audit Log Files](audit-log-logging-configuration.html#audit-log-file-name "Naming
    Conventions for Audit Log Files")). In this case, the file name after rotation
    contains two timestamps. For example, an encrypted log file named `audit.log.20210110T130749-1.enc`
    is renamed to a value such as `audit.20210115T140633.log.20210110T130749-1.enc`.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 如果日志文件已加密，则原始文件名已包含指示加密密码创建时间的时间戳（请参见[审计日志文件命名约定](audit-log-logging-configuration.html#audit-log-file-name
    "审计日志文件命名约定")）。在这种情况下，旋转后的文件名包含两个时间戳。例如，名为`audit.log.20210110T130749-1.enc`的加密日志文件将重命名为类似`audit.20210115T140633.log.20210110T130749-1.enc`的值。
- en: Audit Log File Pruning
  id: totrans-175
  prefs:
  - PREF_H6
  type: TYPE_NORMAL
  zh: 审计日志文件修剪
- en: 'The audit log plugin supports pruning of rotated JSON-format audit log files,
    if automatic log file rotation is enabled. To use this capability:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 如果启用了自动日志文件旋转，则审计日志插件支持对旋转的JSON格式审计日志文件进行修剪。要使用此功能：
- en: Set `audit_log_format` to `JSON`. (In addition, consider also changing [`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file);
    see [Selecting Audit Log File Format](audit-log-logging-configuration.html#audit-log-file-format
    "Selecting Audit Log File Format").)
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将`audit_log_format`设置为`JSON`。（此外，还考虑更改[`audit_log_file`](audit-log-reference.html#sysvar_audit_log_file);请参见[选择审计日志文件格式](audit-log-logging-configuration.html#audit-log-file-format
    "选择审计日志文件格式")。）
- en: Set [`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)
    greater than 0 to specify the size in bytes at which automatic log file rotation
    occurs.
  id: totrans-178
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将[`audit_log_rotate_on_size`](audit-log-reference.html#sysvar_audit_log_rotate_on_size)设置为大于0，以指定自动日志文件旋转发生的字节大小。
- en: 'By default, no pruning of automatically rotated JSON-format log files occurs.
    To enable pruning, set one of these system variables to a value greater than 0:'
  id: totrans-179
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 默认情况下，不会对自动旋转的JSON格式日志文件进行修剪。要启用修剪，请将以下系统变量之一设置为大于0的值：
- en: Set [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    greater than 0 to specify the limit in bytes on the combined size of rotated log
    files above which the files become subject to pruning. [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    is available as of MySQL 8.0.26.
  id: totrans-180
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)设置为大于
    0，以指定旋转日志文件的组合大小上限，超过该大小的文件将被修剪。[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)自
    MySQL 8.0.26 版本起可用。
- en: Set [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)
    greater than 0 to specify the number of seconds after which rotated log files
    become subject to pruning. [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)
    is available as of MySQL 8.0.24.
  id: totrans-181
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)设置为大于
    0，以指定旋转日志文件在多少秒后将被修剪。[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)自
    MySQL 8.0.24 版本起可用。
- en: Nonzero values of [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    take precedence over nonzero values of [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds).
    If both are set greater than 0 at plugin initialization, a warning is written
    to the server error log. If a client sets both greater than 0 at runtime, a warning
    is returned to the client.
  id: totrans-182
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 非零值的[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)优先于非零值的[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)。如果两者在插件初始化时都设置为大于
    0，则会向服务器错误日志写入警告。如果客户端在运行时都设置为大于 0，则会向客户端返回警告。
- en: Note
  id: totrans-183
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: Warnings to the error log are written as Notes, which are information messages.
    To ensure that such messages appear in the error log and are not discarded, make
    sure that error-logging verbosity is sufficient to include information messages.
    For example, if you are using priority-based log filtering, as described in [Section 7.4.2.5,
    “Priority-Based Error Log Filtering (log_filter_internal)”](error-log-priority-based-filtering.html
    "7.4.2.5 Priority-Based Error Log Filtering (log_filter_internal)"), set the [`log_error_verbosity`](server-system-variables.html#sysvar_log_error_verbosity)
    system variable to a value of 3.
  id: totrans-184
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 写入错误日志的警告被写入为注释，这些是信息消息。为确保这些消息出现在错误日志中并且不被丢弃，请确保错误日志的详细程度足以包含信息消息。例如，如果您正在使用基于优先级的日志过滤，如[第
    7.4.2.5 节，“基于优先级的错误日志过滤（log_filter_internal）”](error-log-priority-based-filtering.html
    "7.4.2.5 基于优先级的错误日志过滤（log_filter_internal）")中所述，将[`log_error_verbosity`](server-system-variables.html#sysvar_log_error_verbosity)系统变量设置为
    3。
- en: 'Pruning of JSON-format log files, if enabled, occurs as follows:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 如果启用了 JSON 格式日志文件的修剪，则会按以下方式进行：
- en: When automatic rotation takes place; for the conditions under which this happens,
    see [Automatic Audit Log File Rotation](audit-log-logging-configuration.html#audit-log-automatic-rotation
    "Automatic Audit Log File Rotation").
  id: totrans-186
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当自动旋转发生时；有关发生此情况的条件，请参阅[自动审计日志文件旋转](audit-log-logging-configuration.html#audit-log-automatic-rotation
    "自动审计日志文件旋转")。
- en: When the global [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)
    or [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)
    system variable is set at runtime.
  id: totrans-187
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当全局[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)或[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)系统变量���运行时设置时。
- en: For pruning based on combined rotated log file size, if the combined size is
    greater than the limit specified by [`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size),
    the audit log plugin removes the oldest files until their combined size does not
    exceed the limit.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 对于基于组合旋转日志文件大小进行修剪，如果组合大小大于[`audit_log_max_size`](audit-log-reference.html#sysvar_audit_log_max_size)指定的限制，则审计日志插件将删除最旧的文件，直到它们的组合大小不超过限制。
- en: For pruning based on rotated log file age, the pruning point is the current
    time minus the value of [`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds).
    In rotated JSON-format log files, the timestamp part of each file name indicates
    the timestamp of the last event written to the file. The audit log plugin uses
    file name timestamps to determine which files contain only events older than the
    pruning point, and removes them.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 对于基于旋转日志文件年龄进行修剪，修剪点是当前时间减去[`audit_log_prune_seconds`](audit-log-reference.html#sysvar_audit_log_prune_seconds)的值。在旋转的
    JSON 格式日志文件中，每个文件名的时间戳部分表示写入文件的最后一个事件的时间戳。审计日志插件使用文件名时间戳来确定哪些文件仅包含早于修剪点的事件，并将其删除。
- en: Write Strategies for Audit Logging
  id: totrans-190
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: 撰写审计日志策略
- en: The audit log plugin can use any of several strategies for log writes. Regardless
    of strategy, logging occurs on a best-effort basis, with no guarantee of consistency.
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 审计日志插件可以使用多种策略进行日志写入。无论采用哪种策略，记录都是尽力而为的，没有一致性的保证。
- en: To specify a write strategy, set the [`audit_log_strategy`](audit-log-reference.html#sysvar_audit_log_strategy)
    system variable at server startup. By default, the strategy value is `ASYNCHRONOUS`
    and the plugin logs asynchronously to a buffer, waiting if the buffer is full.
    It's possible to tell the plugin not to wait (`PERFORMANCE`) or to log synchronously,
    either using file system caching (`SEMISYNCHRONOUS`) or forcing output with a
    `sync()` call after each write request (`SYNCHRONOUS`).
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 要指定写入策略，请在服务器启动时设置 [`audit_log_strategy`](audit-log-reference.html#sysvar_audit_log_strategy)
    系统变量。默认情况下，策略值为 `ASYNCHRONOUS`，插件会异步记录到缓冲区，如果缓冲区已满则等待。可以告诉插件不要等待 (`PERFORMANCE`)
    或使用文件系统缓存同步记录 (`SEMISYNCHRONOUS`)，或者在每次写入请求后强制输出使用 `sync()` 调用 (`SYNCHRONOUS`)。
- en: For asynchronous write strategy, the [`audit_log_buffer_size`](audit-log-reference.html#sysvar_audit_log_buffer_size)
    system variable is the buffer size in bytes. Set this variable at server startup
    to change the buffer size. The plugin uses a single buffer, which it allocates
    when it initializes and removes when it terminates. The plugin does not allocate
    this buffer for nonasynchronous write strategies.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 对于异步写入策略，[`audit_log_buffer_size`](audit-log-reference.html#sysvar_audit_log_buffer_size)
    系统变量是以字节为单位的缓冲区大小。在服务器启动时设置此变量以更改缓冲区大小。插件使用一个单一的缓冲区，在初始化时分配并在终止时移除。插件不会为非异步写入策略分配此缓冲区。
- en: 'Asynchronous logging strategy has these characteristics:'
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 异步记录策略具有以下特点：
- en: Minimal impact on server performance and scalability.
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对服务器性能和可扩展性的影响最小。
- en: Blocking of threads that generate audit events for the shortest possible time;
    that is, time to allocate the buffer plus time to copy the event to the buffer.
  id: totrans-196
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 阻塞生成审计事件的线程的时间尽可能短；即分配缓冲区的时间加上将事件复制到缓冲区的时间。
- en: Output goes to the buffer. A separate thread handles writes from the buffer
    to the log file.
  id: totrans-197
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 输出到缓冲区。一个单独的线程处理从缓冲区到日志文件的写入。
- en: With asynchronous logging, the integrity of the log file may be compromised
    if a problem occurs during a write to the file or if the plugin does not shut
    down cleanly (for example, in the event that the server host exits unexpectedly).
    To reduce this risk, set [`audit_log_strategy`](audit-log-reference.html#sysvar_audit_log_strategy)
    to use synchronous logging.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 使用异步记录时，如果在写入文件时出现问题或插件未能干净地关闭（例如，在服务器主机意外退出的情况下），日志文件的完整性可能会受到影响。为了降低这种风险，请将
    [`audit_log_strategy`](audit-log-reference.html#sysvar_audit_log_strategy) 设置为使用同步记录。
- en: A disadvantage of `PERFORMANCE` strategy is that it drops events when the buffer
    is full. For a heavily loaded server, the audit log may have events missing.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: '`PERFORMANCE` 策略的一个缺点是当缓冲区已满时会丢弃事件。对于负载较重的服务器，审计日志可能会丢失事件。'
